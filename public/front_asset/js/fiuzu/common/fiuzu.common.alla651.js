"use strict";var ENTER_KEY=13;var ESC_KEY=27;if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}if(!Number.prototype.formatMoney){Number.prototype.formatMoney=function(k,g,e){var h=this,k=isNaN(k=Math.abs(k))?2:k,g=g==undefined?".":g,e=e==undefined?",":e,f=h<0?"-":"",b=parseInt(h=Math.abs(+h||0).toFixed(k))+"",a=(a=b.length)>3?a%3:0;return f+(a?b.substr(0,a)+e:"")+b.substr(a).replace(/(\d{3})(?=\d)/g,"$1"+e)+(k?g+Math.abs(h-b).toFixed(k).slice(2):"")}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){var a=this.length>>>0;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0){c+=a}for(;c<a;c++){if(c in this&&this[c]===b){return c}}return-1}}Date.now=Date.now||function(){return+new Date};window.gettext=window.gettext||function(a){return a};window.ngettext=window.ngettext||function(a,b,c){return a};if(window.location.href.indexOf("localhost")>=0){window.onerror=function(b,a,j,d,h){var e=!d?"":"\n - Column: "+d;e+=!h?"":"\n - Error: "+h;var i="Error: "+b+"\n - URL: "+window.location.href+"\n - File: "+a+"\n - Line: "+j+e,c=window.location.href.indexOf("/planner")>0,g=b.indexOf("Script error")>=0;if(c&&!g){alert("<h3>Sorry, I got flu !</h3>An unexpected error has been occured, please stop posting to save what you have posted and refresh the page.<br/> This error has just been reported to us, we are going to fix it soon. <br/>Sorry for the inconvienience!")}if(window.fiuzu&&!g){var h=new fiuzu.common.models.ReportError({category:3,state:0,is_ack:false,is_delegated:false,is_important:c,content:i});h.save({},{success:function(k,l){window.console&&console.log("Issue #"+k.get("id")+" has been reported.")}})}var f=true;return f}}window.fiuzu={pages:{},common:{},main:{},map:{},wishlist:{},ui:{},analytic:{track:function(a){if(window.ga){ga("send",{hitType:"event",eventCategory:a[0],eventAction:a[1],eventLabel:a[2],eventValue:a[3]||null})}}},WINDOW_SIZE_XS:1,WINDOW_SIZE_SM:2,WINDOW_SIZE_MD:3,WINDOW_SIZE_LG:4,GOOGLE_APIKEY:"AIzaSyAj2DzAduFWCZLmOUkd3Jzqg3rtnDy27yE",constants:{AVATAR_DEFAULT:"/static/images/avatar-default.png",PHOTO_DEFAULT:"/static/images/photo-default.jpg"},currency:"USD",isRunningApp:function(){return(this.app&&this.app.module)},checkChatOffline:function(){if(fiuzu.zopim&&fiuzu.zopim.status!="online"&&!fiuzu.isMissNotified){$.ajax({url:"/api/contact/miss"});fiuzu.isMissNotified=true}},contact:function(){if($zopim){$zopim.livechat.window.show();fiuzu.checkChatOffline()}else{location.href="/contact"}},confirm:function(c){var b=this;if(!this.confirmTemplate){var a=$("#tpl-confirm");this.$confirm=$("#fiuzu-confirm");c.classes&&b.$confirm.addClass(c.classes);this.confirmTemplate=_.template(a.html(),null,{variable:"data"})}c.buttons=c.buttons||{};this.$confirm.modal("hide");this.$confirm.find(".modal-content").html(this.confirmTemplate(c));this.$confirm.find(".modal-footer .btn").click(function(f){var d=$(this).attr("data-id");if(d&&c.buttons){_.each(c.buttons,function(g,e){if(g&&g.id==d){if(g.callback){g.callback(g,b.$confirm,f)}if(g.close){b.$confirm.modal("hide")}}})}});fiuzu.utils.refreshTooltip(this.$confirm);this.$confirm.css({zIndex:10000}).modal({backdrop:"static"}).on("hide.bs.modal",function(){c.cancel&&c.cancel();c.classes&&b.$confirm.removeClass(c.classes)})},addDeferedScripts:function(a,b){$(function(){var d=0,c=false;if(a&&a.length>0){for(var e=0;e<a.length;e++){var f=document.createElement("script");f.src=a[e];f.onload=f.onreadystatechange=function(){if(!c&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){d++;if(d==a.length){c=true;b&&b()}f.onload=f.onreadystatechange=null}};document.body.appendChild(f)}}});return true},loadScript:function(c,b){var a=this;this._loadedScripts=this._loadedScripts||[];if($("script[src='"+c+"']")[0]||this._loadedScripts.indexOf(c)>=0){b&&b()}else{$.getScript(c).done(function(e,d){b&&b();a._loadedScripts.push(c)}).fail(function(e,f,d){b&&b();a._loadedScripts.push(c)})}},loadStyle:function(b,a){if(!$("link[href='"+b+"']")[0]){$("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}a&&a()},populatePlatform:function(a){$(function(){$("a").each(function(){var b=$(this).attr("href");if(b&&(b.indexOf("justgola.com")>=0||b[0]=="index.html")){if(b.indexOf("?")>0){b+="platform="+a}else{b+="?platform="+a}$(this).attr("href",b)}})})}};window.fiuzu.common.CommonApp=function(){var a=this;this.init=function(){$(function(){a.preventDefaultSelfAnchor();a.initCommonHandler();a.initCSRFProtection();a.addTouchEventHandler();a.overwriteWindowAlert();a.refreshTooltip();a.initTopSearchBox();a.addEventTracking();a.showZopim()})};this.initCommonHandler=function(){$(".btn-wishlist").each(function(){$(this).FiuzuWishlistButton()});$(".btn-visiteditem").each(function(){$(this).FiuzuVisitedItemButton()});$(".btn-reporterror").each(function(){$(this).FiuzuReportErrorButton()});$(".btn-plan-clone").each(function(){$(this).FiuzuPlanCloneButton()});fiuzu.utils.loader.init()};this.initCSRFProtection=function(){function b(c){return(/^(GET|HEAD|OPTIONS|TRACE)$/.test(c))}$.ajaxSetup({crossDomain:false,beforeSend:function(e,d){if(!b(d.type)){var c=fiuzu.cookie.getCookie("csrftoken");e.setRequestHeader("X-CSRFToken",c)}}})};this.preventDefaultSelfAnchor=function(){$(document).click(function(d){if(d.target){var f=$(d.target);if(f.prop("tagName")==="A"){var e=f.attr("href");if(e==="#"){d.preventDefault()}if(e&&e.length>1&&e[0]==="#"&&f.hasClass("anchor-scroll")){var c=$(e);if(c){var b=c.position();$("body").animate({scrollTop:b.top},300)}}}}})};this.showZopim=function(){if(!window.enableZopim){return false}if(!window.partner&&top==window&&window.platform!="app"){window.$zopim||(function(h,b){var g=window.$zopim=function(d){g._.push(d)},c=g.s=h.createElement(b),f=h.getElementsByTagName(b)[0];g.set=function(d){g.set._.push(d)};g._=[];g.set._=[];c.async=!0;c.setAttribute("charset","utf-8");c.src="http://v2.zopim.com/?1oy6HBQ8aHH5qP50W6OaE0RyKjfzX92N";g.t=+new Date;c.type="text/javascript";f.parentNode.insertBefore(c,f)})(document,"script")}};this.refreshTooltip=function(){fiuzu.utils.refreshTooltip()};this.addEventTracking=function(){$(".tracking").each(function(){var f=$(this);var c=f.attr("data-trktoggle")||"click";var d=f.attr("data-trkaction");var b=f.attr("data-trkcategory");var e=f.attr("data-trklabel");var g=f.attr("data-trkvalue");f.on(c,function(){if(b&&d){fiuzu.analytic.track([b,d,e,g])}})})};this.overwriteWindowAlert=function(){window.alert=function(c,d){var d=d||"Message";var b=$("#fiuzu-dialog").clone();$(".modal-title",b).html(d);$(".dialog-content",b).html(c);b.modal().on("hide.bs.modal",function(f){$(".modal-backdrop").remove()})}};this.addTouchEventHandler=function(){return};this.initTopSearchBox=function(){if($(window).width()>=768){$("#top-search-input").FiuzuAutocomplete({source:"/api/place/search",all:true,keyword:$("#top-search-input").val(),select:{selected:function(c,b){$(this).val(b.name);window.location.href="/a/"+b.slug+"-"+b.id;return false}}})}if(fiuzu.session.isMobile){$(".navigate-menu li ul a").on("mouseover click",function(){$(this).parent().siblings().find("a").removeClass("active");$(this).addClass("active");$(".navigate-menu button").removeClass("active");$(this).parent().parent().parent().find("button").addClass("active")});$(".top-message").find(".close").click(function(){fiuzu.cookie.set("hidejsm-"+$(this).attr("data-id"),0);$(".top-message").hide()})}}};window.fiuzu.utils=window.fiuzu.utils||{};fiuzu.utils.convertAmPmTo24Hours=function(f){var a=Number(f.match(/^(\d+)/)[1]);var d=Number(f.match(/:(\d+)/)[1]);var e=f.match(/\s(.*)$/)[1];if(e=="PM"&&a<12){a=a+12}if(e=="AM"&&a==12){a=a-12}var c=a.toString();var b=d.toString();if(a<10){c="0"+c}if(d<10){b="0"+b}return c+":"+b};fiuzu.utils.checkAppInstall=function(){var e=/ipad|iphone|ipod/i.test(navigator.userAgent.toLowerCase()),c=/android/i.test(navigator.userAgent.toLowerCase()),b=window.owner_id,d=window.planId;if(e||c){if(fiuzu.cookie.get("check_app_installed")=="0"||!fiuzu.cookie.get("check_app_installed")){var a="justgola:"+window.location.origin.substring(window.location.protocol.length)+"/plan/?plan_id="+d;setTimeout(function(){if(e){window.location="https://itunes.apple.com/vn/app/justgola-asia-trip-planner/id1056005447?mt=8"}if(c){window.location="https://play.google.com/store/apps/details?id=com.fiuzu.android"}},25);if(b){window.location=a+"&owner_id="+b;console.log(a+"&owner_id="+b)}else{window.location=a}fiuzu.cookie.set("check_app_installed",1,null,"index.html")}}};fiuzu.utils.mustGoDict=function(a,g){var e=[];var f=[];var b={cityId:g.cityId,mustGoDict:g.mustGoDict};if(a&&a.length){var d=a.length;for(var c=0;c<d;c++){e.push(a[c].cityId);if(a[c].cityId===g.cityId){a[c].mustGoDict=g.mustGoDict}}if(e.indexOf(g.cityId)==-1){a.push(b)}}else{a.push(b)}return a};fiuzu.utils.menuPushRightMobile=function(){$("#nav-expander").on("click",function(d){d.preventDefault();$(this).toggleClass("open-menu");setTimeout(function(){$("body").toggleClass("nav-expanded")},0);c()});if($(".main-menu-mobile-options li:last-child").offset()){var a=$(".main-menu-mobile-options li:last-child").offset().top;var b=$(".social-floating-box").offset().top;if(b-a>200){$(".social-floating-box, .main-menu-mobile-app").removeClass("hidden")}else{$(".social-floating-box, .main-menu-mobile-app").addClass("hidden")}}function c(){var d=$(".navbar-header").offset()?$(".navbar-header").offset().top:0;$(".search-menu-mobile").css({marginTop:d})}c()};fiuzu.utils.welcomeLogin=function(){if(fiuzu.cookie.get("welcome_user")=="0"||!fiuzu.cookie.get("welcome_user")){fiuzu.common.decorator.isAuth(function(){alert("Hello "+fiuzu.session.user.name+"<br/>It is great to see you again. Enjoy your holiday and have fun!","Welcome !");fiuzu.cookie.set("welcome_user",1,null,"index.html")})}};fiuzu.utils.showDownloadApp=function(){if(navigator.userAgent.match(/Tablet|iPad/i)){a()}function a(){var c=window.platform;if(!c&&c!="app"){if(fiuzu.cookie.get("no_thanks")=="0"||!fiuzu.cookie.get("no_thanks")){setTimeout(function(){$("#download-app-mobile").modal("show")},30000)}$("#no-thank-download").click(function(){fiuzu.cookie.set("no_thanks",1,null,"index.html")})}}var b=0;$(".btn-plan-save").click(function(){if($(window).width()>768){if(fiuzu.cookie.get("no_thanks_promoting")=="0"||!fiuzu.cookie.get("no_thanks_promoting")&&b===0){setTimeout(function(){$("#planner-promoting-app").modal("show")},1000)}}});$(".ok-got-it, .close").click(function(){fiuzu.cookie.set("no_thanks_promoting",1,null,"index.html");return b=1})};fiuzu.utils.loadImageMobile=function(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)){$(window).bind("touchmove",function(a){$(window).scroll()})}};fiuzu.utils.scrollToTop=function(){var b=1200,d=1700,a=700,c=$(".back-to-top");if($(window).width()<480){if($("#main-menu-left").hasClass("snap-drawer-left")){c.addClass("hidden")}else{c.removeClass("hidden")}}$(window).scroll(function(){if($(this).scrollTop()>b){c.addClass("is-visible")}else{c.removeClass("is-visible")}});c.on("click",function(e){e.preventDefault();$("body, html").animate({scrollTop:0},a)})};fiuzu.utils.addClassActiveMenu=function(){var a=window.location.pathname,b=new RegExp(a.replace(/\/$/,"")+"$");$(".navbar-custom-page .main-menu-mobile-options a, .navbar-custom-page .navbar-nav.navbar-right a, .navbar-custom-blog .navbar-nav.navbar-right a, .navbar-blog .main-menu-mobile-options a").each(function(){if(b.test(this.href.replace(/\/$/,""))){$(this).parent().addClass("active");$(this).parent(".last").removeClass("active")}});if(a==="index.html"){$('.navbar-custom .main-menu-mobile-options a[href="/"]').parent().addClass("active")}};fiuzu.utils.showSubcribeTop=function(){return false};function changePositionSearchForm(){var b=$(".plugin-create-plan").detach(),a="#43c0d8 url('static/images/travelingtoasia4963.png?ver=1.1') no-repeat right 2px";$(".new-search-form").append(b);$(".plugin-create-plan-title").removeClass("hidden");$(".plugin-create-plan").affix({offset:{top:50}}).css({background:a,paddingTop:5})}$(".scroll-down, .subcribe-no-thank, .btn-close-subscribe, .subcribe-modal .close").on("click",function(){setTimeout(function(){$("#subcribe-top").hide()},300);fiuzu.cookie.set("no_thanks_subcribe",1,null,"index.html")});fiuzu.utils.abTestingModal=function(){fiuzu.common.decorator.isAuth(function(){if($(window).width()>992&&location.href.indexOf("/planner")<0){if(fiuzu.cookie.get("no_thanks_desktop")=="0"||!fiuzu.cookie.get("no_thanks_desktop")){setTimeout(function(){$(".AB-testing.modal").modal("show")},3000)}$(".AB-testing.modal").on("hidden.bs.modal").click(function(){fiuzu.cookie.set("no_thanks_desktop",1,null,"index.html")})}$(".login-feature-plan").addClass("hidden")})};fiuzu.utils.initBtnSubcribe=function(){return false};fiuzu.utils.mixPanelTracking=function(){if(typeof mixpanel!=="undefined"){mixpanel.track_forms(".mixpanel-form","Submit form to another page",{referrer:document.referrer});mixpanel.track_links(".mixpanel-link","Click to another page",{referrer:document.referrer});$(".mixpanel-obj").each(function(){var b=$(this).attr("data-action"),a=$(this).attr("data-mx-name");if(b){$(this).on(b,function(c){var d={url:location.href};d.name=a;d.params=$(this).attr("data-mx-params");if(a){mixpanel.track(a,d)}})}})}};fiuzu.utils.tutorialPlanner=function(a){if($(window).width()>1024&&$(window).width()<2000){if(fiuzu.cookie.get("no_thanks_tutorial")=="0"||!fiuzu.cookie.get("no_thanks_tutorial")){setTimeout(function(){$(".tutorial-planner .modal").modal("show")},600)}else{a&&a()}$(".howtouse-close-tutorial").click(function(){$(".tutorial-planner .modal").modal("hide");fiuzu.cookie.set("no_thanks_tutorial",1,null,"index.html");a&&a()})}};fiuzu.utils.showMessageProfile=function(){if($(window).width()>768){if(fiuzu.cookie.get("planner_founder")=="0"||!fiuzu.cookie.get("planner_founder")){setTimeout(function(){$(".message-profile-planner .modal").modal("show")},60000);setTimeout(function(){$(".message-profile-planner .modal").modal("show");$(".message-profile-content:first").html('Check out Smart filter to get faster and better result. Click filter <a href="#explore/category/activity">Free Activities</a>, <a href="#explore/category/attraction">Kids</a>, <a href="#explore/category/attraction">Highlights</a>, <a href="#explore/category/attraction">Off the beaten path</a>');$(".message-profile-content:first").next().text("Hope you can find amazing places!");$(".message-profile-planner").on("hidden.bs.modal",function(){fiuzu.cookie.set("planner_founder","1")})},120000)}}};fiuzu.utils.renderUserLogin=function(){var c="",b=$("#inc-user").html();if(b===null){return}else{var a=_.template(b,null,{variable:"data"})}fiuzu.common.decorator.isAuth(function(){var d=fiuzu.session.user;$("#btn-login-checked").hide();$("#btn-top-login, #btn-top-register").parent().hide();c=a(d);$("#user-logined").html(c);$(".btn-success").parent().removeClass("hidden");if(d.is_business===true&&d.is_business_disabled===false){$(".mobile-user").addClass("hidden")}else{$(".mobile-user").removeClass("hidden");$(".mobile-business-user").addClass("hidden")}},function(){$("#btn-login-checked").show();$("#btn-top-login, #btn-top-register").parent().show();$(".user-menu .btn-new-trip").parent().addClass("hidden")})};fiuzu.utils.loader={init:function(){this.el$=fiuzu.utils.loader.$el||$("#loading-box").clone();this.content$=this.el$.find(".box-content")},loading:function(a){if(a){this.content$.text(a)}this.el$.modal().on("hide.bs.modal",function(b){$(".modal-backdrop").remove()})},setContent:function(a){this.content$.text(a)},loaded:function(a){this.el$.modal("hide")}};fiuzu.utils.FiuzuCityAC=function(c){var a=null;var b=function(e,f){var d;if(c.all){d="/api/city/"}if(a){a.abort()}a=$.getJSON(d,e,function(){}).done(function(m,j,n){if(n==a){var h=[];var l=m.results;for(var k=0,g=l.length;k<g;k++){h.push(l[k])}if(h.length){f(h)}else{f([{NO_RESULT:true}])}}}).fail(function(){f([{NO_RESULT:true}])})};return b};fiuzu.utils.formatNumber=function(d){var e=d.toString().length-1;e=Math.pow(10,e);var a=["K","M","B","T"];for(var c=a.length-1;c>=0;c--){var b=Math.pow(10,(c+1)*3);if(b<=d){d=Math.round(d*e/b)/e;d=Math.round(d*10)/10;if((d==1000)&&(c<a.length-1)){d=1;c++}d+=a[c];break}}return d};fiuzu.utils.getXRate=function(d,c){c=c||fiuzu.session.currency;d=d||"USD";var b=fiuzu.currencies[d],a=fiuzu.currencies[c];return a/b};fiuzu.utils.convertCurrency=function(b,d){var c=fiuzu.utils.getXRate(d);var a=b.toFixed(2)*c;if(a>1000){a=Math.round(a/100)*100;a=a.formatMoney(0,",",",")}else{a=a.formatMoney(2)}return a};fiuzu.utils.changeTime24h=function(b,c){var a="24h";if(!b&&!c){return}if(b=="00:00"&&c=="00:00"){return a}else{return" from "+b+" to "+c}};fiuzu.utils.convertTime=function(i,e){if(!e){var d=parseInt(i);var j=(d<10)?("0"+d+":"):(d+":");var g=((i-d)*60).toFixed(0);j=(g<10)?(j+"0"+g):(j+g);return j}else{var c=i.split(":");var f=parseInt(c[0]);var b=parseInt(c[1]);if(!isNaN(f)&&!isNaN(b)){return parseFloat((f+(b/60)).toFixed(2))}else{return i}}};fiuzu.utils.exportTime=function(c){var a=parseInt(c);var d=a>1?a+" hours ":"1 hour ";if(a<1){d=""}var b=((c-a)*60).toFixed(0);if(b>0){d=(b>1)?d+b+" mins":d+b+" min"}return d};fiuzu.utils.isInViewport=function(a){var b=a.getBoundingClientRect();return(b.top>=0&&b.left>=0&&b.top<=(window.innerHeight||document.documentElement.clientHeight))};fiuzu.utils.popUp=function(d,b){var a=new Date();var g=a.getTime();var e=screen.width;var c=(e-500)/2;var f=window.open(d,g,"toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=500,height=250,top=150,left="+c);if(f){f.onbeforeunload=function(){b&&b(f)}}else{if(fiuzu.session.isMobile){b&&b(f)}}};fiuzu.utils.shareOn=function(d,b,a){var f=b?b:window.location.href;var k=[];var g=encodeURIComponent(f);var h=a.description,e=a.image,c=a.city,j=a.callback;var i="";if(c){i="Check out my wonderful trip to : "+c}i=(h!==""?encodeURIComponent(h):encodeURIComponent(i));k.twitter="http://twitter.com/share?text="+i+"&url="+g;k.facebook="http://www.facebook.com/sharer.php?u="+g+"&t="+i;k["google-plus"]="https://plus.google.com/share?url="+g;k.blogger="http://www.blogger.com/blog-this.g?src="+g;k.reddit="http://www.reddit.com/submit?url="+g;k.linkedin="http://www.linkedin.com/shareArticle?url="+g;k.tumblr="http://www.tumblr.com/share/link?url="+g;k.livejournal="http://www.livejournal.com/update.bml?url="+g;k.pinterest="http://www.pinterest.com/pin/create/button/?url="+g+"&media="+encodeURIComponent(e)+"&description="+(h!==""?encodeURIComponent(h):encodeURIComponent(i));k.stumbleupon="http://www.stumbleupon.com/submit?url="+g;var b=k[d];fiuzu.utils.popUp(b,j)};fiuzu.utils.refreshTooltip=function(a){fiuzu.utils.clearTooltip();a=a||$("body");$(".tooltip").hide();if(!("ontouchend"in document)){$(function(){$(".tipB",a).tooltip({placement:"bottom",container:"body",html:true});$(".tipR",a).tooltip({placement:"right",container:"body",html:true});$(".tipL",a).tooltip({placement:"left",container:"body",html:true});$(".tipT",a).tooltip({placement:"top",container:"body",html:true});$(".tipT, .tipR, .tipL, .tipB",a).click(function(){$(this).tooltip("hide")});$(".alert .close").click(function(){$(this).parent().hide()})})}};fiuzu.utils.clearTooltip=function(){$("body > .tooltip.fade").remove()};fiuzu.utils.getLocationByIP=function(d){var b=fiuzu.cookie.get("userLocation");try{b=atob(b)}catch(c){b=null}if(!b||b==""){$.get("/api/location",function(e){var f=e.loc.split(",");e.lat=parseFloat(f[0]);e.lng=parseFloat(f[1]);if(e.org){var g=e.org.split(" ");if(g[1]){e.org=g[1]}fiuzu.utils.setLocation(e);if(d){d(e)}fiuzu.cookie.set("userLocation",btoa(JSON.stringify(e)))}},"jsonp")}else{var a=JSON.parse(b);fiuzu.utils.setLocation(a);if(d){d(a)}}};fiuzu.utils.setLocation=function(a){var b={location:a,action:"setlocation"};return true};fiuzu.utils.getLocation=function(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(a){var b={lat:a.coords.latitude,lng:a.coords.longitude};fiuzu.utils.setLocation(b)},function(a){var b;if(a.code==a.PERMISSION_DENIED){b="User denied the request for Geolocation."}else{if(a.code==a.POSITION_UNAVAILABLE){b="Location information is unavailable."}else{if(a.code==a.TIMEOUT){b="The request to get user location timed out."}else{b="An unknown error occurred."}}}fiuzu.utils.getLocationByIP()})}else{window.console&&console.log("Geolocation is not supported by this browser.");fiuzu.utils.getLocationByIP()}};fiuzu.utils.getUniqueId=function(){return""+Math.random().toString(36).substr(2,9)};fiuzu.utils.getWindowSize=function(){var e=[{value:fiuzu.WINDOW_SIZE_XS,minWidth:0},{value:fiuzu.WINDOW_SIZE_SM,minWidth:768},{value:fiuzu.WINDOW_SIZE_MD,minWidth:970},{value:fiuzu.WINDOW_SIZE_LG,minWidth:1170}];var d=$(window).width();var c,a=e.length;var b;for(c=0;c<a;c++){if(d>=e[c].minWidth){b=e[c].value}}return b};fiuzu.utils.getTimeStamp=function(){return Math.floor(Date.now()/1000)};fiuzu.utils.isEmail=function(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)};fiuzu.utils.loadModal=function(b){var j,a=b.method||"GET",e="."+b.classId,n=b.multiple,c=b.reload,m=b.requires;console.log("opts ",c);var l=function(i,o){i.modal({});i.on("hide.bs.modal",function(p){$(".modal-backdrop").remove();if(fiuzu.MODAL_ACTIONS&&fiuzu.MODAL_ACTIONS[b.classId]&&fiuzu.MODAL_ACTIONS[b.classId].callbacks&&fiuzu.MODAL_ACTIONS[b.classId].callbacks.close){fiuzu.MODAL_ACTIONS[b.classId].callbacks.close(j)}});if(o&&fiuzu.MODAL_ACTIONS&&fiuzu.MODAL_ACTIONS[b.classId]&&fiuzu.MODAL_ACTIONS[b.classId].init){fiuzu.MODAL_ACTIONS[b.classId].init(j,b.initParams)}};if(!c&&!n&&$(e)[0]){j=$(e);l(j);b.reload&&b.reload()}else{var g={type:a,data:b.params,url:b.url,success:function(i){b.success&&b.success();if(n||!$(e)[0]){j=$(i);j.addClass(b.classId);$("body").append(j)}else{var p=$(i);j=$(e);j.html(p.html())}var o;fiuzu.MODAL_ACTIONS=fiuzu.MODAL_ACTIONS||{};fiuzu.MODAL_ACTIONS[b.classId]=fiuzu.MODAL_ACTIONS[b.classId]||{};if(b.callbacks){fiuzu.MODAL_ACTIONS[b.classId].callbacks=fiuzu.MODAL_ACTIONS[b.classId].callbacks||{};for(o in b.callbacks){fiuzu.MODAL_ACTIONS[b.classId].callbacks[o]=b.callbacks[o]}}l(j,true)},error:function(i){b.error&&b.error(i)}};if(b.data){g.data=JSON.stringify(b.data);g.contentType="application/json";g.type="POST"}console.log(g)}if(!m||!m.length){$.ajax(g)}else{var k=m.length,f=0;var d=function(){f++;if(f>=k){$.ajax(g)}};for(var h=0;h<m.length;h++){if(m[h].indexOf(".js")>0){fiuzu.loadScript(m[h],d)}else{if(m[h].indexOf(".css")>0){fiuzu.loadStyle(m[h],d)}else{d()}}}}};fiuzu.utils.getISOStringFromDate=function(b,c){if(b){var a=b.getMonth()+1,e=b.getDate(),f=b.getFullYear();return f+"-"+(a<10?"0":"")+a+"-"+(e<10?"0":"")+e+(c?"T":"")+(c?c:"")}return null};fiuzu.utils.getDateFromISOString=function(b){if(b&&b!=""&&b.indexOf("-")>0){b=b.substring(0,10);var a=b.split("-");return new Date(parseInt(a[0]),parseInt(a[1])-1,parseInt(a[2]))}else{console.log("Invalid ISO Format yyyy-mm-dd to convert "+b+" to Date");return null}};fiuzu.utils.convertDate=function(a){var b=a.split(/\D/g);return[b[2],b[1],b[0]].join("-")};fiuzu.utils.getLocaleStringFromDate=function(b,c){if(b){var a=b.getMonth()+1,e=b.getDate(),f=b.getFullYear();return(e<10?"0":"")+e+"/"+(a<10?"0":"")+a+"/"+f}return null};fiuzu.utils.getDateFromLocaleString=function(b){if(b&&b!=""&&b.indexOf("index.html")>0){var a=b.split("index.html");return new Date(parseInt(a[2]),parseInt(a[1])-1,parseInt(a[0]))}else{console.log("Invalid Locale Format dd/mm/yyyy to convert "+b+" to Date");return null}};fiuzu.utils.getLocaleDateFromISODate=function(a,b){return this.getLocaleStringFromDate(this.getDateFromISOString(a),b)};fiuzu.utils.getISODateFromLocaleDate=function(b,a){return this.getISOStringFromDate(this.getDateFromLocaleString(b),a)};fiuzu.utils.correctISODateFromISOString=function(a,b){return this.getISOStringFromDate(this.getDateFromISOString(a),b)};fiuzu.utils.parseFormData=function(b,d){var c={};for(var a=0;a<b.length;a++){var g=b[a].name,e=b[a].value;var f=g.indexOf("[]")>0;if(f){g=g.replace("[]","");if(g in c){if(d&&d.list){c[g].push(e)}else{c[g]+=","+e}}else{c[g]=(d&&d.list)?[e]:e}}else{c[g]=e}}return c};fiuzu.utils.getXhrErrorMessage=function(g,a){try{var b=JSON.parse(g.responseText);if(b){if(a){return b}else{var f=b.detail||b.details||b.__all__;return typeof(f)=="string"?f:f.join()}}return null}catch(c){return null}};fiuzu.utils.isFireFoxBrowser=function(){if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){return true}return false};fiuzu.utils.isIEBrowser=function(){var b=window.navigator.userAgent;var a=b.indexOf("MSIE ");if(a>0||!!navigator.userAgent.match(/Trident.*rv\:11\./)){return true}return false};fiuzu.utils.isFireFoxBrowser=function(){var a=window.navigator.userAgent;if(a.toLowerCase().indexOf("firefox")>-1){return true}return false};fiuzu.utils.showSystemMessagePopup=function(){var a={classId:"modal-sysmsg",url:"/modal/sysmsg",method:"GET"};fiuzu.utils.loadModal(a)};fiuzu.utils.showPrivacyPolicy=function(){var a={classId:"modal-privacy-policy",url:"/modal/privacy",method:"GET"};fiuzu.utils.loadModal(a)};fiuzu.utils.downloadFile=function(b){if(/(iP)/g.test(navigator.userAgent)){alert("Your device does not support files downloading. Please try again in desktop browser.");return false}if(fiuzu.utils.downloadFile.isChrome||fiuzu.utils.downloadFile.isSafari){var a=document.createElement("a");a.href=b;if(a.download!==undefined){var d=b.substring(b.lastIndexOf("index.html")+1,b.length);a.download=d}if(document.createEvent){var c=document.createEvent("MouseEvents");c.initEvent("click",true,true);a.dispatchEvent(c);return true}}if(b.indexOf("?")===-1){b+="?download"}window.open(b,"_self");return true};fiuzu.utils.downloadFile.isChrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;fiuzu.utils.downloadFile.isSafari=navigator.userAgent.toLowerCase().indexOf("safari")>-1;fiuzu.cookie={has:function(c){var b=c+"=",a=document.cookie.indexOf(b);return(a>=0)},set:function(b,d,a,f,c,e){document.cookie=b+"="+escape(d)+((a)?"; expires="+a.toGMTString():"")+("%3b%20path%3d/index.html")+((c)?"; domain="+c:"")+((e)?"; secure":"")},get:function(d){var b=d+"=";var a=document.cookie.split(";");for(var f=0;f<a.length;f++){var j=a[f].trim();if(j.indexOf(b)==0){try{var g=decodeURIComponent(j.substring(b.length,j.length));return g}catch(h){return""}}}return""},clear:function(){document.cookie=""},getCookie:function(a){var e=null;if(document.cookie&&document.cookie!=""){var d=document.cookie.split(";");for(var c=0;c<d.length;c++){var b=jQuery.trim(d[c]);if(b.substring(0,a.length+1)==(a+"=")){e=decodeURIComponent(b.substring(a.length+1));break}}}return e}};fiuzu.session={_messages:[],_callbacks:null,_tempvars:null,setCallback:function(a,b){this._callbacks=this._callbacks||{};this._callbacks[a]=b},getCallback:function(a){return this._callbacks?this._callbacks[a]:null},setTempVar:function(a,b){this._tempvars=this._tempvars||{};this._tempvars[a]=b},getTempVar:function(a){return this._tempvars?this._tempvars[a]:null},addMessage:function(a){this._messages.push(a)},getMessages:function(){return this._messages}};fiuzu.cache={ajax:{timeout:300000,data:{},remove:function(a){delete this.data[a]},exist:function(a){return!!this.data[a]&&((new Date().getTime()-this.data[a]._)<this.timeout)},get:function(a){window.console&&console.log("Getting in cache for url "+a);return this.data[a].data},set:function(a,b,c){this.remove(a);this.data[a]={_:new Date().getTime(),data:b};if($.isFunction(c)){c(b)}},getId:function(a,b){return a+(b?JSON.stringify(b):"")},clear:function(){this.data={}}}};fiuzu.pdf={pdfData:null,pdfStatus:0,pdfName:gettext("Itinerary"),jsInit:false,jsFiles:0,initJsFile:function(b){var a=this;if(a.jsInit){return false}var c=function(){a.jsFiles++;if(a.jsFiles==2){b&&b();a.jsInit=true}};fiuzu.loadScriptTag("https://cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/pdfmake.min.js",c);fiuzu.loadScriptTag("https://cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js",c)},downloadPDFData:function(d,c,b){var a=this;a.pdfStatus=1;$.ajax({url:"/api/plan/"+d+"/pdfmake?partner="+(window.partner||"")+"&hl="+(window.language||"en"),success:function(e){a.pdfData=e;a.pdfStatus=2;a.downloadPDF(d,c,b)},error:function(){a.pdfData=null;a.pdfStatus=3;a.downloadPDF(d,c,b)}})},render:function(b){var a=this;window.pdfMake.createPdf(a.pdfData).download(a.pdfName+".pdf");if(!b){a.pdfData=null;a.pdfStatus=0}},downloadPDF:function(d,c,b){var a=this;a.pdfName=c;if(a.pdfData){try{a.render(b)}catch(f){alert(gettext("Cannot download PDF at this time. Please try later !"));console.log(f)}fiuzu.utils.loader.loaded()}else{if(a.pdfStatus==0){fiuzu.utils.loader.loading();a.downloadPDFData(d,c,b)}else{if(a.pdfStatus==1){setTimeout(function(){a.downloadPDF(d,c,b)},1000)}else{fiuzu.utils.loader.loaded();alert(gettext("Cannot download PDF at this time. Please try later !"))}}}}};fiuzu.datetime={TIME_PATTERN:/^([0-9]|0[0-9]|1[0-9]|2[0-3]):(0[0-9]|[0-5][0-9])(|:[0-5][0-9]|0[0-9])$/,time2num:function(d){var c=d.match(this.TIME_PATTERN);if(c){var a=c[3].replace(":",""),b=parseInt(c[1])+parseInt(c[2])/60;if(a){b+=parseInt(a)/3600}return b}throw"Invalid time format. Got "+d},num2time:function(c){if(c<=0){return"00:00"}c=Math.round((c%24)*100)/100;var a=parseInt(c),b=Math.round(60*(c-a));if(b<10){b="0"+b}if(a<10){a="0"+a}return a+":"+b},timediff:function(c,b){var a=this.time2num(c),d=this.time2num(b);return Math.round((d-a)*100)/100},addtime:function(b,c){var a=this.time2num(b),d=this.time2num(c);return this.num2time((a+d)%24)},subtracttime:function(c,b){var a=this.time2num(c),e=this.time2num(b),d=a-e;if(d<0){d+=24}return this.num2time(d%24)},num2text:function(d,k,e,f){if(d<=0){return"0h"}k=k||"hour";var j=d;if(k=="minute"){j/=60}if(k=="second"){j/=3600}if(f){j=Math.round(j*60/5)*5/60}var i=parseInt(j/24),g=parseInt(j%24),h=Math.round(((j%24)-g)*60),b=Math.round(((j%24)-g-h/60)*3600);if(h==60){h=0;g+=1}if(g==24){g==0;i+=1}var c=i?i+"day ":"",m=g?g+"h ":"",l=h?h+"min ":"",a=e?(b?b+"s":""):"";return(c+(m?m:"")+(l?l:"")+(a?a:"")).trim()}};fiuzu.geo={DEGREETOKM:111,distance:function(f,e,d){if(f&&e&&f.lat&&e.lat&&f.lng&&e.lng){var c=f.lat-e.lat,a=f.lng-e.lng,b=Math.sqrt(Math.pow(c,2)+Math.pow(a,2));if(!d){return b*this.DEGREETOKM}else{return this.dis2text(b*this.DEGREETOKM)}}throw"Not valid location. Got "+JSON.stringify(f)+" - "+JSON.stringify(e)},dis2text:function(a){if(a<1){return Math.round(a*1000)+"m"}else{return(a.toFixed(2)+"km")}},besttransport:function(c,a){var b=this.distance(c,a);if(b<1/Math.sqrt(2)){return fiuzu.common.models.ROUTE_MODE_WALKING}return fiuzu.common.models.ROUTE_MODE_DRIVING},estimatetime:function(e,c,d){var a=this.distance(e,c),b;d=d||fiuzu.common.models.ROUTE_MODE_DRIVING;if(d==fiuzu.common.models.ROUTE_MODE_DRIVING){b=(a*Math.sqrt(2))/45}else{if(d==fiuzu.common.models.ROUTE_MODE_WALKING){b=(a*Math.sqrt(2))/5}}return b}};$.ajaxPrefilter(function(c,g,d){if(c.cache){var b=g.complete,e=g.success;var f=fiuzu.cache.ajax.getId(g.url,g.data),a=fiuzu.cache.ajax.exist(f);c.cache=false;c.beforeSend=function(){if(!a){d.promise().done(function(h,i){fiuzu.cache.ajax.set(f,h)})}else{b&&b(fiuzu.cache.ajax.get(f));e&&e(fiuzu.cache.ajax.get(f));return false}return true};if(a){if(b){c.complete=function(i,h){fiuzu.cache.ajax.set(f,i,b)}}if(e){c.success=function(i,h){fiuzu.cache.ajax.set(f,i,e)}}}}});$.ajaxTransport("+*",function(a,f,b,d,c){var e=fiuzu.cache.ajax.getId(f.url,f.data);a.cache=false;if(fiuzu.cache.ajax.exist(e)){return{send:function(h,g){g(200,"OK",fiuzu.cache.ajax.get(e))},abort:function(){}}}});(function(){var a=new fiuzu.common.CommonApp();a.init();$(function(){fiuzu.ui.initShareButtons&&fiuzu.ui.initShareButtons();fiuzu.utils.menuPushRightMobile();fiuzu.utils.scrollToTop();fiuzu.utils.welcomeLogin();fiuzu.utils.addClassActiveMenu();fiuzu.utils.loadImageMobile();fiuzu.utils.showDownloadApp();fiuzu.utils.renderUserLogin();fiuzu.utils.showMessageProfile();fiuzu.utils.showSubcribeTop();fiuzu.utils.abTestingModal();if(typeof mixpanel!=="undefined"){fiuzu.utils.mixPanelTracking()}fiuzu.utils.promotingApp()})}());fiuzu.receiveMessage=function(f){var g,d=f?f.originalEvent.data:null;window.console&&console.log("ChWin receives: ",d);if(d&&d.type){switch(d.type){case"partnerListenTopBody":window.topBody$=d.data;$("#dlg-how-it-works")[0]&&(window.topHowItWorks$=$("#dlg-how-it-works").clone().appendTo(window.topBody$));$("#dlg-how-to-start")[0]&&(window.topStart$=$("#dlg-how-to-start").clone().appendTo(window.topBody$));break;case"partnerRequestWindowHeight":var b=document.body.scrollHeight+50;g={type:"partnerListenWindowHeight",data:{height:b,fullscreen:d.data.fullscreen}};top.postMessage(g,"*");break;case"partnerRequestUpdateChildUrl":g={type:"partnerListenUpdateChildUrl",data:window.location.href};top.postMessage(g,"*");break;case"partnerUpdateChildPopupPosition":var a=50,c=".modal .modal-dialog, .modal .box-login, .modal .box-forgotpass";if(d.data){if(d.data.top>d.data.start){a=d.data.top-d.data.start+50;$(c).css({marginTop:a});$(".modal").off("shown.bs.modal");$(".modal").on("shown.bs.modal",function(){$(c).css({marginTop:a})})}}break;case"partnerResizeWindow":$(window).trigger("resize");break}}};$(window).on("message",fiuzu.receiveMessage);"use strict";window.fiuzu.common.models=window.fiuzu.common.models||{};(function(a){a.ITI_ITEM_TYPE_NORMAL=0;a.ITI_ITEM_TYPE_ACCOMMONDATION=10;a.ITI_ITEM_TYPE_MEAL=20;a.ITI_ITEM_TYPE_BREAKFAST=21;a.ITI_ITEM_TYPE_LUNCH=22;a.ITI_ITEM_TYPE_DINNER=23;a.ITI_ITEM_TYPE_TRANSIT=30;a.ROUTE_MODE_NOMODE=0;a.ROUTE_MODE_DRIVING=1;a.ROUTE_MODE_WALKING=2;a.ROUTE_MODE_PUBLIC_TRANSPORT=3;a.ROUTE_MODE_BICYCLING=4;a.PLAN_PERMISSION_NONE=0;a.PLAN_PERMISSION_VIEW=1;a.PLAN_PERMISSION_EDIT=2;a.PLAN_PERMISSION_ALL=4;a.BOOKITEM_STATUS_DEFAULT=0;a.BOOKITEM_STATUS_BOOKED=1;a.BOOKITEM_STATUS_AUTO_ADDED=2;a.BOOKITEM_STATUS_IN_CART=3;a.BOOKITEM_STATUS_CONFIRMED=4;a.BOOKITEM_STATUS_OVERDUE=5;a.BOOKITEM_STATUS_DELETED=6;a.BOOKITEM_STATUS_IN_CART_CONFIRMED=7;a.BaseModel={parse:function(c,b){return c},set:function(b,d,c){this.needSave=true;return Backbone.Model.prototype.set.call(this,b,d,c)}};a.PhotosBaseModel={_tempPhotos:{},addPhotoMembership:function(d,f,c){var b=this;var e=new a.PhotoMembership({photo:d.get("id"),type:this.modelName,object:this.get("id")});e.save(null,{success:function(g,h){d.set("has_photomembership",true);f&&f(d)},error:function(g,i){var h=fiuzu.utils.getXhrErrorMessage(i);if(h.indexOf("already exists.")){f&&f(d)}else{d.destroy();c&&c(d,h)}}})},removePhotoMembership:function(c,e,b){var d=new a.PhotoMembership({photo:c.get("id"),type:this.modelName,object:this.get("id")});d.destroy({success:function(f,g){e&&e(c)},error:function(f,h){var g=fiuzu.utils.getXhrErrorMessage(h);b&&b(c,g)}})},generateUniqueStamp:function(){var b=new Date().getTime();while(b in this._tempPhotos){b=new Date().getTime()}return b},selectMainPhoto:function(){var c=this.get("photos")||[];for(var b=0;b<c.length;b++){if(c[b].id){return c[b]}}},autoSetMainPhoto:function(){if(!this.get("photo")){var b=this.selectMainPhoto();b&&this.set("photo",b)}},setMainPhoto:function(b){if(b){if(typeof(b)=="number"){var c=this.getPhoto(b);if(c){b=c}else{this.set("photo",b);return}}this.set("photo",b.toJSON())}},getPhoto:function(b,d){var e=this.get("photos")||[];for(var c=0;c<e.length;c++){if(b&&e[c].id==b||(d&&e[c].stamp==d)){return new a.Photo(e[c])}}return null},addPhoto:function(c,k,g){var l=this,d=c.get("id"),f=false,b=c.get("stamp");f=l.getPhoto(d,b);var e=function(m){var n=l.get("photos")||[];n.push(m.toJSON());if(l.isNew()){l.set("photos",n,{silent:true})}else{l.set("photos",n)}};var j=function(m){var o=l.get("photos")||[];for(var n=0;n<o.length;n++){if(o[n].id&&o[n].id==m.get("id")||(o[n].stamp&&o[n].stamp==m.get("stamp"))){o[n]=m.toJSON();l.trigger("change:photos");break}}};if(d){var h=function(m){if(f){j(m)}else{e(m);if(window.console){console.log("Add photo",b,d);console.error("Exception: Should not come here.")}}l.autoSetMainPhoto();k&&k(m)};var i=function(m,n){m.set("error",n);j(m);g&&g(m,n)};if(this.isNew()){this._tempPhotos[b]=c;h(c)}else{this.addPhotoMembership(c,h,i)}}else{if(!f){e(c)}else{j(c)}}},addPhotos:function(c){for(var b=0;b<c.length;b++){this.addPhoto(c[b])}},removePhoto:function(d,i,c){var b=this,h=this.get("photo"),g;var e=function(){var l=b.get("photos");for(var k=0;k<l.length;k++){if(l[k].id&&l[k].id==d.get("id")||(l.stamp&&l.stamp==d.get("stamp"))){l.splice(k,1);b.set("photos",l);b.trigger("change:photos");break}}if(h.id==d.get("id")){b.set("photo",null);b.trigger("change:photo")}};var f=function(m,j){var l=function(o,n){d.destroy({success:function(){b._tempPhotos&&b._tempPhotos[d.get("stamp")]&&delete b._tempPhotos[d.get("stamp")];e();b.autoSetMainPhoto();o&&o(d)},error:function(p,r){var q=fiuzu.utils.getXhrErrorMessage(r);n&&n(d,q)}})};if(d.isNew()){l(m,j)}else{var k=function(n){l(m,j)};b.removePhotoMembership(d,k,j)}};if(h&&d.get("id")==h.id){if(b.isNew()){f(i,c)}else{this.save({photo:null},{patch:true,error:function(j,k){c&&c(d,"Cannot delete main photo")},success:function(){f(i,c)}})}}else{f(i,c)}},removePhotos:function(c){for(var b=0;b<c.length;b++){this.removePhoto(c[b])}},removeTempPhotos:function(){var b=this.get("photos")||[];_.each(b,function(c){if(c.save_photo===true){var d=new a.Photo({id:c.id});d.destroy({error:function(e,f){}})}})},changePhotoSrc:function(b){var c=b.find("img[data-src]").not(".unveil-loaded").not(".unveil-loading");c.unveil({})},extend:function(b){b._tempPhotos={};b.addPhotos=a.PhotosBaseModel.addPhotos;b.removePhotos=a.PhotosBaseModel.removePhotos;b.addPhotoMembership=a.PhotosBaseModel.addPhotoMembership;b.removePhotoMembership=a.PhotosBaseModel.removePhotoMembership;b.getPhoto=a.PhotosBaseModel.getPhoto;b.removePhoto=a.PhotosBaseModel.removePhoto;b.addPhoto=a.PhotosBaseModel.addPhoto;b.setMainPhoto=a.PhotosBaseModel.setMainPhoto;b.generateUniqueStamp=a.PhotosBaseModel.generateUniqueStamp;b.selectMainPhoto=a.PhotosBaseModel.selectMainPhoto;b.autoSetMainPhoto=a.PhotosBaseModel.autoSetMainPhoto;b.removeTempPhotos=a.PhotosBaseModel.removeTempPhotos;b.changePhotoSrc=a.PhotosBaseModel.changePhotoSrc;return b}};a.City=Backbone.Model.extend({urlRoot:"/api/city/",parse:a.BaseModel.parse});a.Photo=Backbone.Model.extend({urlRoot:"/api/photo/",defaults:{lat:0,lng:0,user:null,author:"",source_page_url:"",source_image_url:"",save_photo:true},destroy:function(b){var c=b;return Backbone.Model.prototype.destroy.call(this,c)}});a.Newsletter=Backbone.Model.extend({urlRoot:"/api/newsletter/",defaults:{source:1,is_subscribed:1}});a.PlanPermission=Backbone.Model.extend({constructor:function(b,c){if(b){b.emails&&(this.emails=b.emails);b.plan_id&&(this.plan_id=b.plan_id)}Backbone.Model.prototype.constructor.call(this,b);this.urlRoot=this.url()},url:function(){return"/api/plan/"+this.plan_id+"/share-permission"},destroy:function(c){var b=this;$.ajax({url:this.url(),data:JSON.stringify(b.toJSON()),dataType:"json",contentType:"application/json",type:"DELETE",success:function(d){c&&c.success&&c.success(b,d)},error:function(d){c&&c.error&&c.error(b,d)}})}});a.PlanPermissionCollection=Backbone.Collection.extend({model:a.PlanPermission});a.PhotoMembership=Backbone.Model.extend({urlRoot:"/api/photomembership/",defaults:{content_type:0,object:0,photo:0}});a.Comment=Backbone.Model.extend({urlRoot:"/api/comment/"});a.Vote=Backbone.Model.extend({urlRoot:"/api/vote/"});a.Note=Backbone.Model.extend({urlRoot:"/api/note/"});a.ReportError=Backbone.Model.extend({urlRoot:"/api/reporterror/"});a.Follow=Backbone.Model.extend({urlRoot:"/api/follow/"});a.NoteCollection=Backbone.Collection.extend({model:a.Note});a.Quotation=Backbone.Model.extend({urlRoot:"/api/quotation/",constructor:function(b,c){Backbone.Model.prototype.constructor.call(this,b);this.initStatusDisplay()},set:a.BaseModel.set,initStatusDisplay:function(){if(this.get("status")==1){this.set("status_display","Replied")}else{this.set("status_display","Unread")}},parse:a.BaseModel.parse});a.Offer=Backbone.Model.extend({constructor:function(b,c){Backbone.Model.prototype.constructor.call(this,b);this.initStatusDisplay()},set:a.BaseModel.set,initStatusDisplay:function(){if(this.get("status")==1){this.set("status_display","Replied")}else{this.set("status_display","Unread")}},parse:a.BaseModel.parse});a.Service=Backbone.Model.extend({defaults:{service:null,object_id:null,city_id:null,num_adult:null,num_child:null,date_start:null,date_end:null,valid_from:null,valid_to:null,time_start:null,time_end:null,params:{}}});a.ServiceCollection=Backbone.Collection.extend({model:a.Service});a.ItineraryDay=Backbone.Model.extend({urlRoot:"/api/itineraryday/",constructor:function(c,d){var e=c.plan,b=c.day_path;delete c.plan;delete c.day_path;Backbone.Model.prototype.constructor.call(this,c);this.setup(e);this.initItems(b);this.listenTo(this._items,"add",this.summarize);this.listenTo(this._items,"remove",this.summarize);this.listenTo(this._items,"reset",this.summarize);this.on({"change:price":this._plan.summarize,"change:distance":this._plan.summarize,"change:day":this.updateMarkerIndex,change:function(){this._modified=true}})},set:a.BaseModel.set,defaults:{price:0,distance:0,score:0,plan_id:null},setup:function(c){c=c||this._plan;var b=c.get("id");if(b){this.get("plan")||this.set("plan",c.id)}this._plan=c},save:function(e,c){var b=this;var d=c?c.success:null;c=c||{};c.wait=true;c.success=function(f,g){b.saveItems();d&&d(f,g);b.needSave=false};c.error=function(g,f){!b._retrySave&&f&&f.responseJSON&&f.responseJSON.detail&&f.responseJSON.detail.indexOf("IntegrityError")>=0&&b.save();b._retrySave=true};if(b.isNew()||b.hasChanged()||b._modified||(c&&c.patch)||(e&&e!={})){Backbone.Model.prototype.save.call(b,e,c)}else{b.saveItems();d&&d(b)}},saveItems:function(){var d=this;var c=d._items.models;for(var e=0,b=c.length;e<b;e++){c[e].isNew()&&c[e].setup(d._plan,d);c[e].save()}},initItems:function(f){var c=this;c._items=new a.ItineraryItemList();if(f){for(var e=0,b=f.length;e<b;e++){var d=f[e];d.itineraryDay=c;d.plan=c._plan;d.day=c.get("day");d.index=e+1;c._items.create(d,{initing:true})}c.getRouting()}},initItemPlaces:function(){for(var c=0,b=this._items.length;c<b;c++){var d=this._items.at(c);if(d.get("place")){d._place=new a.Place(d.get("place"));d._place._item=d;d.createMarker()}}},getPlacesArr:function(){var b=this.getItems(),c=[];var f=[];for(var e=0;e<b.length;e++){var g=this.getItems().at(e);if(g.get("place")&&g.get("place").category!=fiuzu.common.models.Place.category.CATEGORY_ABSTRACT_PLACE){c.push(g.get("place"))}else{if(g.get("place")){var d=g.get("place").id;if(f.indexOf(d)!=-1){c.push(g.get("place"))}f.push(d)}}}return c},getItems:function(){return this._items},getPlaces:function(){var b,c=[];for(var d=0;d<this._items.length;d++){b=this._items.at(d).getPlace();c.push(b)}return c},getServices:function(b){var o=this,m=new a.ServiceCollection([]);b=b||{};b.date_start=b.date_start||fiuzu.utils.getISOStringFromDate(this.getDate());b.date_start=b.date_start.substr(0,10);if(config.allowBooking){for(var h=0;h<this._items.length;h++){var c=this._items.at(h).getServices(b);if(c&&c.length){m.add(c.toJSON())}}}if(config.allowBooking&&this._items.length){var k=fiuzu.app.getPlan().get("city").id,d=this.getStartTime(),j=this.getEndTime();var e=new a.Service({service:"transfer_vehicle",object_id:null,city_id:k,num_adult:b.num_adult||1,num_child:b.num_child||0,date_start:b.date_start,date_end:b.date_end||b.date_start,time_start:d,time_end:j,distance:o.get("distance")||1,is_selected:true});var n=new a.Service({service:"tour_guide",object_id:null,city_id:k,num_adult:b.num_adult||1,num_child:b.num_child||0,date_start:b.date_start,date_end:b.date_end||b.date_start,time_start:d,time_end:j,is_selected:true});m.add(e);m.add(n)}var g=fiuzu.common.models.BOOKITEM_STATUS_AUTO_ADDED;var l=this.getPlan().getBookingItems().models;_.each(l,function(i){i.set("valid_from",i.get("valid_from").substring(0,10));i.set("valid_to",i.get("valid_to").substring(0,10))});var f=this.getPlan().getBookingItems().filter(function(i){return((i.get("status")==g)&&i.get("valid_from")==b.date_start)});_.each(f,function(i){if(i.get("item_type")==206){var q=i.toJSON(),p=q.params?q.params.places:null,r=new a.Service({service:"transfer_multi",object_id:null,city_id:k,num_adult:q.num_adult||b.num_adult||1,num_child:q.num_child||b.num_child||0,date_start:q.valid_from,date_end:q.valid_to||q.valid_from||b.date_start,time_start:d,places:p?p.join(","):null,time_end:j,is_selected:true});m.add(r)}});return m},getDate:function(){var b=this.getPlan().get("start_date"),d=new Date(),c=this.get("day")-1;if(b){d=new Date(b)}return new Date(d.getFullYear(),d.getMonth(),d.getDate()+c,0,0,0,0)},getStartTime:function(){if(this._items.length){return this._items.at(0).get("start_time")}return null},getEndTime:function(){if(this._items.length){return this._items.at(this._items.length-1).get("end_time")}return null},getPlan:function(){return this._plan},enableRouting:function(c){for(var d=0,b=this._items.length;d<b;d++){this._items.at(d).enableRouting(c)}},parse:a.BaseModel.parse,setDayNumber:function(c){for(var d=0,b=this._items.length;d<b;d++){this._items.at(d).set("day",c)}},addPlace:function(d,f,e,c,g){var j=this;g=g||false;f=f||a.ITI_ITEM_TYPE_NORMAL;var h={plan:j._plan,itineraryDay:j,place:d,index:e?e:j._items.models.length+1,day:j.get("day"),type:f,price:d&&d.price?d.price:0};var i=new a.ItineraryItem(h);var b=j.scheduleForNewItem(i,h.index);if(b.success){var i=j.addItem(i,h.index,g);if(h.index>=2){var i=j.getItems().at(h.index-1);i.optimizeTransport()}}else{fiuzu.app.alert("Not enough time",b.message)}return i},getIndexByTime:function(e,d){var b=1,d=d||-1;for(var c=0;c<this._items.length;c++){if(e>=this._items.at(c).get("start_time")){b+=1}else{break}}if(d<b){b-=1}return b},indexOfPlace:function(e,d,f){for(var c=0;c<this._items.length;c++){var b=this._items.at(c).get("place");if(b&&((e&&b.id==e)||(d&&b.geo_id==d))){if(f){if(b.is_event){return c}}else{return c}}}return-1},refresh:function(){this.orderItems();this.getRouting();this._items.each(function(b){b.refresh()})},updateMarkerIndex:function(){var b=this.get("day");this._items.each(function(f,e){if(f._place&&f._place.marker){var g={};var d=f._place.marker.classes;for(var c in d){if(c.indexOf("itinerary_day_")<0){g[c]=d[c]}}g["itinerary_day_"+b]=1;f._place.marker.classes=g}f.set("day",b);f.refresh()})},orderItems:function(){this._items.each(function(c,b){if(!c.get("index")||c.get("index")!==b+1){c.set("index",b+1);c._place&&c._place.marker&&c._place.marker.label;c.trigger("change")}})},addItem:function(j,g,i){i=i||false;g=g?g:this._items.length+1;j.set("day",this.get("day"));var d=0;var f=fiuzu.app.getPlan().getItinerary().at(this.get("day")-1)._items;var e=j.get("start_time");var b=j.get("end_time");if(e==="00:00"){j.set("start_time","08:00")}if(b==="00:00"){j.set("end_time","23:00")}_.each(f.models,function(k){if(k._place&&j._place){if(k._place.id===j._place.id&&d===0){d=1;alert("This place existed in day "+j.get("day")+"!","Warning")}}});j._timeUpdatedCount=1;j._place._item=j;var h=fiuzu.utils.getUniqueId();var c=fiuzu.app.map.createPlaceMarker(j._place,"itineraryitem_"+h,"itinerary_day_"+this.get("day"),i);j._place.marker=c;if(j._place&&j._place.get("is_event")){j.set("event_id",j._place.get("id"))}this._items.add(j,{at:g-1});this.refresh();fiuzu.app.alert("New item added !",j.get("place").name+" has been added to Day "+this.get("day")+".");return this},scheduleForNewItem:function(m,i){var b=120;var d=8;var h=m._place.toJSON();var e=d,g=(h.duration_moderate||b)/60,f=null,l=false,i=i||1;if(i>1){var k=this._items.at(i-2),c=k.getPlace().toJSON();var j;if(k.get("duration")){j=fiuzu.datetime.time2num(k.get("duration"))}else{if(c&&c.duration_moderate){j=c.duration_moderate/60;k.set("duration",fiuzu.datetime.num2time(j));k.set("end_time",fiuzu.datetime.addtime(k.get("start_time"),j))}else{j=b/60;k.set("duration",fiuzu.datetime.num2time(j));k.set("end_time",fiuzu.datetime.addtime(k.get("start_time"),j))}}e=fiuzu.datetime.time2num(k.get("start_time"))+j}else{if(h&&m._place.isWork24h()){e=d}else{e=fiuzu.datetime.time2num(h.opening_time)}}if(e<(24-g)){m.set("duration",fiuzu.datetime.num2time(g),{silent:true});m.set("duration_value",g,{silent:true});m.set("start_time",fiuzu.datetime.num2time(e),{silent:true});m.set("end_time",fiuzu.datetime.num2time(e+g),{silent:true});l=true}else{l=false;f="You cannot add more attraction to this day."}return{success:l,message:f,item:m}},moveItem:function(c,f,d,g){var j=this;var h=j.getPlan().getItinerary().at(c-1);var e=(d===c)?h:j.getPlan().getItinerary().at(d-1);var i=h.getItems().at(f-1);h.getItems().remove(i,{silent:true});if(h!=e){h.refresh();h.summarize()}if(i){var b=i.prev();i.set("itinerary_day",e.get("id"));i.set("index",g);i.set("day",d);i.setup(i._plan,e);i.refresh();i.trigger("change");e.getItems().add(i,{at:g-1,silent:true});e.refresh();e.summarize();if(b){b.optimizeTransport();b.refreshRouting()}i.optimizeTransport();i.refreshRouting()}fiuzu.app&&fiuzu.app.map.refresh();fiuzu.app.map.updateMarkers();return j},removeItem:function(k,h){var j=false,c=null;var b=this._items.models;var d=null;if(!h){for(var g=0,e=b.length;g<e;g++){if(b[g]==k){h=g+1;this._items.remove(this._items.at(g));k._place&&k._place.marker&&k._place.marker.destroy();d=k.prev();k.destroy();break}}}else{k=this._items.at(h-1);if(k){this._items.remove(k);k._place&&k._place.marker&&k._place.marker.destroy();d=k.prev();k.destroy()}}this.orderItems();if(d){d.optimizeTransport();d.refreshRouting()}this.refresh();j=true;var f=k.get("place");fiuzu.app.alert("Removed !",(f?f.name:"The item")+" has been removed from Day "+this.get("day")+".");return{success:j,message:c}},getRouting:function(d){var g,f,e=this._plan.currentDay,b=(this.get("day")==e);d=d||{};d.show=b;if(this._items){for(var c=0;c<this._items.length-1;c++){g=f||this._items.at(c).get("place");f=this._items.at(c+1).get("place");fiuzu.app&&fiuzu.app.map.getRouting(this._items.at(c),g,f,d)}}},summarize:function(){var g=0,b=0,d=0,e=0,c=[];if(this._items){for(var f=0,h=this._items.length;f<h;f++){var j="USD";var m=this._items.at(f);g=m.get("price")||0;if(m.get("place")){var k=m.get("place").category,l=m.get("place").id;if(k==a.Place.category.CATEGORY_HOTEL){if(c.indexOf(l)<0){g=m.get("place").price||0;c.push(l)}else{g=0}}else{g=m.get("place").price||0}j=m.get("place").currency||"USD"}if(this._items.at(f).get("event")){g=m.get("event").price||0;j=m.get("event").currency||"USD"}if(j!="USD"){g/=fiuzu.utils.getXRate("USD",j)}b=0;if(config.partner!="albatross"){b=this._items.at(f).get("route_cost")||0}e+=g+b;d+=this._items.at(f).get("route_distance")||0}}this.set("price",e);this.set("distance",d);this._plan.summarize()},empty:function(){var b=this;if(this._items){while(this._items.length){b.removeItem(this._items.at(0),1)}}},serialize:function(){var c=this.toJSON(),b=[];if(this._items&&this._items.length){b=this._items.toJSON()}_.each(b,function(e,d){if(e.place&&e.place.item){delete e.place.item}});c.day_path=b;return c},getHotel:function(){var b=this,d=null,c=a.Place.category.CATEGORY_HOTEL;this.getItems().each(function(e){if(e._place){if(e._place.get("category")==c||e.get("type")==a.ITI_ITEM_TYPE_ACCOMMONDATION){d=e._place;return d}}});return d},setHotel:function(g,b){var h=this.getHotel();if(h&&!b){this.getItems().each(function(i){if(i.get("type")==a.ITI_ITEM_TYPE_ACCOMMONDATION){i.set("state",1);i.setPlace(g)}})}else{var e=false,d=a.Place.category.CATEGORY_ABSTRACT_PLACE;this.getItems().each(function(i){if(i._place&&i._place.get("category")==d){i.setPlace(g);i.set("type",a.ITI_ITEM_TYPE_ACCOMMONDATION);e=true}});if(!e){var c=g.toJSON();var f=this.addPlace(c,a.ITI_ITEM_TYPE_ACCOMMONDATION);f&&f.set("state",1)}}fiuzu.app.alert(g.get("name"),"has been set accommondation place of day "+this.get("day"))},selectHotel:function(d){var e=this.getHotel(),b=this;if(e){var c="<strong>"+e.get("name")+"</strong> currently is your accommondation place in Day "+b.get("day")+". Do you want to replace by or append <strong>"+d.get("name")+"</strong> ?";fiuzu.confirm({title:"Set hotel",message:c,buttons:[{id:"append",title:"Add",callback:function(){b.setHotel(d,true)},close:true,primary:true},{id:"replace",title:"Replace",callback:function(){b.setHotel(d)},close:true}]})}else{var c="Do you want to set <strong>"+d.get("name")+'</strong> accommondation place for all of days in the itinerary ?<div class="fui-row-full top-buffer"><span class="text-muted"><i class="icomoon-icon-info text-info-2"></i>Hotel will be put at the end of a day.</span></div>';if(b._plan.getItinerary().length>1){fiuzu.confirm({title:"Set hotel",message:c,buttons:[{id:"one",title:"Only day "+b.get("day"),callback:function(){b.setHotel(d)},close:true,primary:true},{id:"all",title:"All days",callback:function(){b._plan.getItinerary().each(function(f){f.setHotel(d)})},close:true}]})}else{b.setHotel(d)}}},selectAddPlace:function(e,g,b,d){var f=this;var h="Add";if(b){h="Move"}var c=new fiuzu.main.views.AddMoveItemView(f._plan,h,{callback:function(i,k,l,n){var l=l||a.ITI_ITEM_TYPE_NORMAL;if(b){d.moveItem(b.oldDay,b.oldIndex,b.newDay,k);var j=d.view;var m=fiuzu.app.getPlan().getItinerary().at(b.newDay-1).view;j.initItemViews();j.render();m.initItemViews();m.render()}else{f._plan.getItinerary().at(i-1).addPlace(e.toJSON(),l,k,n)}},place:e.toJSON(),day:g});c.show()},resetAllowShilf:function(){var b=this;b._items.each(function(c){c.set("allow_shilf",false,{silent:true})})}});a.ItineraryItem=Backbone.Model.extend({DEFAULT_DURATION:2,modelName:"itineraryitem",urlRoot:"/api/itineraryitem/",constructor:function(d,f){var c=this;var h=d.plan,e=d.itineraryDay,b=d.place;delete d.plan;delete d.itineraryDay;if(d.event&&!d.place){d.place=d.event}Backbone.Model.prototype.constructor.call(this,d);this.setup(h,e);this.initPlace(b);this.set("photos",d.photos||[]);if(fiuzu.main.models&&fiuzu.main.models.Todos){this.todos=new fiuzu.main.models.Todos(d.notes);this.todos.each(function(i){if(!i.get("object_id")){i.set("type","itineraryitem");c.get("id")&&i.set("object_id",c.get("id"))}})}this.on({"change:route_cost":this._itiDay.summarize,"change:route_distance":this._itiDay.summarize,"change:price":this._itiDay.summarize,"change:total_cost":this._itiDay.summarize});this.on({"change:start_time":function(){this.set("start_time_value",fiuzu.datetime.time2num(this.get("start_time")))},"change:end_time":function(){this.set("end_time_value",fiuzu.datetime.time2num(this.get("end_time")))},"change:duration":function(){this.set("duration_value",fiuzu.datetime.time2num(this.get("duration")))}});this.on({change:function(){this._modified=true}});this.set("DEFAULT_DURATION",this.DEFAULT_DURATION);if(this.get("start_time")&&this.get("end_time")){var g=fiuzu.datetime.timediff(this.get("start_time"),this.get("end_time"));if(g<=0){g=1;this.set("end_time",fiuzu.datetime.addtime(this.get("start_time"),fiuzu.datetime.num2time(g)))}this.set("duration",fiuzu.datetime.num2time(g));this.trigger("change")}a.PhotosBaseModel.extend(this)},set:a.BaseModel.set,defaults:{plan:null,itinerary_day:null,place_id:null,route:null,name:null,description:null,start_time:null,end_time:null,photo:null,route_duration:0,route_distance:0,route_cost:0,route_mode:1,total_cost:0,day:0,index:0,notes:null,photos:[]},setup:function(e,b){e=e||this._plan;b=b||this._itiDay;var d=e.get("id");var c=b.get("id");if(d&&c){this.get("plan")||this.set("plan",d);this.get("itinerary_day")||this.set("itinerary_day",c)}this._plan=e;this._itiDay=b;this._timeUpdatedCount=0},refresh:function(){if(this._place&&this._place.marker){this._place.marker.classes={};this._place.marker.classes["itinerary_day_"+this.get("day")]=1;if(!fiuzu.session.isMobile){this._place.marker.label&&this._place.marker.label.draw();if(this.get("day")==this._plan.currentDay){this._place.marker.show()}}}fiuzu.app&&fiuzu.app.map.refresh();fiuzu.app.map.updateMarkers()},clean:function(){var b=this.attributes;if(b.place&&b.place.id){this._place=this._place||this.initPlace(b.place);b.place=b.place.id}this.attributes=b},getTitle:function(){return this.get("place")?this.get("place").name:"Activity #"+this.get("index")},enableRouting:function(c){var d=(c&&!config.partner)?fiuzu.app.map.map:null,b=this._itiDay.get("day");if(this._routing&&this._routing.display){this._routing.display.setMap(d)}},freeRouting:function(){this.enableRouting(false);this._routing=null;this.set("route_distance",0);this.set("route_duration",0);this.set("route_cost",0)},refreshRouting:function(i){var b=this,c=b.next();if(c&&b.get("place")&&c.get("place")){var h=b.get("place"),g=c.get("place");var f=b._itiDay._plan.currentDay;var d={mode:b.get("route_mode"),show:(b.get("day")==f)};fiuzu.app&&fiuzu.app.map.getRouting(b,h,g,d)}else{b.freeRouting()}},optimizeTransport:function(d,g){var e,j;var k=this,c=k.next(),b=k.prev();if(!e&&b&&b._place&&k&&k._place){var i=b._place.toJSON(),h=k._place.toJSON();e=fiuzu.geo.besttransport(i,h)}if(e&&e==fiuzu.common.models.ROUTE_MODE_WALKING&&b){b.set("route_mode",e,{silent:true});b.refreshRouting()}if(e&&b){b.set("route_mode",e);b.refreshRouting()}if(!j&&c&&c._place&&k&&k._place){var f=c._place.toJSON(),h=k._place.toJSON();j=fiuzu.geo.besttransport(f,h)}if(j&&j==fiuzu.common.models.ROUTE_MODE_WALKING&&k){k.set("route_mode",j,{silent:true});k.refreshRouting()}},changeRouteMode:function(){this.refreshRouting()},scheduleItems:function(b){var d=fiuzu.app.getPlan();var c=d.getItinerary().at(b-1).getItems();_.each(c.models,function(h,f){var g=h.get("start_time");var j=h.get("duration");var i=fiuzu.datetime.time2num(g);var l=fiuzu.datetime.time2num(j);var k=i+l;var e=fiuzu.datetime.num2time(k);h.set("end_time",e);console.log(e)})},validateTimming:function(){var c=0.1;var f=fiuzu.datetime,g=this,b=f.time2num(g.get("duration"));if(g){var e=f.addtime(g.get("start_time"),f.num2time(g.get("route_duration")));var d=f.timediff(e,g.next().get("start_time"));if(d>0){var h=Math.abs(d-b);if(h<=c){d=b}}else{d=0}if(d!=b){g.set("duration",fiuzu.datetime.num2time(d),{silent:true});g.set("duration_value",d);g.trigger("change")}}},hasEnoughTime:function(){var g=this,d=g.next(),b,c=fiuzu.datetime;var f=g.get("place");if(d){var h=d.get("place");if(h&&f){b=fiuzu.geo.estimatetime(f,h)}else{b=0}var e=c.addtime(g.get("start_time"),g.get("duration"));e=c.addtime(e,c.num2time(b));if(c.time2num(d.get("start_time"))<c.time2num(e)){return false}}return true},updateTime:function(k){var m=this,h,g,d=fiuzu.datetime;var b=function(){var o=m.next();while(o){if(o.get("time_locked")){return true}o=o.next()}var p=m.prev();while(p){if(p.get("time_locked")){return true}p=p.prev()}return false};var f=function(q){var w=m,p=w.next();if(q){var s=d.addtime(w.get("start_time"),w.get("duration")),t=Math.round(((w.get("route_duration")||0)+1/8)*4)/4;s=d.addtime(s,d.num2time(t));var v=d.timediff(p.get("start_time"),s);while(w&&v&&w.next()){p=w.next();var o=d.num2time(d.time2num(p.get("start_time"))+v),u=d.addtime(p.get("start_time"),p.get("duration"));p.set("start_time",o,{silent:true});p.set("end_time",u,{silent:true});p.trigger("change");w=p;if(w.next()){s=d.addtime(w.get("start_time"),w.get("duration"));t=Math.round(((w.get("route_duration")||0)+1/8)*4)/4,s=d.addtime(s,d.num2time(t));v=d.timediff(w.next().get("start_time"),s)}}}else{w.validateTimming()}var r=m.prev();if(r){r.validateTimming()}};if(k=="start_time"){var l=m._itiDay.getIndexByTime(m.get("start_time"),m.get("index"));if(l!=m.get("index")){m._itiDay.moveItem(m.get("day"),m.get("index"),m.get("day"),l);m.trigger("change:position");var j=m,c;while(j&&j.next()){c=j.next();c.set("index",j.get("index")+1,{silent:true});c.trigger("change");j=c}}}h=this.next();g=this.prev();if(h){if(!m.hasEnoughTime()){if(b()&&!((m.get("allow_shilf")||(g&&g.get("allow_shilf"))))){var n=m.get("place")?m.get("place").name:"Item #"+m.get("index"),e=h.get("place")?h.get("place").name:"Item #"+h.get("index");var i=k=="route_duration"?"Transportation time from <b>"+n+"</b> to <b>"+e+"</b> is <b>"+d.num2text(m.get("route_duration"))+"</b>.":"Starting time of <b>"+n+"</b> has been changed.";fiuzu.confirm({title:"Update time of following items",message:i+"<br/>Do you want to change the time of following activity based on this change accordingly?",buttons:[{id:"yes",title:"Shift following items",description:"Change the starting time of following activities & Keep the duration of this activities accordingly.",callback:function(){f(true);m.set("allow_shilf",true);g&&g.set("allow_shilf",true)},close:true,primary:true},{id:"no",title:"Keep",description:"Keep the starting time of following activities & Change the duration of this activities accordingly.",callback:function(){f(false)},close:true}]})}else{f(true)}}else{if(k=="duration"&&!b()){f(true)}if(k=="start_time"){g&&g.validateTimming()}}}if(g){if(k=="duration"&&!b()){f(true)}if(k=="start_time"){g&&g.validateTimming()}}this.scheduleItems(this.get("day"))},destroy:function(){var b=this.prev();this.removeMarker();this.freeRouting();Backbone.Model.prototype.destroy.call(this);b&&b.refreshRouting()},toggleState:function(e){var b=this,c=this.get("state")||0,d=Math.abs(c-1);this.set("state",d);if(this.isNew()){e&&e(d)}else{this.save({state:d,day:b.get("day"),index:b.get("index"),start_time:b.get("start_time"),end_time:b.get("end_time")},{patch:true,success:function(f,g){b.trigger("change");e&&e(d)}})}},save:function(g,c){if(c&&c.initing){return}var b=this;b.set("plan",this._plan.get("id"));var f=c?c.success:null;c=c||{};c.wait=true;if(!(c&&c.silent===false)){c.silent=true}var e=b.get("place"),d=false;if(b._place&&b._place.get("is_event")){d=true;b._event=b._place;b.set("event",e.id,{silent:true});b.set("place",null,{silent:true})}c.success=function(i,h){if(b._place){b.set("place",b._place.toJSON(),{silent:true})}f&&f(i,h);b.saveNotes();if(b._tempPhotos&&b._tempPhotos!={}){$.each(b._tempPhotos,function(j,k){b.addPhotoMembership(k);delete(b._tempPhotos[k.get("id")])});b._tempPhotos=null}if(d){b.set("place",e,{silent:true})}b.needSave=false};if(this.isNew()||this.hasChanged()||this._modified||(c&&c.patch)||(g&&g!={})){this.clean();Backbone.Model.prototype.save.call(this,g,c)}else{f&&f(this);b.saveNotes()}if(b._place){b.set("place",b._place.toJSON(),{silent:true})}},saveNotes:function(){var b=this;this.todos&&this.todos.each(function(c){if(!c.get("object_id")){c.set("type","itineraryitem");c.set("object_id",b.get("id"))}c.save()})},initPlace:function(b){if(b){b.item=this;this._place=new a.Place(b)}},getNotes:function(){return this.todos},getIndex:function(){return this.get("index")-1},getPlace:function(){return this._place},getItineraryDay:function(){return this._itiDay},getPlan:function(){return this._plan},setPhoto:function(c,d){var b=this;if(c){if(this.isNew()){this.set("photo",c.toJSON());this.set("photo_id",c.get("id"))}else{this.save({photo:c.toJSON(),photo_id:c.get("id")},{patch:true,silent:false,success:function(){b.trigger("change");d&&d()}})}}else{this.set("photo",null);this.set("photo_id",null);d&&d()}this._photo=c},setPlace:function(b,h){var g=b?b.toJSON():null;this._place=b;this._place.replaceMarker=h;this.set("place",g);if(b){this._place._item=this;this.set("place_id",g.id)}this.createMarker();var e=this.prev(),c=this.next();if(b){var f=this._itiDay._plan.currentDay;var d={show:(this.get("day")==f)};if(e&&e.get("place")){fiuzu.app.map.getRouting(e,e.get("place"),g,d)}if(c&&c.get("place")){fiuzu.app.map.getRouting(this,g,c.get("place"),d)}}else{if(e){e.setRouting({},false)}if(c){c.setRouting({},false)}}this.refresh()},setRoute:function(b){if(b){this.set("route_id",b.get("id"))}else{this.enableRouting(false)}this._route=b},setRouting:function(h,d,e){this._timeUpdatedCount++;if(this._timeUpdatedCount<=1){this.set("routed",true);this.set("has_route",d);this.set("has_onmap",e);this._itiDay.summarize();return 0}var g=this.get("route_duration");if(h&&h.route_mode){this.set("route_mode",h.route_mode)}d=!(d===false);e=!(e===false);this.set("has_route",d);this.set("has_onmap",e);if(d){var c=0,f=this.get("place")?this.get("place").price:0;this.set("route_duration",h.route_duration);this.set("route_distance",h.route_distance);if(h.route_cost){c=h.route_cost}else{if(this.get("route_mode")==1){c=h.route_distance*(fiuzu.app?(fiuzu.app.city.taxi_fare_per_km||1):(window.city.taxi_fare_per_km||1))}}f+=c;this.set("route_cost",c);this.set("total_cost",f)}else{this.setRoute(null)}var b=1/12;if(!g||(h&&h.route_duration&&Math.abs(g-h.route_duration)>=b)){this.updateTime("route_duration")}this.set("routed",true);this._itiDay.summarize()},createMarker:function(c){var d=this;if(d._place){if(d._place.marker){d._place.marker.destroy()}d._place._item=d;var c=c||d.get("index")?d.get("index")-1:0;var e=d._itiDay.get("day")+"_"+c;var b=fiuzu.app.map.createPlaceMarker(d._place,"itineraryitem_"+e,"itinerary_day_"+d.get("day"),d._place.replaceMarker)}},hasValidTiming:function(){var b=this.toJSON();if(b.place){if(b.start_time<b.place.opening_time||b.start_time>b.place.closing_time&&!(b.place.opening_time=="00:00"||b.place.closing_time=="00:00")){return false}else{return true}}else{return true}},removeMarker:function(){this._place&&this._place.marker&&this._place.marker.destroy()},next:function(){return this._itiDay.getItems().at(this.getIndex()+1)},prev:function(){return this._itiDay.getItems().at(this.getIndex()-1)},getServices:function(f){var c=this.get("place"),e=new a.ServiceCollection([]);f=f||{};if(config.allowBooking&&c&&c.allow_booking){var d=a.Place.category;var h,g,i;g=c.id;i=c.city_id;if(c.category==d.CATEGORY_ATTRACTION){h="entrance_ticket"}else{if(c.category==d.CATEGORY_ACTIVITY){h="activity"}}if(h&&(h!="entrance_ticket"||(h=="entrance_ticket"&&config.BOOKING_ALLOW_TICKET))){var b=new a.Service({service:h,object_id:g,city_id:i,num_adult:f.num_adult||1,num_child:f.num_child||0,date_start:f.date_start,date_end:f.date_end||f.date_start,time_start:this.get("start_time"),time_end:this.get("end_time"),is_selected:true});e.add(b)}}return e},parse:a.BaseModel.parse});a.ItineraryItemList=Backbone.Collection.extend({model:a.ItineraryItem,calDistance:function(){return 0},calCost:function(){return 0}});a.ItineraryDayList=Backbone.Collection.extend({model:a.ItineraryDay,calDistance:function(){return 0},calCost:function(){return 0}});a.ServicePromotion=Backbone.Model.extend({_tempPhotos:{},modelName:"servicepromotion",urlRoot:"/api/servicepromotion/",constructor:function(b,d){var c=b.item;Backbone.Model.prototype.constructor.call(this,b);delete b.item;this.setup(c)},setup:function(b){this._item=b},getItineraryItem:function(){return this._item},parse:a.BaseModel.parse,save:function(c,d){var b=this;var e=d?d.success:null;d.wait=false;d=d||{};d.success=function(f,g){if(b._tempPhotos&&b._tempPhotos!={}){$.each(b._tempPhotos,function(h,i){b.addPhotoMembership(i);delete(b._tempPhotos[i.get("id")])});b._tempPhotos=null}e&&e(f,g)};Backbone.Model.prototype.save.call(this,c,d)},addPhotos:a.PhotosBaseModel.addPhotos,removePhotos:a.PhotosBaseModel.removePhotos,addPhotoMembership:a.PhotosBaseModel.addPhotoMembership,removePhotoMembership:a.PhotosBaseModel.removePhotoMembership});a.Place=Backbone.Model.extend({_tempPhotos:{},modelName:"place",urlRoot:"/api/place/",constructor:function(b,d){var c=b.item;Backbone.Model.prototype.constructor.call(this,b);delete b.item;this.setup(c);a.PhotosBaseModel.extend(this)},defaults:{duration_easy:60,duration_extreme:60,duration_moderate:60},setup:function(b){this._item=b},getItineraryItem:function(){return this._item},parse:a.BaseModel.parse,getCategoryDisplay:function(e){var c="attraction";var d=_.keys(a.Place.category);e=e||this.get("category");for(var b=0;b<d.length;b++){if(a.Place.category[d[b]]==e){return d[b].substring(9).toLowerCase()}}return c},save:function(c,d){var b=this;var e=d?d.success:null;d.wait=false;d=d||{};d.success=function(f,g){if(b._tempPhotos&&b._tempPhotos!={}){$.each(b._tempPhotos,function(h,i){b.addPhotoMembership(i);delete(b._tempPhotos[i.get("id")])});b._tempPhotos=null}e&&e(f,g)};Backbone.Model.prototype.save.call(this,c,d)},isWork24h:function(){var b=this.get("opening_time");var c=this.get("closing_time");if(b=="00:00"&&c=="00:00"){return true}if(b=="00:00"&&(fiuzu.datetime.time2num(c)-fiuzu.datetime.time2num(b))>23){return true}return false},createMarker:function(b,c){if(fiuzu.app.map){if(!this.marker){this.placeId=this.placeId||this.get("id")||this.get("geo_id")||(new Date()).getTime();this.markerId="place_"+this.placeId;this.marker=fiuzu.app.map.createPlaceMarker(this,this.markerId,b||"places",c)}}return this.marker}});a.Business=Backbone.Model.extend({modelName:"business",urlRoot:"/api/account/business/",constructor:function(b,d){var c=b.item;Backbone.Model.prototype.constructor.call(this,b);delete b.item;this.setup(c);a.PhotosBaseModel.extend(this)},setup:function(b){this._item=b},parse:a.BaseModel.parse,save:function(c,d){var b=this;var e=d?d.success:null;d.wait=false;d=d||{};d.success=function(f,g){if(b._tempPhotos&&b._tempPhotos!={}){$.each(b._tempPhotos,function(h,i){b.addPhotoMembership(i);delete(b._tempPhotos[i.get("id")])});b._tempPhotos=null}e&&e(f,g)};Backbone.Model.prototype.save.call(this,c,d)}});a.CarType=Backbone.Model.extend({modelName:"cartype",urlRoot:"/api/car-type/",constructor:function(b,c){Backbone.Model.prototype.constructor.call(this,b);a.PhotosBaseModel.extend(this)},parse:a.BaseModel.parse,save:function(c,d){var b=this;var e=d?d.success:null;d=d||{};d.wait=false;d.success=function(f,g){if(b._tempPhotos&&b._tempPhotos!={}){$.each(b._tempPhotos,function(h,i){b.addPhotoMembership(i);delete(b._tempPhotos[i.get("id")])});b._tempPhotos=null}e&&e(f,g)};Backbone.Model.prototype.save.call(this,c,d)}});a.ServiceTransfer=Backbone.Model.extend({modelName:"transfer",urlRoot:"/api/service/transfer/",constructor:function(b,c){Backbone.Model.prototype.constructor.call(this,b)},parse:a.BaseModel.parse,save:function(c,d){var b=this;var e=d?d.success:null;d=d||{};d.wait=false;d.success=function(f,g){e&&e(f,g)};Backbone.Model.prototype.save.call(this,c,d)},getMinPrice:function(){var d=0,c=this.get("prices");if(c&&c.length){for(var b=0;b<c.length;b++){if(d==0||c[b].price<d){d=c[b].price}}}this.set("min_price",d);return d}});a.ServiceTransferPrice=Backbone.Model.extend({modelName:"transferpricetable",urlRoot:"/api/service/transferprice/",parse:a.BaseModel.parse});a.Place.category={CATEGORY_UNCATEGORIZED:0,CATEGORY_ATTRACTION:1,CATEGORY_RESTAURANT:2,CATEGORY_NIGHTLIFE:3,CATEGORY_CURRENCY_EXCHANGE:4,CATEGORY_SHOPPING:5,CATEGORY_SHOPPING_GUIDE:6,CATEGORY_GETTING_THERE:7,CATEGORY_ACTIVITY:8,CATEGORY_REMOTE:9,CATEGORY_HOTEL:10,CATEGORY_PERSONAL:11,CATEGORY_ABSTRACT_PLACE:12,CATEGORY_GOOGLE:13,CATEGORY_SPA:14};a.PlaceCollection=Backbone.Collection.extend({model:a.Place});a.Restaurant=a.Place.extend({initialize:function(){this.set("category",a.Place.category.CATEGORY_RESTAURANT)}});a.Attraction=a.Place.extend({initialize:function(){this.set("category",a.Place.category.CATEGORY_ATTRACTION)}});a.PlaceManager=Backbone.Model.extend({_places:{},_categories:[],_runningXhr:null,_runningUrl:null,_categorySettings:null,_cachedXhrResults:[],_xhrFiuzuCategory:null,_xhrGoogleCategory:null,_xhrFiuzuResults:null,_xhrGoogleResults:null,_googleSearchCategories:["hotel"],initialize:function(){this.set("category","");this.set("search",{});this.set("state",null);this.set("current_user",null);this.fetchCategorySettings()},currentUser:function(b){this.set("current_user",b);this.fetchPlaces()},fetchCategorySettings:function(){var b=this;if(!b._categorySettings){$.ajax({url:"/api/place/category/",data:{city_id:fiuzu.app.city.id},async:false,cache:true,success:function(c){b._categorySettings=c}})}return b._categorySettings},fetchPlaces:function(d,p,n){this.emptyResults();this._xhrFiuzuCategory=null;this._xhrGoogleCategory=null;this._xhrFiuzuResults=null;this._xhrGoogleResults=null;this._xhrFiuzuDone=false;this._xhrGoogleDone=false;if(this.get("state")=="searching"||this._runningXhrGoogle||this._runningXhr){this.abort()}this.set("state","searching");var o=this;var d=d||this.get("category");var h=fiuzu.common.models.Place.category["CATEGORY_"+d.toUpperCase()];var i=[];if(h){i.push("&category="+h)}if(d=="personal"){if(fiuzu.session.user){i.push("&owner_id="+fiuzu.session.user.id)}else{this._fetchStop(d,p,[],n);return}}if(d=="wishlist"||d=="personal"){if(fiuzu.session.user){i.push("&wishlist_id="+fiuzu.session.user.id)}else{this._fetchStop(d,p,[],n);return}}if(p){this.set("results",null);for(var k in p){i.push("&"+k+"="+p[k])}}var c="/api/place/?city_id="+fiuzu.app.city.id+i.join("")+"&page_size=100";if(d=="event"){c="/api/event/?city_id="+fiuzu.app.city.id+i.join("")+"&page_size=100"}if(fiuzu.app.city.auto_planning_ready){if(c==this._runningUrl){this._fetchStop(d,p,this._cachedXhrResults,n)}else{if(this._runningXhr){this._runningXhr.abort();this._runningXhr=null}this._runningXhr=$.ajax({url:c,type:"GET",dataType:"json",cache:(d!="personal"),success:function(q){o._xhrFiuzuCategory=d;o._xhrFiuzuResults=q.results;if(o._xhrGoogleCategory==d&&o._xhrFiuzuResults&&!o._xhrFiuzuResults.length){o._fetchGoogleStop(d,p,o._xhrGoogleResults,n)}else{o._fetchStop(d,p,q.results,n)}o.setFiuzuSearchState(true)},error:function(){o.setFiuzuSearchState(true)}})}}else{this.setFiuzuSearchState(true)}var m=null,e=this,j=(o._googleSearchCategories.indexOf(d)>=0)||(!fiuzu.app.city.auto_planning_ready),g=p&&p.term&&p.term.length>3;if(j||g){if(this._runningXhrGoogle){this._runningXhrGoogle.abort();this._runningXhrGoogle=null}if(j){m=fiuzu.app.map.category[d.toUpperCase()]}if(g){m=null}var b=new google.maps.LatLng(fiuzu.app.city.lat,fiuzu.app.city.lng),f=p?p.term:null;var l=function(t){var r=[],q;for(var s=0;s<t.length;s++){q=fiuzu.app.map.getPlaceFromGoogleData(t[s]);r.push(q.toJSON())}if(!o._xhrFiuzuDone||(o._xhrFiuzuCategory==d&&o._xhrFiuzuResults&&o._xhrFiuzuResults.length)){e._xhrGoogleCategory=d;e._xhrGoogleResults=r}else{e._fetchGoogleStop(d,p,r,n)}o.setGoogleSearchState(true)};this._runningXhrGoogle=fiuzu.app.map.searchPlaces(b,f,m,l)}else{this.setGoogleSearchState(true)}},setFiuzuSearchState:function(){this._xhrFiuzuDone=true;if(this._xhrGoogleDone){this.set("state",null)}},setGoogleSearchState:function(){this._xhrGoogleDone=true;if(this._xhrFiuzuDone){this.set("state",null)}},getCategorySettings:function(){return this._categorySettings},_removeDuplicatedWatermarkOnMap:function(){var b=0;$("#map-canvas .gm-style-cc").each(function(){b+=1;if(b>2){$(this).remove()}})},_fetchGoogleStop:function(e,d,c,g){var b=(this._googleSearchCategories.indexOf(e)>=0)||(!fiuzu.app.city.auto_planning_ready);if(b||d){var f=new a.PlaceCollection(c);this.cachePlaces(f);this.set("results",f);this.set("category",e);g&&g(f)}this._removeDuplicatedWatermarkOnMap()},_fetchStop:function(d,c,b,f){var e=new a.PlaceCollection(b);this.set("results",e);this.set("category",d);this.cachePlaces(e,d);f&&f(e);this._removeDuplicatedWatermarkOnMap()},abort:function(){if(this._runningXhr){this._runningXhr.abort();this._runningXhr=null}if(this._runningXhrGoogle){this._runningXhrGoogle.abort();this._runningXhrGoogle=null}this.set("state",null)},getPlaces:function(b){if(b){return this._categories[b]}else{return this.get("results")}},changeOptions:function(e,d,f){this.app=fiuzu.app;var b=this,c=[];this.set("category",e);this.set("search",d);if(e!="new"&&e!="edit"){this.fetchPlaces(e,d,f)}},addPlace:function(b,h,e){var c=this;var g=b.get("id");e=e||false;if(e||!c._places[g]){c._places[g]=b}if(h){if(!c._categories[h]){c._categories[h]=[]}else{if(c._categories[h].length){var d=c._categories[h],j=false;for(var f=0;f<d.length;f++){if(d.at(f).get("id")==g){if(e){d.remove(d.at(f));d.add(b,{at:f})}j=true}}if(!j){d.add(b)}}}}},removePlace:function(b,f){var c=this._categories[f];var e=b.get("id");if(this._places[e]){delete this._places[e]}if(f&&c){for(var d=0;d<c.length;d++){if(c.at(d).get("id")==e){c.remove(c.at(d))}}}},getPlace:function(d,b){if(!this._places[d]||b){var c=new fiuzu.common.models.Place({id:d});c.fetch({wait:true,async:false});this._places[d]=c}return this._places[d]},emptyResults:function(){var b=this.get("results");b&&b.length&&b.each(function(c){c.marker&&c.marker.hide()});this.set("results",null)},cachePlaces:function(f,h){var c,e,d;if(!f){return}h=h?h+" all":"all";for(var g=0,b=f.length;g<b;g++){e=f.at(g);e.set("isDraggable",true);d=e.get("id")||e.get("geo_id");if(!this._places[d]){this._places[d]=e}if(!this._places[d].marker){c=this._places[d].createMarker(h);e.marker=c}}}});a.PhotoManager=Backbone.Model.extend({_tempPhotos:{},initialize:function(b){this.set("uploading",0);this.set("count_photos",0)},uploadNewPhoto:function(f,i,d){var e=this.generateUniqueStamp();if(f){var c=new a.Photo(),g=c.toJSON(),h=new FormData(),b=this;g.file=f;$.each(g,function(j,k){h.append(j,k)});$.ajax({url:"/api/photo/",type:"POST",data:h,cache:false,dataType:"json",processData:false,contentType:false,success:function(k,m,l){var j=new a.Photo(k);j.set("stamp",e);b._tempPhotos[e]=j;i&&i(j)},error:function(l){var k=fiuzu.utils.getXhrErrorMessage(l);var j=new a.Photo({error:k,stamp:e});b._tempPhotos[e]=j;d&&d(j,k)}})}else{}this._tempPhotos[e]=null;return e},clearTempPhotos:function(){this._tempPhotos={}},generateUniqueStamp:a.PhotosBaseModel.generateUniqueStamp});a.Plan=Backbone.Model.extend({urlRoot:"/api/plan/",modelName:"plan",constructor:function(d,e){var c=this,f=d.city,b=d.itinerary;Backbone.Model.prototype.constructor.call(c,d);delete d.city;delete d.itinerary;c.setup(f,b);a.PhotosBaseModel.extend(c)},set:a.BaseModel.set,defaults:{price:0,days:0,intensity:1,rating:0},initOnMap:function(b){for(var c=0;c<this._itinerary.length;c++){this._itinerary.at(c).initItemPlaces()}},clean:function(){var b=this.attributes;b.itinerary&&delete b.itinerary;b.city&&b.city.id&&(b.city=b.city.id);this.attributes=b},getPermissions:function(e,d){var b=this;if(!b.get("permissions")&&d){if(b.get("id")){var c="/api/plan/"+b.get("id")+"/share-permission";$.ajax({url:c,type:"GET",success:function(f){e&&e(new a.PlanPermissionCollection(f))}})}else{e&&e(new a.PlanPermissionCollection([]))}}else{e&&e(new a.PlanPermissionCollection(b.get("permissions")))}},getBookingItems:function(b){if(!this._bookingItems){this._bookingItems=new fiuzu.booking.models.BookingItemCollection(this.get("booking_items")||[])}return this._bookingItems},getPreBookingItems:function(b){if(!this._preBookingItems){this._preBookingItems=new fiuzu.booking.models.PreBookingItemCollection(this.get("booking_items")||[])}return this._preBookingItems},getServices:function(e){var d=new a.ServiceCollection([]);e=e||{};if(config.allowBooking&&this._itinerary.length){for(var c=0;c<this._itinerary.length;c++){var b=this._itinerary.at(c).getServices();if(b&&b.length){d.add(b.toJSON())}}}return d},setRandomAvatar:function(){var h=[],c=this.getItinerary().length?this.getItinerary().at(0).getItems():[],d=null,f,b,g;for(var e=0;e<c.length;e++){f=c.at(e).get("photos")||[];if(c.at(e).get("place")){b=c.at(e).get("place").photos;g=f.concat(b);h=h.concat(g)}}d=h[Math.floor(h.length*Math.random())];if(d){this.set("photo",d)}},save:function(c,d){var b=this,e=d?d.success:null;b.summarize();if(!b.get("photo")&&b.isNew()){b.setRandomAvatar()}this.set("is_temp",d?(d.is_temp||false):(this.get("is_temp")||false));b.clean();d=d||{};d.wait=true;d.success=function(f,g){b.saveItinerary();b.savePreBookingItems();b.saveAutoBookingItems();e&&e(f,g);b.needSave=false};if(b.isNew()||b.hasChanged()||b.needSave){Backbone.Model.prototype.save.call(b,c,d)}else{b.saveItinerary();b.saveAutoBookingItems();e&&e(b)}},saveTemp:function(b){var c=null;if(config.partnerConfig&&config.partnerConfig.id){c=config.partnerConfig.id}this.save({},{is_temp:true,error:function(){if(b&&b.error){b.error()}},success:function(d,e){if(b&&b.success){b.success(d,e)}}})},saveItinerary:function(){for(var c=0,b=this._itinerary.models.length;c<b;c++){if(this._itinerary.models[c].isNew()){this._itinerary.models[c].setup(this)}this._itinerary.models[c].save()}},saveAutoBookingItems:function(){var c=this,b=this.getBookingItems().filter(function(d){return(d.get("status")==fiuzu.common.models.BOOKITEM_STATUS_AUTO_ADDED)});_.each(b,function(d){d.set("plan",c.get("id"));d.set("currency",fiuzu.session.currency);d.save()})},savePreBookingItems:function(){if(this._preBookingItems&&this._preBookingItems.length&&this.get("id")){var b=this._preBookingItems.models;for(var c=0;c<b.length;c++){b[c].set("plan",this.get("id"));b[c].set("currency",fiuzu.session.currency);b[c].save()}}},setup:function(c,b){this._city=c;this.currentDay=1;this.setupItineraryDetail(b)},parse:a.BaseModel.parse,automatic:true,setStartDate:function(b){var c=new Date(b),e=this.get("days");var d=new Date(c.getFullYear(),c.getMonth(),c.getDate()+e-1,0,0,0,0);this.set("start_date",fiuzu.utils.getISOStringFromDate(c,"00:00:00"));this.set("end_date",fiuzu.utils.getISOStringFromDate(d,"00:00:00"))},setupItineraryDetail:function(b){this._itinerary=new a.ItineraryDayList();if(b){for(var f=0,c=b.length;f<c;f++){var e=b[f],g=(e.day!=f+1);e.plan=this;e.day=f+1;var d=new a.ItineraryDay(e);if(g){d.set("day",f+1,{silent:true})}this._itinerary.add(d)}}},getItinerary:function(){return this._itinerary},summarize:function(){var d=this;if(!d._itinerary){return}var f=0,g=0,c=null;for(var e=0,b=d._itinerary.length;e<b;e++){c=d._itinerary.at(e);f+=c.get("price");g+=c.get("distance")}d.set("price",f);d.set("distance",g)},summarizeReport:function(){var r={going:{name:"Flight / Bus / Train",icon:"icomoon-icon-airplane",items:[],link:"#getting-there/transportation"},hotel:{name:"Hotel / Accommondation",icon:"icomoon-icon-office",items:[],link:"#getting-there/accommondation"},transportation:{name:"Transportation",icon:"icomoon-icon-cars",items:[],link:"#plan/day/1"},meal:{name:"Eating out",icon:"icomoon-icon-food",items:[],link:"#explore/category/restaurant"},tour:{name:"Sightseeing entrance fee / Tour",icon:"icomoon-icon-man",items:[],link:"#explore/category/attraction"},miscellaneous:{name:"Other things",icon:"icomoon-icon-cart-2",items:[],link:"#getting-there/others"}};var d=this.get("city").name||this.get("city").get("name");if(this._itinerary&&this._itinerary.length){for(var t=0;t<this._itinerary.length;t++){for(var s=0;s<this._itinerary.at(t)._items.length;s++){var v=this._itinerary.at(t)._items.at(s).toJSON();if(v.price||(v.place&&v.place.price)){var u,f,q,m,c;if(v.place&&v.place.category==fiuzu.common.models.Place.CATEGORY_RESTAURANT){u="Meal at "+(v.name||v.place.name);f="Meal";m="meal"}else{u="Ticket for "+(v.name||v.place.name);f="Ticket";m="tour"}c=v.place?v.place.price_sell:v.price;r[m].items.push({name:u,link:"#plan/day/"+(t+1),single_value:c,quantity:1,unit:f,currency:"USD"})}var k=this.get("city").taxi_fare_per_km||this.get("city").get("taxi_fare_per_km");if(v.route_mode==1||v.route_mode==3||v.route_cost>0){var l="Taxi",h="icomoon-icon-cars";if(v.route_mode==3){l="Bus";h="icomoon-icon-bus"}if(v.route_mode==1){}var g=this._itinerary.at(t)._items.at(s+1);if(g){var o=g.toJSON();r.transportation.items.push({name:l+" from "+v.place.name+' <i class="icomoon-icon-arrow-right-5"></i> '+o.place.name,link:"#plan/day/"+(t+1),single_value:v.route_cost,quantity:1,unit:"Transfer",currency:"USD",icon:h})}}}}}var p=0;for(var e in r){var n=r[e].items,b=0;for(var t=0;t<n.length;t++){n[t].total_value=n[t].single_value*n[t].quantity;b+=n[t].total_value}r[e].totalValue=b;p+=b}r.totalValue=p;return r},addDay:function(){var c=new a.ItineraryDay({plan:this,day_path:null});this._itinerary=this._itinerary||new a.ItineraryDayList();var b=this._itinerary.length+1;c.set("day",b);this.set("days",b);fiuzu.app.navigate("#plan/day/"+b);this._itinerary.add(c);fiuzu.app.alert("New day added !","New day has been added to your plan !")},orderDays:function(){for(var b=0;b<this._itinerary.length;b++){this._itinerary.at(b).set("day",b+1);this._itinerary.at(b).setDayNumber(b+1)}},moveDay:function(c,d){if(this._itinerary&&this._itinerary.length>=c&&this._itinerary.length>=d){var b=this._itinerary.at(c-1);this._itinerary.remove(b,{silent:true});this._itinerary.add(b,{at:d-1,silent:true});this.orderDays();this._itinerary.each(function(e){e.refresh()});fiuzu.app.alert("Day moved !","Day "+c+" has been moved !");fiuzu.app.map.refresh();return true}},removeDay:function(f,d){if(this._itinerary&&(this._itinerary.length>=f||d)){var c=null;if(d){var g=this._itinerary.where({id:d});if(g&&g.length){c=g[0]}}else{c=this._itinerary.at(f-1)}if(c){if(this._itinerary.length>1){this.set("days",this._itinerary.length-1);this._itinerary.remove(c);this.destroyMarkerDay(c);c&&c.destroy();var b=this._itinerary.length;for(var e=0;e<b;e++){this._itinerary.at(e).set("day",e+1)}if(f>b){this.set("current_day",b)}else{this.trigger("change:current_day")}}else{this._itinerary.remove(c);this.destroyMarkerDay(c);c&&c.destroy();this.addDay()}this.summarize();fiuzu.app.alert("Day removed !","Day "+f+" has been removed from your plan !");return true}return false}},destroyMarkerDay:function(b){for(var c=0;c<b._items.models.length;c++){if(b._items.models[c]._place&&b._items.models[c]._place.marker){b._items.models[c]._place.marker.destroy();b._items.models[c].freeRouting()}}},serialize:function(){var d=this.toJSON(),b=[];if(this._itinerary&&this._itinerary.length){for(var c=0;c<this._itinerary.length;c++){b.push(this._itinerary.at(c).serialize())}}d.itinerary=b;return d},clone:function(c){var b="/api/plan/"+this.attributes.id+"/clone";console.log("models ",c.params);$.ajax({url:b,data:c.params,method:"POST",success:function(d){if(c.success){c.success(d.data)}},error:function(d){if(c.error){c.error($.parseJSON(d.responseText))}}})},getHotels:function(){var b=[];this.getItinerary().each(function(c){var d=c.getHotel();if(d){b.push(d)}});return b}});a.Authentication=function(){var b=this;b.user=null;b.doRegister=function(c){this.doLogin(c,true)};b.callbacks=[];b.fails=[];b.last=0;b.status=false;b.loadLogin=function(c){if(fiuzu.app&&fiuzu.app.currentCategory=="personal"){this.exploreRouter=fiuzu.app.module.explore;this.exploreRouter.manager.currentUser(c);console.log(fiuzu.app.currentCategory)}};b.doLogin=function(e,c,d){e=e||{};var f={classId:"modal-account-login",url:"/account/modal/login?partner="+(d?d:"")+"&reg="+(c?1:0),method:"GET",multiple:false,guest:true,callbacks:{success:function(g){e.success&&e.success();fiuzu.utils&&fiuzu.utils.renderUserLogin&&fiuzu.utils.renderUserLogin()},error:function(){e.error&&e.error()},close:function(){e.close&&e.close();$(".modal-backdrop").remove()}}};if(c){f.data=f.data||{};f.data.register=1}f.reload=true;fiuzu.utils.loadModal(f)};b.setStatus=function(c){b.status=c;b.last=Date.now();(!c)&&(fiuzu.session.user=null)};b.isAuthenticated=function(g,f,e){var d=false;if(!g){g=false}if(b.last&&(Date.now()-b.last>1000)){if(b.status){for(var c=0;c<b.callbacks.length;c++){b.callbacks[c]&&b.callbacks[c]()&&(b.callbacks[c]==null)}}else{for(var c=0;c<b.fails.length;c++){b.fails[c]&&b.fails[c]()&&(b.fails[c]==null)}}return}b.callbacks.push(f);b.fails.push(e);if(g&&b.xhr){return}b.xhr=$.ajax({url:"/api/account/login",dataType:"json",async:g,success:function(j){if(j.is_authenticated){d=true;b.setStatus(d);fiuzu.session.user=j.user;for(var h=0;h<b.callbacks.length;h++){b.callbacks[h]&&b.callbacks[h]()&&(b.callbacks[h]==null)}}b.xhr=null},error:function(){b.setStatus(false);for(var h=0;h<b.fails.length;h++){b.fails[h]&&b.fails[h]()&&(b.fails[h]==null)}b.xhr=null}});return d};b.checkAuthenticated=function(d,c){return b.isAuthenticated(true,d,c)};b.login=function(f,d){var e="/api/account/login",c=d||"json",g;if(d=="html"){e+="/html"}$.ajax({url:e,data:f,async:false,type:"POST",dataType:c,success:function(i){g=i;fiuzu.session.user=i.user;b.errors=null;b.setStatus(true);b.loadLogin(i);if(i.user){var k=$(".btn-booknow");var l=$(".btn-addtocart");var j=$(".obj-booktransfer");var h=$(".btn-cart");if(i.user.is_business){k.addClass("hidden");l.addClass("hidden");j.addClass("hidden");h.addClass("hidden");config.allowBooking=false}else{k.removeClass("hidden");l.removeClass("hidden");j.removeClass("hidden");h.removeClass("hidden");config.allowBooking=true}}},error:function(h){g=false;b.setStatus(false);if(h.responseText){var i;try{i=$.parseJSON(h.responseText);b.errors=i.error?[i.error]:null}catch(j){console.log(j)}}}});return g};b.register=function(f,d){var e="/api/account/register",c=d||"json",g;if(d=="html"){e+="/html"}$.ajax({url:e,data:f,async:false,type:"POST",dataType:c,success:function(h){fiuzu.session.user=h.account;b.loadLogin(h);g=h}});return g};b.loginFacebook=function(d,c){return b.login(d,c)};b.logout=function(){$.ajax({url:"/api/account/logout",async:false,success:function(c){b.setStatus(false);fiuzu.session.user=null}});return true}};fiuzu.common.decorator={loginRequired:function(c,b,g,f){var e=new a.Authentication(),d=true;e.isAuthenticated(d,function(){c(fiuzu.session.user)},function(){if(window.config&&window.config.partner){f=window.config.partner}e.doLogin({success:function(){c(fiuzu.session.user)},error:function(){b&&b()},close:function(){if(location.href.indexOf("#account/login")>=0){location.href="#account/logged"}else{if(fiuzu.app){if(fiuzu.app.lastFragment){fiuzu.app.navigate("#account/closed")}else{fiuzu.app.navigate("#plan")}}}g&&g()}},false,f)})},isAuth:function(b,d){var c=new a.Authentication();c.checkAuthenticated(b,d)}}}(fiuzu.common.models));window.fiuzu.common.views=window.fiuzu.common.views||{};fiuzu.common.views.TEMPLATE_DOMS={ItineraryItem:"#tpl-itinerary-item",ItineraryItemChangeTime:"#tpl-itinerary-item-change-time",mapBoxInfo:"#tpl-marker-box",toolBoxLib:"#attraction-controlbar-template",toolDayNavBar:"#day_navigator_template",figureLegendTool:"#figure_legend"};fiuzu.common.views.ModuleCommentView=Backbone.View.extend({_viewAll:false,_loadAll:false,initialize:function(a,b){this.$el=a;this.object={type:a.attr("data-type"),id:a.attr("data-id")};this._template=_.template(b.html(),null,{variable:"data"});this.$list=$(".comments",this.$el);this.$btnShowComment=$(".actions .btn-comment-all",this.$el);this.$iptComment=$(".ipt-comment",this.$el);this.$boxNew=$(".comment-new",this.$el);this.$numComment=$(".comment-count",this.$el);this._numComment=parseInt(this.$numComment.text())||0;this.comments=[];this.render()},events:{"click .btn-comment-all":"show","keypress .ipt-comment":"addComment","click .btn-comment-delete":"deleteComment","click .btn-edit":"editComment","click .btn-remove":"removeComment"},render:function(){this.delegateEvents()},show:function(){if(this._viewAll){this.collapse()}else{this.expand()}},expand:function(){this.$list.addClass("expanded");this.$btnShowComment.find("i.icon-expand").removeClass("icomoon-icon-arrow-down-2").addClass("icomoon-icon-arrow-up-2");this.$btnShowComment.find(".action").text("Hide");this._viewAll=true;this.$iptComment.focus()},collapse:function(){this.$list.removeClass("expanded");this.$btnShowComment.find("i.icon-expand").removeClass("icomoon-icon-arrow-up-2").addClass("icomoon-icon-arrow-down-2");this.$btnShowComment.find(".action").text("Show");this._viewAll=false},loadAll:function(){var a=this;if(!this._loadAll){var b="/api/comment/?object_id="+this.object.id+"&type="+this.object.type;$.ajax({url:b,async:false,success:function(c){a.comments=c.results}})}},addComment:function(c){var b=this.$iptComment.val(),a=this;if(c.which==13){if(b.trim()!=""){var d=new fiuzu.common.models.Comment({object:this.object.id,type:this.object.type,comment:this.$iptComment.val()});this.$iptComment.prop("disabled",true).addClass("disabled");d.save({},{wait:true,success:function(e,g){a._numComment++;var f=a._template(e.toJSON());$(f).insertBefore(a.$boxNew);a.$iptComment.val("").prop("disabled",false).removeClass("disabled");a.$numComment.text(a._numComment);a.expand()},error:function(){a.$iptComment.focus().prop("disabled",false).removeClass("disabled")}})}else{this.$iptComment.focus()}}},removeComment:function(d){var a=$(d.currentTarget),b=a.attr("data-id"),c=confirm("Are you confirm to delete this comment ?");if(b&&c){var g=$("#object-comment-"+b,this.$el);var f=new fiuzu.common.models.Comment({id:b});f.destroy({success:function(){g.remove()}})}}});fiuzu.common.views.PopoverViewSetupHideAllHandler=false;fiuzu.common.views.PopoverView=Backbone.View.extend({initialize:function(a){_.bindAll(this,"render","show","hide","toggle","destroy","remove","isShowing");this.offsetTop=30;this.offsetLeft=0;a=a||{};this.Header=a.header;this.Content=a.content;this.Placement=a.placement;this.Trigger=a.trigger;this.Delay=a.delay;this.UseHTML=a.html;this.HideOtherPopovers=a.hideOtherPopovers;this.ArrowStyle=a.arrowCSS;if(a.offsetTop&&$.isNumeric(a.offsetTop)){this.offsetTop+=a.offsetTop}if(a.offsetLeft&&$.isNumeric(a.offsetLeft)){this.offsetLeft+=a.offsetLeft}if(a.el){this.popoverElement=$(a.el)}},render:function(a){var b=this;if(!this.popoverElement){throw"PopoverView must be set into an element"}this.popoverElement.popover&&this.popoverElement.popover("destroy");this.popover=this.popoverElement.popover({title:this.Header,content:"",container:"body",placement:this.Placement||"left",trigger:this.Trigger||"click",delay:this.Delay||0,html:this.UseHTML}).on("show.bs.popover",function(c){if(b.HideOtherPopovers){b.hideAllPopOver(c)}if(!fiuzu.common.views.PopoverViewSetupHideAllHandler){$("body").on("click",function(d){b.hideAllPopOver(d)});fiuzu.common.views.PopoverViewSetupHideAllHandler=true}}).data("bs.popover");this.popover.view=this;this.popover.$tip=$(this.popover.tip());this.popover.getContent=function(){return b.Content||""};this.popover.getTitle=function(){return b.Header};this.popover._setContent=this.popover._setContent||this.popover.setContent;this.popover.setContent=function(){b.popover._setContent();$('<button type="button" class="close" data-dismiss="modal">×</button>').appendTo(b.popover.$tip.find(".popover-title")).one("click",b.hide);if(b.ArrowStyle){b.popover.$tip.find(".arrow").css(b.ArrowStyle)}};if(a===true){this.show()}return this},hideAllPopOver:function(a){$(this.HideOtherPopovers).not(a.target).each(function(){var b=$(this).data("bs.popover");if(b){$(this).popover("hide");if(b.view){b.view.state="hidden"}}})},isShowing:function(){return this.state=="shown"},show:function(){this.popoverElement.popover("show");this.state="shown"},hide:function(){this.popoverElement.popover("hide");this.state="hidden"},toggle:function(){this.popoverElement.popover("toggle");this.show()},destroy:function(){this.popoverElement.popover("destroy");if(this.popover){this.popover.$tip.remove()}},remove:function(){this.destroy()}});fiuzu.common.views.CommentMainView=Backbone.View.extend({initialize:function(){this.$el=$("#box_comment")},events:{"click .btn-remove":"removeComment","click .btn-edit":"editComment"},render:function(){var c=this.$el,i=$("#comment-text",c),e=$(".btn-submit",c),d=$(".list-comments",c),b=$(".comment-count",c);var j={},f=this.type,a=this.is_review,h=_.template($("#tpl-comment").html(),null,{variable:"data"});var g=this;e.keypress(function(k){if(k.keyCode==13){j.doComment(k)}});e.click(function(k){j.doComment(k)});j.doComment=function(m){var n=i.val();var l=g.object;if(n!=""){i.prop("disabled",true);e.attr("disabled",true).find("span").text("Posting ...");var k=function(){i.prop("disabled",false);e.attr("disabled",false).find("span").text("Post your comment")};var o=new fiuzu.common.models.Comment({comment:n,type:$("#box_comment").data("type"),object:$("#box_comment").data("object")});o.save({},{success:function(p,t){var q=h(p.toJSON()),s=g.getCount()+1,r=$(q);d.append(r);i.val("");g.setCount(s);$(".no-comment",c).hide();r.find(".btn-vote").FiuzuVoteButton({callback:function(){alert("Done")}});k()},error:function(p,q){alert("Sorry ! You can not comment now");k()}})}else{i.focus()}}},getCount:function(){var a=$(".comment-count",this.$el);return parseInt(a.attr("data-count"))},setCount:function(c){var b=$(".comment-count",this.$el);var a="comment";if(this.is_review){a="review"}b.attr("data-count",c).text(c+" "+a+(c>1?"s":""))}});fiuzu.utils.initDateRange=function(f,k,i,a){var g=new Date();var d=new Date(g.getFullYear(),g.getMonth(),g.getDate(),0,0,0,0);a=a||{};var c="yyyy-mm-dd";if(a.format){c=a.format}i=typeof i!=="undefined"?i:true;var j=f.datepicker({format:c,onRender:function(l){if(i){return l.valueOf()<d.valueOf()?"disabled":""}}}).on("changeDate",function(m){if(a&&a.changeDate){a.changeDate(m)}var l=new Date(m.date);var n=new Date(l.getFullYear(),l.getMonth(),l.getDate(),0,0,0,0);n.setDate(n.getDate());e.setValue(n);j.hide();if(!a.silent){k[0].focus()}}).on("show",function(l){if(a&&a.onShow){a.onShow(l)}}).on("hide",function(l){if(a&&a.onHide){a.onHide(l)}}).data("datepicker");var e=k.datepicker({format:c,onRender:function(l){return l.valueOf()<j.date.valueOf()?"disabled":""}}).on("changeDate",function(l){e.hide();if(a&&a.changeDate){a.changeDate(l)}a&&a.finish&&a.finish()}).on("show",function(l){if(a&&a.onShow){a.onShow(l)}}).on("hide",function(l){if(a&&a.onHide){a.onHide(l)}}).data("datepicker");var h=f.val();var b=k.val();if(h){f.datepicker("setValue",h);if(b){k.datepicker("setValue",b)}}else{f.add(k).datepicker("setValue",d)}f.add(k).datepicker().on("show",function(l){$(".datepicker .switch").addClass("disabled")})};(function(){var b=180,g=true;var c=fiuzu.cookie.get("firstAccess"),f=fiuzu.cookie.get("newsletter"),a=fiuzu.utils.getTimeStamp()-fiuzu.cookie.get("firstAccess");var e={classId:"modal-newsletter",url:"/account/modal/newsletter",method:"POST",multiple:true,guest:true,params:{template:"newsletter"},callbacks:{afterSubmit:function(h){alert("Thank you for your submitting !");fiuzu.cookie.set("newsletter",h,null,"index.html")},close:function(){fiuzu.cookie.set("firstAccess",fiuzu.utils.getTimeStamp(),null,"index.html");b+=180}}};$(function(){if(!(window.allowPopup===false)){if(a>3){g=false;var h=setTimeout(function(){fiuzu.utils.showSystemMessagePopup();fiuzu.cookie.set("firstAccess",fiuzu.utils.getTimeStamp(),null,"index.html")},1000)}}});if(!c||c==""){fiuzu.cookie.set("firstAccess",fiuzu.utils.getTimeStamp(),null,"index.html")}if(window.location.href.indexOf("/planner")<0&&(!f||f=="")){if(a>b){var d=new fiuzu.common.models.Authentication();$(function(){if(!d.isAuthenticated()&&!(window.allowPopup===false)&&g){var h=setTimeout(function(){fiuzu.utils.loadModal(e)},3000);$("body").on("keyup click",function(){if(h){clearTimeout(h);h=null}})}})}}}());"user strict";window.fiuzu=window.fiuzu||{};fiuzu.Manager=function(b){var c={};var e=b.resource.name;var d=b.resource.url||"/account/ajax/"+e+"/";var a=b.username;c.call=function(f){var g=f.action;$.ajax({url:d+g,data:f.model,type:"POST"}).done(function(h){if(h.ok){if(f.success){f.success(h)}if(f.finalize){f.finalize(h)}}else{if(f.fail){f.fail()}if(h.msg){alert(h.msg)}}}).fail(function(){if(f.error){f.error()}})};return c};fiuzu.manager={};fiuzu.manager.WishlistManager=function(c){var a=c||{};a.resource={name:"wishlist",url:"/account/ajax/wishlist/"};var b=new fiuzu.Manager(a);return b};fiuzu.manager.VisitedItemManager=function(c){var a=c||{};a.resource={name:"visiteditem",url:"/account/ajax/visiteditem/"};var b=new fiuzu.Manager(a);return b};(function(c){var b=[];var d="";var a={};c.fn.fiuzuTagSelector=function(g,l){var k=this;var h=this[0];if(!h){return false}var f=function(p,s){var q;var o;var r;var n;var m;k.el$=c(h);k.change=p.change?p.change:null;k.getTags=function(){return b};k.setTags=function(t){b=t};k.addTag=function(t){var u=b.indexOf(t);if(u<0){b.push(t)}d=b.join(",");if(k.change){k.change(b)}return d};k.getTagString=function(){d=b.join(",");return d};k.removeTag=function(t){var u=b.indexOf(t);if(u>=0){b.splice(u,1)}d=b.join(",");if(k.change){k.change(b)}return d};k.init=function(){q=c(".search-text-values",k.el$);o=c(".values li",k.el$);r=c(".search-text-hint",k.el$);n=c(".input-value",k.el$);m=c(".close",k.el$);k.max=p.max?p.max:3;o.each(function(){var t=parseInt(c(this).attr("data-value"));var u=c(this).text();a[""+t]=u;if(t){c(this).on("click",function(v){if(!c(this).hasClass("active")){if(b.length>=k.max){return}k.addTag(t);c(this).addClass("active")}else{k.removeTag(t);c(this).removeClass("active")}r.empty();k.presentValue();r.addClass("valued");n.val(d);q.attr("style","");v.stopPropagation()})}});m.on("click",function(){k.close()});r.on("click",function(){k.open()});k.mouseleave(function(){k.close()});if(p.tags){b=p.tags;k.presentValue()}};k.presentValue=function(){if(b&&b.length){r.empty();for(var t=0;t<b.length;t++){if(b[t]in a){var u="<li class='tag' data-value='"+b[t]+"'>"+a[b[t]]+"</li>";r.append(c(u));if(t<b.length-1){r.append("<li>,</li>")}}}o.each(function(){var v=parseInt(c(this).attr("data-value"));if(b.indexOf(v)>=0){c(this).addClass("active")}else{c(this).removeClass("active")}});c("li",r).on("click",function(){var v=parseInt(c(this).attr("data-value"));k.removeTagItem(v,this)});r.show()}else{r.html("<li class='fui-gray'>Travel interest, eg: food, family</li>")}};k.removeTagItem=function(t,u){k.removeTag(t);o.each(function(){var v=parseInt(c(this).attr("data-value"));if(v==t){c(this).removeClass("active").remove();return}});k.presentValue()};k.open=function(){c(k).removeClass("closed");q.removeClass("hidden").show()};k.close=function(){q.addClass("hidden");c(k).addClass("closed");c(k).css({overflow:"hidden"});c(k).css({overflow:"visible"})};k.getTags=function(){return b};k.getValue=function(){return d};k.setTags=function(t){b=t;k.presentValue();k.getTagString();n.val(d)};return k};var e=h._tagselector||f(g);if(!h._tagselector||!((typeof g)=="string")){e.init()}else{var j={open:e.open,close:e.close,value:e.getValue,focus:e.focus,setValue:e.setTags};var i=j[g];return i?i(l):null}h._tagselector=e;return c(h)}}(jQuery));(function(){$.fn.fiuzuSelectBox=function(i,c){var b=38;var e=40;var d=13;if(typeof i!="string"||!i){if(!i){i={}}i.optionClass=i.optionClass||"";i.searchClass=i.searchClass||i.optionClass;i.change=i.change||function(){}}var a=this[0];var h=function(m,v){var t={};var B=false;var r=false;var o=false;var x;var y;var A;var w;var l;var k;var p;var s;var u=[];var q=[];var z=null;var j=null;var n=false;t.change=m.change;t.value=null;t.init=function(){x=$(".search-text-hint",a);y=x.find("input");A=$(".input-value",a);w=$(".search-text-values",a);l=$(".values li"+m.optionClass,a);k=$(".values li"+m.searchClass,a);p=$(".no-result",a);s=$(".close",a);o=m.search;n=m.disabled;if(n){if(y){y.attr("disabled",true)}w.hide().addClass("hidden");return}if(o){k.each(function(){var E=$(this);var D={value:E.attr("data-value"),searchText:E.attr("data-search").toLowerCase(),text:E.text().trim(),view:E};E.model=D;u.push(D);E.hide()});p.hide();var C=function(F){var E,D=u.length;if(F!=""){q=[];for(E=0;E<D;E++){if(u[E].searchText.indexOf(F)>=0){u[E].view.show();u[E].index=q.length;z=u[E];q.push(u[E]);p.hide()}else{u[E].view.hide()}}if(!q.length){p.show()}}else{k.hide()}t.open();r=true};y.attr("autocorrect","off").attr("autocapitalize","off").keyup(function(D){if(D.keyCode==b||D.keyCode==e){var F=1;if(D.keyCode==b){F=-1}if(z){z.view.removeClass("focus");if(z.index==0&&D.keyCode==b){z=q[q.length-1]}else{if(z.index==(q.length-1)&&D.keyCode==e){z=q[0]}else{z=q[z.index+F]}}z.view.addClass("focus")}}else{if(D.keyCode==d){if(z){j=z;y.val(z.text);t.value=z.value;A.val(z.value);t.change(z.value);t.close();k.hide()}}else{var E=$(this).val().trim().toLowerCase();C(E)}}}).on("click",function(){var D=$(this).val();if(D!=""){$(this).select()}t.open();r=true}).blur(function(){r=false}).keydown(function(D){if(D.keyCode==d){event.preventDefault()}})}w.addClass("hidden");t.value=A.val();l.on("click",function(){var E=$(this).text().trim();var D=$(this).attr("data-value");if(!m.search){x.html(E).addClass("valued")}else{x.addClass("valued");y.val(E)}A.val(D);l.removeClass("active");$(this).addClass("active");t.value=D;t.change(D);t.close()});$(a).on("mouseleave",function(D){if((!r&&B)||t.value){t.close()}});x.on("click",function(D){t.focus()});x.on("mouseenter",function(D){t.open()});if(s){s.on("click",function(){t.close()})}};t.getValue=function(){var C=t.value?t.value:A.val();return C};t.setValue=function(F){var E,D,C;for(E=0;E<l.length;E++){D=$(l[E]);C=D.attr("data-value");D.trigger("click");if(C==F){break}}};t.open=function(){w.removeClass("hidden").show();$(t).removeClass("closed");B=true};t.close=function(){w.addClass("hidden");$(t).addClass("closed");$(t).css({overflow:"hidden"});$(t).css({overflow:"visible"});B=false};t.focus=function(){t.open();if(o){y.focus()}};return t};var f=a.selectbox||h(i);if(typeof i!="string"||!i){f.init()}else{var g={open:f.open,close:f.close,value:f.getValue,focus:f.focus,setValue:f.setValue};return g[i](c)}a.selectbox=f;return $(a)}}(jQuery));(function(){$.fn.fiuzuCheckBox=function(a){var b=this;b.value=a.value;b.onChange=a.change;b.init=function(){b.addClass("fiuzu-checkbox");if(b.value){b.addClass("checked")}b.click(function(){if(b.hasClass("checked")){b.removeClass("checked").find("i").addClass("icomoon-icon-checkbox-unchecked").removeClass("icomoon-icon-checkbox");b.value=0}else{b.addClass("checked").find("i").removeClass("icomoon-icon-checkbox-unchecked").addClass("icomoon-icon-checkbox");b.value=1}b.onChange(b.value)});b.mouseout(function(){if(!b.hasClass("checked")){b.find("i").addClass("icomoon-icon-checkbox-unchecked").removeClass("icomoon-icon-checkbox")}})};b.isChecked=function(){return b.value};b.setValue=function(c){b.value=c;if(c){b.addClass("checked")}else{b.addClass("checked")}return b};b.init();return b};$.fn.serializeObject=function(){var c={};var b=this.serializeArray();$.each(b,function(){if(c[this.name]!==undefined){if(!c[this.name].push){c[this.name]=[c[this.name]]}c[this.name].push(this.value||"")}else{c[this.name]=this.value||""}});return c}}(jQuery));(function(){$.fn.FiuzuWishlistButton=function(b){var d=new fiuzu.manager.WishlistManager(fiuzu.session.user);var a={state:$(this).hasClass("checked"),id:$(this).attr("data-id"),type:$(this).attr("data-type")};var c=$(this);if(fiuzu.session.user){if(!a.id){console.warn("No valid id for Wishlist button")}$(this).click(function(g){g.stopPropagation();var f=a.state?"remove":"add";d.call({action:f,model:a,finalize:function(e){if(e.ok){a.state=e.state;c.updateState(e.state||a.state)}}})})}c.updateState=function(e){if(!e){c.removeClass("checked").find("i").removeClass("icomoon-icon-heart-6").addClass("icomoon-icon-heart-5");c.find("span").text("Add to wishlist")}else{c.addClass("checked").find("i").addClass("icomoon-icon-heart-6").removeClass("icomoon-icon-heart-5");c.find("span").text("Added to wishlist")}if(b&&b.change){b.change(e)}};return this}}(jQuery));(function(){$.fn.FiuzuVisitedItemButton=function(b){var d=new fiuzu.manager.VisitedItemManager(fiuzu.session.user);var a={state:$(this).hasClass("checked"),id:$(this).attr("data-id"),type:$(this).attr("data-type")};var c=$(this);if(fiuzu.session.user){if(!a.id){console.warn("No valid object id")}$(this).click(function(){var e=a.state?"remove":"add";d.call({action:e,model:a,finalize:function(f){if(f.ok){a.state=f.state;c.updateState(f.state||a.state)}}})})}c.updateState=function(e){if(!e){c.removeClass("checked").find("i").removeClass("icomoon-icon-location-2").addClass("icomoon-icon-location-3");c.find("span").text("Checkin")}else{c.addClass("checked").find("i").addClass("icomoon-icon-location-2").removeClass("icomoon-icon-location-3");c.find("span").text("Visited")}if(b&&b.change){b.change(e)}};return this};$.fn.FiuzuVoteButton=function(a){var b=$(this);b.each(function(){var e=$(this);var c=new fiuzu.common.models.Vote({object:e.attr("data-object"),type:e.attr("data-vtype"),content_type:e.attr("data-type"),state:e.hasClass("active"),value:e.attr("data-value")});var d=e.attr("data-count");e.click(function(){var f=function(){c.save({},{success:function(g,h){if(g.get("state")){e.addClass("active");d++;a&&a.callback&&a.callback()}else{e.removeClass("active");d--;a&&a.callback&&a.callback()}e.find("span").text(d?d:e.attr("data-short-title"))},error:function(){fiuzu.ui.Authentication.showMessage()}})};fiuzu.common.decorator.loginRequired(f)})});return this};$.fn.FiuzuReportErrorButton=function(a){var b=$(this),d={type:b.attr("data-type"),object:b.attr("data-object")},c={classId:"modal-report-error",url:"/account/modal/error_report",params:d,method:"POST",multiple:true};b.click(function(){fiuzu.utils.loadModal(c)});return this};$.fn.FiuzuPlanCloneButton=function(a){var c=new fiuzu.common.models.Authentication();var b=$(this);b.click(function(){var d=function(){var h;if(a&&a.clonePrice){if(a&&a.priceAdult){var g=a.priceAdult}if(a&&a.priceChild){var e=a.priceChild}h={id:b.attr("data-id"),update_price:true,price_adult:parseFloat(g),price_child:parseFloat(e)}}else{h={id:b.attr("data-id")}}var f={classId:"modal-plan-clone",url:"/plan/modal/clone",params:h,method:"POST",multiple:true};fiuzu.utils.loadModal(f)};if(b.attr("data-dialog")!="False"){fiuzu.common.decorator.loginRequired(d)}else{fiuzu.common.decorator.loginRequired(function(){var e=b.attr("data-planner");location.href=e})}})}}(jQuery));(function(){if(!fiuzu.session.isMobile){$.fn.FiuzuAutocomplete=function(h){var e=(h&&h.source)?h.source:"/api/place/";var d,g;var c;if(h.all){d=e;g="?"}else{var a=h.center;var f=h.city;d=e+"?city_id="+f;if(a){d+="&lat="+a.lat+"&lng="+a.lng}g="&"}if(!this.items){var b=this;this.items=new Bloodhound({datumTokenizer:function(i){return Bloodhound.tokenizers.whitespace(i.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:d+g+"term=",limit:10,remote:{ttl:1,url:d+g+"term=_query"+(h.useGoogle?"&google=1":"")+(h.placeOnly?"&place_only=1":""),wildcard:"_query",filter:function(i){if(h.planner){h.update.updateCss(i.results)}if(i.suggestions){c=i.suggestions}return $.map(i.results,function(j){return{name:j.name,id:j.id,image:j.photo?j.photo.sizes.xs.url:"/static/images/photo-default.jpg",description:j.description,address:j.address,slug:j.slug,lat:j.lat,lng:j.lng,geo_id:j.geo_id}})}}});console.log("====================");console.log("this",this.items);console.log("====================");this.items.initialize();this.typeahead(null,{displayKey:"name",hint:true,highlight:true,source:this.items.ttAdapter(),limit:10,templates:{empty:function(k){var j=$(b).val();if(j&&j.length>3){if(!h.minify){var i='<div class="tt-suggestion tt-selectable no-result"><div class="ac-place-item"><i class="icomoon-icon-sad"></i>There are no result.';if(c){i+=" Suggestion: <i>`"+c+"`</i>"}i+="</div></div>";return i}else{return'<div class="empty-message"><span>No results</span><div class="btn-group"><a href="#explore/category/attraction" class="btn btn-primary btn-search-explore btn-xs">Explore</a><a href="#explore/place/new" class="btn btn-info btn-search-explore btn-xs">Add New</a></div></div>'}}else{return""}},suggestion:function(i){var j=(i.photo&&i.photo.sizes)?i.photo.sizes.ss.url:fiuzu.constants.PHOTO_DEFAULT;if(!h.minify){return'<div class="tt-suggestion tt-selectable"><img class="tt-image img-rounded" src='+i.image+'><h5 class="tt-name">'+i.name+'</h5><div class="tt-desc">'+(i.description||i.address)+"</div>"}else{return'<div class="tt-suggestion tt-selectable"><img class="tt-image avatar" src='+i.image+"><strong>"+i.name+"</strong>"}}}}).bind("typeahead:selected",function(j,i){if(i.item&&i.item.NO_RESULT){}else{h.select&&h.select.selected&&h.select.selected(j,i)}}).bind("typeahead:asyncrequest",function(){$(b).parent().find(".tt-hint").addClass("loading-search")}).bind("typeahead:asynccancel typeahead:asyncreceive",function(){$(b).parent().find(".tt-hint").removeClass("loading-search")});$(this).focus()}}}}(jQuery));$(function(){$(".btn-follow").click(function(d){var f=$(this),h=parseInt(f.attr("data-target-id")),j=parseInt(f.attr("data-id")),g=f.attr("data-callback-follow"),b=null;if(!f.hasClass("checked")){b=new fiuzu.common.models.Follow({target:h});var i=function(e){f.addClass("checked").attr("data-id",e.get("id")).find("i").removeClass("icomoon-icon-star-4").addClass("icomoon-icon-star-6");f.find("span").text("Following");if(typeof window[g]=="function"){window[g]()}};var a=function(){b.save({},{success:function(e,k){i(e)},error:function(e,k){if(k.status==400){i(e);alert("You have followed already !")}else{fiuzu.ui.Authentication.showMessage()}}})};fiuzu.common.decorator.loginRequired(a)}else{b=new fiuzu.common.models.Follow({id:j});var c=function(){b.destroy({success:function(e,k){f.removeClass("checked").attr("data-id","0").find("i").removeClass("icomoon-icon-star-6").addClass("icomoon-icon-star-4");f.find("span").text("Follow");if(typeof window[g]=="function"){window[g]()}}})};fiuzu.common.decorator.loginRequired(c)}});$(function(){$(".btn-vote").FiuzuVoteButton()})}(jQuery));fiuzu.ui.initShareButtons=function(a){a=a||$("body");$.each(["facebook","twitter","google-plus","pinterest","stumbleupon","tumblr"],function(){var b=this;$(".sharestat ."+b,a).click(function(){var d=$(this).attr("data-description"),e=$(this).attr("data-url"),f=$(this).attr("data-media"),c=$(this).attr("data-to-city");if(e==""){e=window.location.href}fiuzu.utils.shareOn(b,e,{description:d,image:f,city:c})})})};fiuzu.ui.Authentication={showMessage:function(){var a=encodeURIComponent(window.location.href);alert('You need to <a href="/account/login?next='+a+'">Login</a> or <a href="/account/register?next='+a+'">Register</a> an account to do this action!')}};(function(b){var a=function(d){this.origHtmlMargin=parseFloat(b("html").css("margin-top"));this.options=b.extend({},b.smartbanner.defaults,d);var c=navigator.standalone;if(this.options.force){this.type=this.options.force}else{if(navigator.userAgent.match(/iPad|iPhone|iPod/i)!=null){if(navigator.userAgent.match(/Safari/i)!=null&&(navigator.userAgent.match(/CriOS/i)!=null||window.Number(navigator.userAgent.substr(navigator.userAgent.indexOf("OS ")+3,3).replace("_","."))<6)){this.type="ios"}}else{if(navigator.userAgent.match(/Android/i)!=null){this.type="android"}}}if(!this.type||c||this.getCookie("sb-closed")||this.getCookie("sb-installed")){return}this.scale=this.options.scale=="auto"?b(window).width()/window.screen.width:this.options.scale;if(this.scale<1){this.scale=1}var e=b(this.type=="android"?'meta[name="google-play-app"]':'meta[name="apple-itunes-app"]');if(e.length==0){return}this.appId=/app-id=([^\s,]+)/.exec(e.attr("content"))[1];this.title=this.options.title?this.options.title:e.data("title")||b("title").text().replace(/\s*[|\-Â·].*$/,"");this.author=this.options.author?this.options.author:e.data("author")||(b('meta[name="author"]').length?b('meta[name="author"]').attr("content"):window.location.hostname);this.iconUrl=e.data("icon-url");this.price=e.data("price");this.create();this.show();this.listen()};a.prototype={constructor:a,create:function(){var e,d=(this.options.url?this.options.url:(this.type=="android"?"market://details?id=":("https://itunes.apple.com/"+this.options.appStoreLanguage+"/app/id"))+this.appId),c=this.price||this.options.price,g=c?c+" - "+(this.type=="android"?this.options.inGooglePlay:this.options.inAppStore):"",f=this.options.iconGloss===null?(this.type=="ios"):this.options.iconGloss;b("body").append('<div id="smartbanner" class="'+this.type+'"><div class="sb-container"><a href="#" class="sb-close">&times;</a><span class="sb-icon"></span><div class="sb-info"><strong>'+this.title+"</strong><span>"+this.author+"</span><span>"+g+'</span></div><a href="'+d+'" class="sb-button"><span>'+this.options.button+"</span></a></div></div>");if(this.options.icon){e=this.options.icon}else{if(this.iconUrl){e=this.iconUrl}else{if(b('link[rel="apple-touch-icon-precomposed"]').length>0){e=b('link[rel="apple-touch-icon-precomposed"]').attr("href");if(this.options.iconGloss===null){f=false}}else{if(b('link[rel="apple-touch-icon"]').length>0){e=b('link[rel="apple-touch-icon"]').attr("href")}}}}if(e){b("#smartbanner .sb-icon").css("background-image","url("+e+")");if(f){b("#smartbanner .sb-icon").addClass("gloss")}}else{b("#smartbanner").addClass("no-icon")}this.bannerHeight=b("#smartbanner").outerHeight()+2;if(this.scale>1){b("#smartbanner").css("top",parseFloat(b("#smartbanner").css("top"))*this.scale).css("height",parseFloat(b("#smartbanner").css("height"))*this.scale);b("#smartbanner .sb-container").css("-webkit-transform","scale("+this.scale+")").css("-msie-transform","scale("+this.scale+")").css("-moz-transform","scale("+this.scale+")").css("width",b(window).width()/this.scale)}},listen:function(){b("#smartbanner .sb-close").on("click",b.proxy(this.close,this));b("#smartbanner .sb-button").on("click",b.proxy(this.install,this))},show:function(c){b("#smartbanner").stop().animate({top:0},this.options.speedIn).addClass("shown");b("html").animate({marginTop:this.origHtmlMargin+(this.bannerHeight*this.scale)},this.options.speedIn,"swing",c)},hide:function(c){b("#smartbanner").stop().animate({top:-1*this.bannerHeight*this.scale},this.options.speedOut).removeClass("shown");b("html").animate({marginTop:this.origHtmlMargin},this.options.speedOut,"swing",c)},close:function(c){c.preventDefault();this.hide();this.setCookie("sb-closed","true",this.options.daysHidden)},install:function(c){this.hide();this.setCookie("sb-installed","true",this.options.daysReminder)},setCookie:function(c,e,d){var f=new Date();f.setDate(f.getDate()+d);e=escape(e)+((d==null)?"":"; expires="+f.toUTCString());document.cookie=c+"="+e+"; path=/;"},getCookie:function(d){var e,c,g,f=document.cookie.split(";");for(e=0;e<f.length;e++){c=f[e].substr(0,f[e].indexOf("="));g=f[e].substr(f[e].indexOf("=")+1);c=c.replace(/^\s+|\s+$/g,"");if(c==d){return unescape(g)}}return null},switchType:function(){var c=this;this.hide(function(){c.type=c.type=="android"?"ios":"android";var d=b(c.type=="android"?'meta[name="google-play-app"]':'meta[name="apple-itunes-app"]').attr("content");c.appId=/app-id=([^\s,]+)/.exec(d)[1];b("#smartbanner").detach();c.create();c.show()})}};b.smartbanner=function(d){var f=b(window),e=f.data("typeahead"),c=typeof d=="object"&&d;if(!e){f.data("typeahead",(e=new a(c)))}if(typeof d=="string"){e[d]()}};b.smartbanner.defaults={title:null,author:null,price:"FREE",appStoreLanguage:"us",inAppStore:"On the App Store",inGooglePlay:"In Google Play",icon:null,iconGloss:null,button:"VIEW",url:null,scale:"auto",speedIn:300,speedOut:400,daysHidden:15,daysReminder:90,force:null};b.smartbanner.Constructor=a}(window.jQuery));fiuzu.utils.promotingApp=function(){var a=window.platform;if(!a&&a!="app"){$(function(){var b=$.smartbanner({title:"Justgola Asia Trip Planner",author:"Fiuzu Pte. Ltd.",price:"FREE",inAppStore:"On the App Store",inGooglePlay:"In Google Play",icon:"/static/images/justgola_full.png",button:"INSTALL",scale:"auto",daysHidden:3,iOSUniversalApp:true})})}};$(function(){var d=Backbone.Model.extend();var b=Backbone.Collection.extend({model:d,initialize:function(){this.url="/api/comment/?type="+$("#box_comment").data("type")+"&object="+$("#box_comment").data("object")},parse:function(f){return f},sync:function(j,h,g){var f=this;var i=_.extend({type:"GET",url:f.url},g);return $.ajax(i)}});var a=Backbone.View.extend({tagName:"li",className:"mt-10",template:$("#comment-plugin").html(),events:{"click .btn-remove":"removeComment","click .btn-edit":"editComment"},initialize:function(g,f){this.model=g;this.listView=f;this.$elBox=$("#box_comment")},render:function(){var g=this.model.toJSON();var f=_.template(this.template,null,{variable:"data"});$(this.el).html(f(g));$(this.el).find(".btn-vote").FiuzuVoteButton();$(this.el).find(".btn-reporterror").FiuzuReportErrorButton();return this},removeComment:function(j){var i=$(j.currentTarget),l=i.attr("data-id"),h=confirm("Are you confirm to delete this comment ?"),g=this;if(l&&h){var f=$("#object-comment-"+l,this.$el);var k=new fiuzu.common.models.Comment({id:l});k.destroy({success:function(){f.remove();var m=g.listView.getCount()-1;g.listView&&g.listView.setCount(m)}})}},editComment:function(j){var n=$(j.currentTarget),f=n.attr("data-id"),l=this,o=$("#object-comment-"+f,this.$el),k=o.find(".fui-comment-content"),m=o.find("textarea").text(),h='<textarea class="fui-row-full form-control">'+k.text()+'</textarea><span class="fui-comment-action-save"><span class="btn-social-bottom btn-edit-save tipB" title="Save"><i class="icomoon-icon-arrow-right"></i><span>Save</span></span><span class="btn-social-bottom btn-edit-cancel tipB" title="Save"><i class="icomoon-icon-cancel"></i><span>Cancel</span></span></span>';var g=$(h);var i=new fiuzu.common.models.Comment({id:f});i.fetch();o.find(".fui-comment-action, .fui-comment-content").hide();g.insertBefore(k);o.find("textarea").keyup(function(){m=$(this).val()}).focus();g.find(".btn-edit-save").click(function(){if(m.trim()!=""){i.save({comment:m,user:i.get("user").id,content_type:i.get("content_type"),object:i.get("object_id")},{patch:true,success:function(p,q){k.text(p.get("comment"));o.find(".fui-comment-action, .fui-comment-content").show();g.remove()}})}else{o.find("textarea").focus()}});g.find(".btn-edit-cancel").click(function(){o.find(".fui-comment-action, .fui-comment-content").show();g.remove()})}});var e=Backbone.View.extend({el:$(".list-comments"),templateFooter:$("#comment-plugin-footer"),elFooter:$(".footer-comments"),initialize:function(){if(!this.el){return}this.collection=new b();this.$el=this.el;this.$elBox=$("#box_comment");var f=this;this.collection.fetch({success:function(){f.render();f.renderFooter()}})},render:function(){var f=this;_.each(this.collection.models,function(g){f.appendItem(g)});return f},renderFooter:function(){var f=this;if(this.el){this._templateFooter=this._templateFooter||_.template($(this.templateFooter).html(),null,{variable:"user"});this.elFooter.html(this._templateFooter(fiuzu.session.user));this.elFooter.find(".login-modal, .register-modal").click(function(){fiuzu.common.decorator.loginRequired(function(){f.renderFooter();if(f.elFooter.find("#comment-text")[0]){f.elFooter.find("#comment-text").focus()}})});f.optionComment()}},optionComment:function(){var h=this.$elBox,n=$("#comment-text",h),j=$(".btn-submit",h),i=$(".list-comments",h),g=$(".comment-count",h);var o={},k=this.type,f=this.is_review,m=_.template($("#comment-plugin").html(),null,{variable:"data"});var l=this;j.keypress(function(p){if(p.keyCode==13){o.doComment(p)}});j.click(function(p){o.doComment(p)});o.doComment=function(r){var s=n.val();var q=l.object;if(s!=""){n.prop("disabled",true);j.attr("disabled",true).find("span").text("Posting ...");var p=function(){n.prop("disabled",false);j.attr("disabled",false).find("span").text("Post your comment")};var t=new fiuzu.common.models.Comment({comment:s,type:$("#box_comment").data("type"),object:$("#box_comment").data("object")});t.save({},{success:function(u,z){var v=m(u.toJSON()),x=l.getCount()+1,w=$(v);n.val("");l.setCount(x);$(".no-comment",h).hide();w.find(".btn-vote").FiuzuVoteButton({callback:function(){alert("Done")}});p();var y=new a(u,l);y.render();i.append(y.render().el)},error:function(u,v){alert("Sorry ! You can not comment now");p()}})}else{n.focus()}}},getCount:function(){var f=$(".comment-count",this.$elBox);return parseInt(f.attr("data-count"))},setCount:function(h){var g=$(".comment-count",this.$elBox);var f="comment";if(this.is_review){f="review"}g.attr("data-count",h).text(h+" "+f+(h>1?"s":""))},appendItem:function(g){var f=this;var h=new a(g,f);$(this.el).append(h.render().el);fiuzu.utils.refreshTooltip(this.$el)}});var c=new e()});"use strict";fiuzu.booking=fiuzu.booking||{};fiuzu.booking.models=fiuzu.booking.models||{};(function(a){a.Cart=Backbone.Model.extend({_class:"Cart",urlRoot:"/api/cart/",defaults:{count:0,items:[],price:{subtotal:0,total:0,tax:0,payment:0,coupon:0,jcredit:0,currency:null}},initialize:function(){this.loaded=false;this.listenTo(this,"reload",this.reload)},setFetchCurrency:function(){this.urlRoot="/api/cart?currency="+fiuzu.session.currency},fetch:function(b){this.setFetchCurrency();return Backbone.Collection.prototype.fetch.call(this,b)},reload:function(){this.fetch();this.updateRelative()},updateRelative:function(){$(".btn-cart").trigger("fz.cart.changed")},getItems:function(){this._items=new a.BookingItemCollection(this.get("items"));return this._items},reset:function(){this._items=null},empty:function(b){$.ajax({url:"/api/cart/action/removeAll",type:"POST",success:function(){b&&b();$(".btn-cart").trigger("fz.cart.changed");$(".btn-addtocart").trigger("fz.btn.addedtocart")},error:function(d){var c=fiuzu.utils.getXhrErrorMessage(d);alert(c)}})}});a.BookingItem=Backbone.Model.extend({_class:"BookingItem",urlRoot:"/api/bookingitem/",defaults:{id:null,plan:null,service_type:null,service_name:"",service_provider:null,status:null,description:"",valid_from:null,valid_to:null,date_created:null,date_updated:null,date_added:null,date_confirmed:null,unit:"item",quantity:1,total_price:0,is_price_fixed:false,num_adult:1,num_child:0,content_type:null,object_id:null},toJSON:function(){var b=_.clone(this.attributes);$.each(b,function(c,d){if(d&&_(d.toJSON).isFunction()){b[c]=d.toJSON()}});b._class=this._class;return b},save:function(d,b){if(!d||d=={}){var c=this.toJSON();if(c.valid_from){this.set("valid_from",c.valid_from.substr(0,10))}if(c.valid_to){this.set("valid_to",c.valid_to.substr(0,10))}}return Backbone.Model.prototype.save.call(this,d,b)},remove:function(d){var c=this.get("id"),b=this.get("object_id");$.ajax({url:"/api/cart/action/removeFromCart",data:{item_id:c},type:"POST",success:function(){$(".btn-addtocart[data-serviceid="+b+"]").trigger("fz.btn.addedtocart");d&&d(this)},error:function(){alert("The item cannot be deleted at this time. Please try later")}})}});a.PreBookingItem=a.BookingItem.extend({_class:"PreBookingItem"});a.BookingItemCollection=Backbone.Collection.extend({model:a.BookingItem});a.PreBookingItemCollection=Backbone.Collection.extend({model:a.PreBookingItem});a.ServiceType={TYPE_UNCATEGORY:0,TYPE_ACCOMMODATION:1,TYPE_TRANSPORTATION:2,TYPE_RENTAL_SERVICE:3,TYPE_TICKET_SERVICE:4,TYPE_BUYING_PRODUCT:5,TYPE_BUYING_SERVICE:6};a.BookingStatus={STATUS_DEFAULT:0,STATUS_BOOKED:1,STATUS_AUTO_ADDED:2,STATUS_IN_CART:3,STATUS_CONFIRMED:4,STATUS_OVERDUE:5,STATUS_IN_CART_CONFIRMED:7};a.BookingStatusCaption={STATUS_DEFAULT:"Add to cart",STATUS_BOOKED:"Booked already",STATUS_AUTO_ADDED:"Added",STATUS_IN_CART:"Added",STATUS_CONFIRMED:"Booked",STATUS_OVERDUE:"Overdue",STATUS_IN_CART_CONFIRMED:"Added"},a.PlaceType={PLACE_TYPE_HOTEL:1,PLACE_TYPE_HOSTEL:2,PLACE_TYPE_HOMESTAY:3,PLACE_TYPE_RELATIVE:4,PLACE_TYPE_COUCHSURFING:5};a.TransportMode={MODE_WALKING:1,MODE_BUS:2,MODE_TAXI:3,MODE_TRAIN:4,MODE_TRADITIONAL:5,MODE_CAR_RENTAL:6,MODE_DRIVING:7,MODE_BOAT:8,MODE_VAN:9,MODE_BICYCLE:10,MODE_MOTOBIKE:11,MODE_CRUISE:12,MODE_METRO:13,MODE_BALLON:14,MODE_PLANE:15};a.AccommondationBookingItem=a.BookingItem.extend({_class:"AccommondationBookingItem",defaults:function(){return _.extend({},a.BookingItem.prototype.defaults,{service_type:a.ServiceType.TYPE_ACCOMMODATION,unit:"room/night"})}});a.TransportationBookingItem=a.BookingItem.extend({_class:"TransportationBookingItem",defaults:function(){return _.extend({},a.BookingItem.prototype.defaults,{service_type:a.ServiceType.TYPE_TRANSPORTATION,unit:"Transfer"})}});a.FlightTransportationBookingItem=a.TransportationBookingItem.extend({_class:"FlightTransportationBookingItem",defaults:function(){return _.extend({},a.TransportationBookingItem.prototype.defaults(),{transportation_mode:a.TransportMode.MODE_PLANE})}});a.TrainTransportationBookingItem=a.TransportationBookingItem.extend({_class:"TrainTransportationBookingItem",defaults:function(){return _.extend({},a.TransportationBookingItem.prototype.defaults(),{transportation_mode:a.TransportMode.MODE_TRAIN})}});a.BusTransportationBookingItem=a.TransportationBookingItem.extend({_class:"BusTransportationBookingItem",defaults:function(){return _.extend({},a.TransportationBookingItem.prototype.defaults(),{transportation_mode:a.TransportMode.MODE_BUS})}});a.TaxiTransportationBookingItem=a.TransportationBookingItem.extend({_class:"TaxiTransportationBookingItem",defaults:function(){return _.extend({},a.TransportationBookingItem.prototype.defaults(),{transportation_mode:a.TransportMode.MODE_TAXI})}});a.BITransportationCollection=Backbone.Collection.extend({model:a.TransportationBookingItem,flights:function(){return this.where({transportation_mode:a.TransportMode.MODE_PLAIN})},buses:function(){return this.where({transportation_mode:a.TransportMode.MODE_BUS})},trains:function(){return this.where({transportation_mode:a.TransportMode.MODE_TRAIN})},taxies:function(){return this.where({transportation_mode:a.TransportMode.MODE_TAXI})}});a.BIAccommondationCollection=Backbone.Collection.extend({model:a.AccommondationBookingItem})}(fiuzu.booking.models));fiuzu.booking.utils=fiuzu.booking.utils||{};(function(a){a.addNewItem=function(m,e,k,i,l,d,h){var g=i||{};g.service=e;g.object_id=k;g.item_id=m;if(g.params){for(var j in g.params){g[j]=g.params[j]}delete g.params}d&&d.attr("disabled",true);var c={classId:h?"modal-booking-calendar":"modal-addnewitem",url:h?"/booking/modal/item/calendar/":"/booking/modal/item/new/",requires:["/static/css/bootstrap/plugins/bootstrap-datepicker.css","static/css/bootstrap/plugins/bootstrap-timepicker.min.css","static/js/bootstrap/plugins/bootstrap-datepicker.js","/static/js/bootstrap/plugins/bootstrap-timepicker.min.js"],method:"GET",multiple:true,guest:true,params:g,callbacks:{success:function(f){l&&l(f,d);d&&d.attr("disabled",false)},close:function(){d&&d.attr("disabled",false)}},error:function(f){alert(f.responseText);console.log(f);d&&d.attr("disabled",false)}};fiuzu.utils.loadModal(c)};a.viewCalendar=function(d,f,g,e,h,c){return a.addNewItem(d,f,g,e,h,c,true)};a.initBtnAddNewItem=function(c){var c=c||$(".btn-addtocart, .btn-service-calendar");c.each(function(){if($(this).attr("data-addtocart")){return}else{$(this).attr("data-addtocart",1)}var e,i,h,g;var d=this,f=$(this);e=$(this).attr("data-cartitem");i=$(this).attr("data-servicetype");h=$(this).attr("data-serviceid");g=$(this).attr("data-provider");if(f.hasClass("btn-addtocart")){this.addCallback=function(k,j){if(f.hasClass("btn")){a.checkServiceStatus(i,h,function(o){var m=fiuzu.booking.models.BookingStatus,l="Amend information of this item in shopping cart",n=(o.status==m.STATUS_CONFIRMED||o.status==m.STATUS_IN_CART_CONFIRMED);if(o.status==m.STATUS_IN_CART||o.status==m.STATUS_IN_CART_CONFIRMED){f.removeClass("btn-success").removeClass("btn-default").addClass("btn-added").attr("data-cartitem",o.item).attr("data-original-title",l).find("span").text(f.attr("data-addedlabel")||o.label)}else{l="Add this item to your cart";f.addClass("btn-success btn-default").removeClass("btn-added").attr("data-cartitem","").attr("data-original-title",l).find("span").text(f.attr("data-addedlabel")||o.label)}fiuzu.utils.refreshTooltip(f.parent());if(n){l=(f.attr("data-original-title")||"")+' <br/><i class="icomoon-icon-checkmark text-success"></i> You\'ve booked this service before';f.attr("data-original-title",l)}})}};this.afterAdded=function(k,j){d.addCallback(k,j);$('.btn[data-serviceid="'+h+'"][data-servicetype="'+i+'"]').each(function(l,m){if(m!=f[0]){$(m).trigger("fz.btn.addedtocart")}});fiuzu.cart&&fiuzu.cart.trigger("reload")};$(this).click(function(){e=$(this).attr("data-cartitem");a.addNewItem(e,i,h,{service_provider:g},d.afterAdded,f,false)});$(this).on("fz.btn.addedtocart",function(){d.addCallback()}).trigger("fz.btn.addedtocart")}else{if(f.hasClass("btn-service-calendar")){$(this).click(function(){a.viewCalendar(e,i,h,{service_provider:g},null,f)})}}})};var b;a.checkServiceStatus=function(c,d,e){if(c&&d){b&&b.abort();b=$.ajax({url:"/api/booking/service/status",data:{service:c,object_id:d},success:function(f){e(f)}})}};a.renderButtonAddToCartHTML=function(e){var i=e.service.service_code,h=e.service.id,d=e.classes||"",c=e.cartItem||"",g=e.title||"Add to cart",f=e.provider||"";console.log("testing",e);return'<button type="button" class="btn btn-success btn-addtocart '+d+'" data-cartitem="'+c+'" data-servicetype="'+i+'" data-serviceid="'+h+'" data-provider="'+f+'" title="Add this item to your cart"><i class="icomoon-icon-basket"></i><span>'+g+"</span></button>"};a.showCart=function(c){var d=function(){fiuzu.cart=fiuzu.cart||new fiuzu.booking.models.Cart();fiuzu.cart.fetch({success:function(h,i){var g=new fiuzu.booking.cart.CartView(h,{el:$(".mbs.cart")});g.render()},error:function(g,h){}})};var e="/booking/modal/cart";if(window.config&&config.partner){e+="?partner="+config.partner}var f={classId:"modal-cart",url:e,requires:["/static/js/fiuzu/booking/fiuzu.booking.cart.js"],multiple:false,callbacks:{close:function(){c&&c.close&&c.close();$(".modal-backdrop").remove()}},reload:d,success:d};fiuzu.utils.loadModal(f)};a.showBookNow=function(c){var d=c.services;if(d.length){var f=d.at(0);var e={classId:"modal-bookingnow",url:"/booking/modal/now",requires:["/static/js/fiuzu/booking/fiuzu.booking.now.js"+(fiuzu.DEBUG?"?t="+new Date().getTime():"")],multiple:false,params:{title:c.title,date_start:f.get("date_start"),num_adult:f.get("num_adult")||1,num_child:f.get("num_child")||0,day:c.day||0,currency:fiuzu.session.currency},initParams:{services:d,plan:c.plan},callbacks:{close:function(){c&&c.close&&c.close();$(".modal-backdrop").remove()}},reload:function(){fiuzu.booknow&&fiuzu.booknow.view&&fiuzu.booknow.view.load()}};fiuzu.utils.loadModal(e)}else{alert("Please add item to your itinerary before do booking. Thank you !")}},a.initBtnCart=function(c){var d=c||$(".btn-cart");d.each(function(e,f){$(f).on("fz.cart.changed",function(){$.ajax({url:"/api/cart/?light=1&currency="+(fiuzu.session.currency||""),success:function(g){$(f).find(".num").text(g.count);fiuzu.cart.attributes=g}})}).trigger("fz.cart.changed")})};a.showRequestForm=function(c,e){var d={classId:"modal-booking-item-request",url:"/booking/modal/service/request",requires:["/static/css/bootstrap/plugins/bootstrap-datepicker.css","static/css/bootstrap/plugins/bootstrap-timepicker.min.css","static/js/bootstrap/plugins/bootstrap-datepicker.js","/static/js/bootstrap/plugins/bootstrap-timepicker.min.js"],params:{service:c,object_id:e},method:"GET",multiple:true};fiuzu.utils.loadModal(d)};a.addNewQuote=function(l,e,j,h,k,d){var g=h||{};g.service=e;g.object_id=j;g.item_id=l;if(g.params){for(var i in g.params){g[i]=g.params[i]}delete g.params}d&&d.attr("disabled",true);var c={classId:"modal-addnewquote",url:"/booking/modal/item/quote/",requires:["/static/css/bootstrap/plugins/bootstrap-datepicker.css","static/css/bootstrap/plugins/bootstrap-timepicker.min.css","static/js/bootstrap/plugins/bootstrap-datepicker.js","/static/js/bootstrap/plugins/bootstrap-timepicker.min.js"],method:"GET",multiple:true,guest:true,params:g,callbacks:{success:function(f){k&&k(f,d);d&&d.attr("disabled",false)},close:function(){d&&d.attr("disabled",false)}},error:function(f){alert(f.responseText);console.log(f);d&&d.attr("disabled",false)}};fiuzu.utils.loadModal(c)};a.initBtnQuoteItinerary=function(c){var c=c||$(".btn-addquote");c.each(function(){if($(this).attr("btn-addquote")){return}else{$(this).attr("btn-addquote",1)}var e,i,h,g;var d=this,f=$(this);e=$(this).attr("data-cartitem");i=$(this).attr("data-servicetype");h=$(this).attr("data-serviceid");g=$(this).attr("data-provider");if(f.hasClass("btn-addquote")){this.afterAdded=function(k,j){console.log("after added")};this.addQuote=function(){e=$(this).attr("data-cartitem");a.addNewQuote(e,i,h,{service_provider:g},d.afterAdded,f)};f.click(function(){var j=function(){d.addQuote()};fiuzu.common.decorator.loginRequired(j)})}})};a.initBtnCustomize=function(d){var c=c||$(".btn-customize");c.each(function(){$(this).FiuzuPlanCloneButton({})})};$(function(){fiuzu.cart=new fiuzu.booking.models.Cart();a.initBtnAddNewItem();var c=$(".btn-addquote").attr("data-servicetype");if(c=="itinerary"){a.initBtnQuoteItinerary()}a.initBtnCustomize();a.initBtnCart()})}(fiuzu.booking.utils));