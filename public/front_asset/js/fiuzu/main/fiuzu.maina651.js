"user strict";window.fiuzu.main=window.fiuzu.main||{models:{},views:{}};window.fiuzu.main.MainApp=(function(){var generating=false;var windowHeight;var windowWidth;var windowTop;var MIN_WIDTH_MAP=420;var IPHONE_WIDTH=320;var isSaved=false;var isAutoSaving=false;var isQuitWarning=true;var AppClass=function(options){var self=this;self.DEFAULT_STARTING_TIME=8;self.travelguide=null;self.currentDay=1;self.defaults={};self.controls={};self.elements={attractionControl$:$("#fiuzu-attraction-control"),list$:$("#list-attractions")};self.authentication=new fiuzu.common.models.Authentication();self.init=function(){self.preCompileTemplates();self._applyConfig(options);self._city=new fiuzu.common.models.City(self.city);windowHeight=$(window).height();windowWidth=$(window).width();self.map=new fiuzu.map.Map({canvas:self.canvas,city:self.city});self.map.displaySetting=new fiuzu.main.models.MapDisplaySettings({},self.map);self.map.app=self;self.controls.modals={};self.controls.searchbar=new fiuzu.main.views.AttractionControlBar();self.controls.topbar=new fiuzu.main.views.TopBarView(this);window.onbeforeunload=function(e){if(!isSaved&&isQuitWarning&&!fiuzu.app.allowOpenWindow){return "You haven't saved your plan yet. Do you want to leave without finishing?";}};window.onunload=function(e){if(self.itinerary&&self.itinerary.get("state")=="temporary"){self.remove();}};self.fitWindow();var resizeHandler;$(window).resize(function(){clearTimeout(resizeHandler);resizeHandler=setTimeout(self.fitWindow,100);});};self.getConfig=function(){return options;};self.preCompileTemplates=function(){var i,l;var keys=_.keys(fiuzu.common.views.TEMPLATE_DOMS);var html;window.fiuzu.templates={};for(i=0,l=keys.length;i<l;i++){html=$(fiuzu.common.views.TEMPLATE_DOMS[keys[i]]).html();window.fiuzu.templates[keys[i]]=_.template(html,null,{variable:'data'});}};self.fitWindow=function(){windowHeight=$(window).height();windowWidth=$(window).width();windowTop=parseInt($("#content").css('marginTop'));if(!fiuzu.session.isMobile){$(".back-container, .list-panel").css({height:windowHeight-45-windowTop});$(".iti-result, .module .list-category, .module .listing").css({height:windowHeight-70-windowTop});$(".list-result .list").css({height:windowHeight-70-windowTop});}else{$(".back-container, .list-panel").css({height:windowHeight-53-windowTop});$(".module .list-category, .module .listing").css({height:windowHeight-60-windowTop});$(".list-result .list").css({height:windowHeight-70-windowTop});$(".iti-result .results-day").css({width:screen.width});$("#content").css({height:windowHeight-70-windowTop});}
if(self.map&&windowWidth>480){var itiPanel$=$(".back-container"),categoryPanel$=$('.category-panel'),mapLeft=categoryPanel$.width()+320;var mapRight=0;if(self.elements.attractionControl$.is(":visible")){mapRight=self.elements.attractionControl$.width();}
self.map.canvas$.css({position:"fixed",top:65,left:mapLeft,bottom:0,right:mapRight,display:'block'});if(self.map.map){google.maps.event.trigger(self.map.map,'resize');}}else{self.map.canvas$.css({position:"fixed",top:0,left:0,bottom:0,right:0,display:'block'});if(self.map.map){google.maps.event.trigger(self.map.map,'resize');}}};self.start=function(){fiuzu.utils.loader.loading("Loading final recommended itinerary ...");var attrs=self.plan;attrs.city=self._city;if(self.plan.id&&!self.itineraryDetail){self._plan=new fiuzu.common.models.Plan(self.plan);self._plan.fetch({success:function(model,response){self._doAfterLoadItinerary();}});}else{self.plan.itinerary=self.itineraryDetail;self._plan=new fiuzu.common.models.Plan(self.plan);if(options.tags&&self._plan.isNew()){self._plan.set('tags',options.tags);}
self._doAfterLoadItinerary();}
self._plan.set('booking_items',config.bookingItems);self.module={};self.module.planner=new fiuzu.route.PlannerRouter();self.module.explore=new fiuzu.route.ExploreRouter();self.module.guide=new fiuzu.route.TravelGuideRouter();self.module.help=new fiuzu.route.HelpRouter();self.module.going=new fiuzu.route.GettingThereRouter();self.module.summary=new fiuzu.route.SummaryRouter();self.module.account=new fiuzu.route.AccountRouter();self.module.booking=new fiuzu.route.BookingRouter();self.module.explore.initManager();Backbone.history.start();self.controls.topbar.render();self.initAutoSaving();if(self.getPlan().get('id')){$('body').addClass('saved');}else{$('body').removeClass('saved');}
fiuzu.utils.tutorialPlanner(function(){if(!self._plan.get('id')&&config.isGenerated){self.module.planner.viewPreview({showSave:false});}});};self.getPlan=function(){return this._plan;};self._initGlobalEnviroment=function(){var msg$=$('.global-msg');if(!msg$[0]){msg$=$('<div/>').addClass('global-msg label label-warning').text('Working, please wait ...');$('body').append(msg$);}
$(document).ajaxStart(function(){msg$.show();});$(document).ajaxStop(function(){msg$.hide();});msg$.hide();};self._doAfterLoadItinerary=function(){self._initGlobalEnviroment();generating=false;self._plan.view=new fiuzu.main.views.PlanView(self._plan);self.controls.itineraryDayNavigateBar=new fiuzu.main.views.ItineraryNavigator(self._plan);self.controls.itineraryDayNavigateBar.render();self.controls.figureLegend=new fiuzu.main.views.FigureLegend(self._plan);self.controls.figureLegend.render();fiuzu.utils.loader.loading("Visualized on map");self.map._plan=self._plan;if(self.map){self.map.init();self._plan.initOnMap(self.map);}
fiuzu.utils.loader.loaded();$(document).keyup(function(e){if(e.keyCode==27){$('.modal.in').modal('hide');location.href="#plan";}});if(self.noOfNotes){$("#modal-notes").modal();}};self.viewTravelGuide=function(section){self.travelguide.loadSection(section);};self.setMap=function(newMap){self.map=newMap;return this;};self.alert=function(title,content,className){var html='<div class="msg '+(className||'')+'"><b>'+title+
'<i class="icomoon-icon-info-2"></i> '+
'</b><i class="icomoon-icon-cancel-2 close"></i>'+
'<p>'+content+'</p></div>';var msg$=$(html);var mainBox$=$('.message-panel');mainBox$.append(msg$).show();window.setTimeout(function(){msg$.fadeTo(500,0).slideUp(500,function(){$(this).remove();mainBox$.hide();});},3000);msg$.find('.close').click(function(){msg$.remove();mainBox$.hide();});};self.save=function(callback,autosave){var self=this,doSave=function(){self._plan.set('is_temp',false);self._save(callback,autosave);};fiuzu.common.decorator.loginRequired(doSave);};self._save=function(callback,autosave){var wasNewPlan=self._plan.isNew();var user=self.authentication.user;self.controls.topbar.setSavingStatus('saving');if(!autosave)fiuzu.utils.loader.loading("Saving ...");if(config.partnerConfig&&config.partnerConfig.id){self.getPlan().set('partner',config.partnerConfig.id);}
self.getPlan().save({},{success:function(model,resp){if(wasNewPlan){self.updatePlanState();}
fiuzu.utils.loader.loaded();self.controls.topbar.setSavingStatus('saved');isSaved=true;},error:function(model,resp){console.log(resp.responseJSON);self.alert("Opp !","Cannot save the plan now, please try later !",'alert-danger');fiuzu.utils.loader.loaded();self.controls.topbar.setSavingStatus('saved');}});if(wasNewPlan){if(top){$.post('/partner/plugin/selected',{selected:""},function(resp){console.log(resp);});}else{top.$.post('/partner/plugin/selected',{selected:""},function(resp){console.log(resp);});}}};self.showRegister=function(skipAuth,callback){if(!skipAuth&&self.authentication.isAuthenticated()){return true;}
self.modalAuthentication=self.modalAuthentication||new fiuzu.ui.modals.FModalAuthentication();self.modalAuthentication.showRegister(callback);};self.showLogin=function(skipAuth,callback){if(!skipAuth&&self.authentication.isAuthenticated()){return true;}
self.modalAuthentication=self.modalAuthentication||new fiuzu.ui.modals.FModalAuthentication();self.modalAuthentication.showLogin(callback);};self.close=function(href){if(!isSaved){var cmdSave=confirm("Do you want to save your plan before you leave?");if(cmdSave){self.save();}else{isQuitWarning=false;if(self.itinerary.get("state")=="temporary"){self.remove();href="https://www.justgola.com/";}}}
window.location.href=href;};self.openEditSetting=function(){this.navigate('#getting-there/general');};self.openPrint=function(){};self.print=function(email){};self.navigate=function(route){window.location.href=route;};self.initAutoSaving=function(){setInterval(function(){var plan=self.getPlan();if(!plan.isNew()&&!plan.get('is_temp')&&self.controls.topbar.getAutoSaveSetting()){self.save(null,true);}},180000);};self.startTourTip=function(){$('.content-panel .module').hide();var oldAttrTitle=$('.btn-category-attraction').attr('data-original-title');$('.btn-category-attraction').attr('data-original-title','Add more items');var clip$=$('.tour-clip');if(!clip$[0]){clip$=$('<div class="tour-clip"></div>').appendTo('body');}
clip$.hide();var tour=new Tour({onEnd:function(t){$('.btn-category-attraction').attr('data-original-title',oldAttrTitle);clip$.hide();},steps:[{element:".plan-title",title:"About your trip",content:"Start your journey by including information about your trip such as the travel dates and number of travelers ...",placement:'bottom',onShown:function(tour){clip$.show().css({top:0,left:200})
self.navigate('#plan/day/1');}},{element:'.category-panel .btn[data-route="getting-there"]',title:"Get some idea",content:"Get some idea about When should to go, Flight, Accommondation, Visa and something needs packing with.",placement:'right',onShown:function(tour){clip$.show().css({top:70,left:0})
self.navigate('#getting-there/whentogo');}},{element:'.category-panel .btn[data-route="plan"]',title:"Your recommended itinerary",content:" We will create an itinerary that best fits your preferences and interests. <br/><br/>You can customise your itinerary by adding or removing attractions to the list.",placement:'right',onShown:function(tour){clip$.show().css({top:$('.category-panel .btn[data-route="plan"]').offset().top,left:0});self.navigate('#plan/day/1');}},{element:'.btn-category-attraction',title:"Add more items",content:"Explore more and add more attractions, events, spa and dining outlet to your itinerary.",placement:'bottom',onShown:function(tour){clip$.show().css({top:0,left:$('.btn-category-attraction').offset().left-5});self.navigate('#explore/category/attraction');}},{element:'.category-panel .btn[data-route="summary"]',title:"Review about needed budget.",content:"Justgola estimates and helps you to summary all the needed budget.",placement:'right',onShown:function(tour){self.navigate('#summary');clip$.show().css({top:$('.category-panel .btn[data-route="summary"]').offset().top,left:0});}},{element:".btn-plan-save",title:"Save your itinerary",content:"Register with us and save your itinerary to view again later or to share them with your family and friends.<br/><br/> You can also print.",placement:'bottom',onShown:function(tour){clip$.show().css({top:0,left:$('.btn-plan-save').offset().left});}},{element:"#btn-planner-close",title:"Exit",content:"To get out of this planning tool to previous page.",placement:'left',onShown:function(tour){clip$.show().css({top:0,left:$('#btn-planner-close').offset().left-20});}}]});tour.init();tour.restart(true);};self.showCarousel=function(){var carousel$=$("#planner-carousel");carousel$.carousel({});carousel$.parent().removeClass('hidden').show().click(function(e){if(e.target==this){$(this).hide().addClass('hidden');fiuzu.app.navigate('#help');}});};self.generate=function(){};self._applyConfig=function(configs){var keys=_.keys(configs);for(var i=0,len=keys.length;i<len;i++){self[keys[i]]=configs[keys[i]];}};self.updatePlanState=function(){self.isNewPlan=false;var url='/planner/'+fiuzu.app.city.slug+'/'+
self._plan.get('slug')+'-'+
self._plan.get('id')+"#plan/setting";if(location.href.indexOf('partner')>0){url='/partner/plugin/sentosa/planner/'+
self._plan.get('slug')+'-'+
self._plan.get('id')+"#plan/setting";}
window.history.pushState({html:document.documentElement.outerHTML,pageTitle:document.title},"",url);self.openEditSetting();$('body').addClass('saved');self.navigate('#plan/share');};self.init();window.fiuzu.ui.Modal.lazyLoading();return self;};return AppClass;})();(function(){var leave,leaveFragment,leaveArgs,lastFragment;Backbone.Router.prototype.before=function(route){};Backbone.Router.prototype.after=function(route){var scopes$=$('.category-panel, .planner-topbar');$('a, [data-route]',scopes$).removeClass('active');if(route&&route!=''){var root=route,slash=route.indexOf('https://www.justgola.com/');if(slash>0)root=route.substring(0,slash);$('a[href="#'+route+'"]',scopes$).addClass('active');$('[data-route='+root+']',scopes$).addClass('active');}};Backbone.Router.prototype.route=function(route,name,callback){if(!_.isRegExp(route))route=this._routeToRegExp(route);if(_.isFunction(name)){callback=name;name='';}
if(!callback)callback=this[name];Backbone.history||(Backbone.history=new Backbone.History);var router=this;Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);if(leave){if(leave.apply(router,leaveArgs)===false)
return;else
leave=false;}
fiuzu.app.lastFragment=lastFragment;router.before.apply(router,arguments);callback&&callback.apply(router,args);router.after.apply(router,arguments);if(router.leave&&typeof router.leave=='function'){leave=router.leave;leaveFragment=fragment;leaveArgs=args;router.leave=null;}
lastFragment=fragment;router.trigger.apply(router,['route:'+name].concat(args));Backbone.history.trigger('route',router,name,args);});return this;};}).call();fiuzu.route=fiuzu.route||{};fiuzu.route.PlannerRouter=Backbone.Router.extend({init:true,scope$:$('.module-plan'),routes:{"":"viewItinerary","plan":"viewItinerary","plan/itinerary":"viewItinerary","plan/day/:day":"viewDay","plan/day/:day/item/:index":"viewItem","plan/save":"viewPlanSave","plan/setting":"viewPlanSetting","plan/photos":"viewPlanPhotos","account/login":"viewLogin","plan/download":"viewDownload","plan/downloadPDF":"viewDownloadPDF","plan/preview":"viewPreview","plan/share":"viewShare","plan/email":"viewShareEmail","plan/emailPDF":"viewEmailPDF","plan/invite":"viewInvite","plan/hotel":"viewHotelManager","plan/edit":"viewPlanEdit","plan/exit":"viewExit"},showPanel:function(){this.app=fiuzu.app;this.scope$.siblings().hide();this.scope$.show();fiuzu.app.map.canvas$.show();},viewExit:function(){if(config.partner){location.href='/partner/plugin/'+config.partner+'/tripplanner';}else{location.href='https://www.justgola.com/';}},viewItinerary:function(){var currentDay=fiuzu.app.getPlan().get('current_day')||1;fiuzu.app.navigate('#plan/day/'+currentDay);},viewDay:function(day){var plan;this.showPanel();plan=fiuzu.app.getPlan();if(day!=plan.get('current_day')){plan.set('current_day',day);}else{plan.trigger('change:current_day');}},viewPlanPhotos:function(){var plan=fiuzu.app.getPlan();var setOpts={classId:'modal-plan-photos',url:'/plan/modal/photos',method:'GET',reload:true,params:{plan:plan.get('id')},initParams:{plan:plan},callbacks:{close:function(){location.href="#plan/photos/done";}}};fiuzu.utils.loadModal(setOpts);},viewPlanEdit:function(){var plan=fiuzu.app.getPlan();var setOpts={classId:'modal-plan-setting',url:'/plan/modal/setting',method:'GET',reload:true,params:{plan:plan.get('id')},initParams:{plan:plan},callbacks:{close:function(){location.href="#plan/edit/done";}}};fiuzu.utils.loadModal(setOpts);},viewSelectHotel:function(day){this.viewDay(day);},viewPlanSave:function(){var self=this;self.isAuth=self.isAuth||fiuzu.app.authentication.isAuthenticated();if(self.isAuth||fiuzu.session.user){fiuzu.app.save();window.history.back();}else{fiuzu.confirm({title:'To save your itinerary',message:'You need to register an account to save your itinerary. Besides, you can Preview your itinerary or request'+
' to send your itinerary via email.',buttons:[{id:'login',title:'Save',description:gettext('Save this itinerary and synchronize with your phone'),primary:true,callback:function(btn$,cfm$){cfm$.modal('hide');fiuzu.common.decorator.loginRequired(function(){fiuzu.app.save();});}},{id:'preview',title:gettext('PDF'),description:gettext('Download PDF file'),callback:function(btn$,cfm$){cfm$.modal('hide');location.href='#plan/download';}},{id:'email',title:'Email itinerary',callback:function(btn$,cfm$){cfm$.modal('hide');location.href='#plan/emailPDF';}}],cancel:function(){location.href='#plan/save/cancel';}});}},viewPlanSetting:function(){var router=this;fiuzu.app.getPlan().fetch({success:function(){router.showPanel();fiuzu.app.openEditSetting();}});},viewLogin:function(){fiuzu.app.showLogin();},viewShare:function(){if(config.partner){location.href="#plan/edit";return;}
var plan=fiuzu.app.getPlan();var afterClose=function(){if(fiuzu.app.lastFragment)
location.href="#plan/share/done";else
fiuzu.app.navigate('#plan');};if(plan.get('id')){var planPreviewOpts={classId:'modal-plan-share',url:'/plan/modal/share',method:'GET',reload:true,params:{plan:plan.get('id')},initParams:{plan:plan},callbacks:{close:afterClose}};fiuzu.utils.loadModal(planPreviewOpts);}else{alert('Please save this plan before share it.');afterClose();}},viewShareEmail:function(){if(fiuzu.app.getPlan().get('id')){var afterClose=function(){if(fiuzu.app.lastFragment)
history.go(-1);else
fiuzu.app.navigate('#plan');};var emailOpts={classId:'modal-plan-email',url:'/plan/modal/email',method:'GET',callbacks:{close:afterClose}};fiuzu.utils.loadModal(emailOpts);}else{alert('You need to save this itinerary before sharing via email.');}},viewInvite:function(){var afterClose=function(){location.href="#plan/invite/sent";};var inviteOpts={classId:'modal-plan-invite',url:'/plan/modal/invite',method:'GET',reload:true,callbacks:{close:afterClose}};fiuzu.common.decorator.loginRequired(function(){fiuzu.utils.loadModal(inviteOpts);},null,function(){location.href="#plan/invite/sent";});},viewPreview:function(opts){var plan=fiuzu.app.getPlan(),url='/plan/modal/preview';if(config.partner){url='/plan/modal/'+config.partner+'/preview/';}
opts&&!opts.showSave&&(url+='?showSave=0');var planPreviewOpts={classId:'modal-plan-preview',url:url,method:'POST',reload:true,data:plan.serialize(),params:{description:plan.get('description'),title:plan.get('name')},callbacks:{close:function(){if(!opts||opts.showSave){fiuzu.app.navigate('#plan/preview/done');}},submitSave:function(){fiuzu.app.navigate('#plan/save');}}};fiuzu.utils.loadModal(planPreviewOpts);},viewDownloadPDF:function(){var ERROR_TITLE=gettext('Opp !'),ERROR_MSG=gettext('Cannot download PDF at this time. Please try later !');var plan=fiuzu.app.getPlan(),isAuth=fiuzu.app.authentication.isAuthenticated();if(plan.get('id')){fiuzu.pdf.downloadPDF(plan.get('id'),plan.get('name'),false);}else{alert(gettext('Please save your itinerary before downloading PDF file'));}},viewHotelManager:function(){fiuzu.app.navigate('#explore/category/hotel');return;},viewEmailPDF:function(){var ERROR_TITLE=gettext('Opp !'),ERROR_MSG=gettext('Cannot send your email at this time. Please try later !');var self=this;var plan=fiuzu.app.getPlan(),isAuth=fiuzu.app.authentication.isAuthenticated();var doEmail=function(planId,email){$.ajax({url:'/api/plan/'+planId+'/email',type:'POST',data:{self:1,emails:email||'',partner:config.partner},success:function(){alert(gettext('Your PDF file will be put in queue for rendering and send to your email after finish. Thank you !'));location.href="#plan/download/sent";fiuzu.utils.loader.loaded();}});};var doSaveAndEmail=function(email){fiuzu.utils.loader.loading(gettext("Loading ..."))
var callbackSaved=function(){if(plan.needSave){plan.save({error:function(data){fiuzu.utils.loader.loaded();fiuzu.app.alert(ERROR_MSG,ERROR_TITLE);},success:function(plan,resp){doEmail(plan.get('id'),email)}});}else{doEmail(plan.get('id'),email)}};if(plan.isNew()){if(!plan.get('photo')){plan.setRandomAvatar();}
if(!isAuth){plan.saveTemp({error:function(data){fiuzu.utils.loader.loaded();fiuzu.app.alert(ERROR_MSG,ERROR_TITLE);},success:function(data){if(data.id){doEmail(data.id,email);}}});}else{callbackSaved();}}else{callbackSaved();}}
if(isAuth){doSaveAndEmail();}else{var newsletterOpts={classId:'modal-newsletter',url:'/account/modal/newsletter?partner='+(config.partner||''),method:'POST',params:{description:gettext('We will send your itinerary in PDF so that you can have your itinerary with you when travelling.'),title:gettext('Email your itinerary'),button:gettext('Send')},callbacks:{afterSubmit:function(email){doSaveAndEmail(email);$('.modal-backdrop').remove();},close:function(){location.href="#plan/download/sent";$('.modal-backdrop').remove();}}};fiuzu.utils.loadModal(newsletterOpts);}},viewDownload:function(){var ERROR_TITLE=gettext('Opp !'),ERROR_MSG=gettext('Cannot download PDF at this time. Please try later !');var plan=fiuzu.app.getPlan(),isAuth=fiuzu.app.authentication.isAuthenticated();var doDownload=function(planId,justDownload){$.ajax({url:'/api/plan/'+planId+'/pdf',type:'GET',data:{partner:config.partner,force:justDownload?'':1,task:justDownload?'get':'render'},success:function(data){fiuzu.utils.downloadFile(data.url);location.href="#plan/download/sent";fiuzu.utils.loader.loaded();},error:function(){alert(ERROR_MSG,ERROR_TITLE);fiuzu.utils.loader.loaded();}});};var doSaveAndDownload=function(){fiuzu.utils.loader.loading(gettext("Loading. It may take a few seconds to render PDF file. Please wait ..."))
var callbackSaved=function(){var justDownload=!plan.needSave;if(plan.needSave){plan.save({error:function(data){fiuzu.utils.loader.loaded();fiuzu.app.alert(ERROR_MSG,ERROR_TITLE);},success:function(plan,resp){if(plan.get('id')){doDownload(plan.get('id'));}}});}else{doDownload(plan.get('id'),justDownload);}};if(plan.isNew()){if(!plan.get('photo')){plan.setRandomAvatar();}
if(!isAuth){plan.saveTemp({error:function(data){fiuzu.utils.loader.loaded();fiuzu.app.alert(ERROR_MSG,ERROR_TITLE);},success:function(data){if(data.id){doDownload(data.id);}}});}else{callbackSaved();}}else{callbackSaved();}};doSaveAndDownload();}});fiuzu.route.AccountRouter=Backbone.Router.extend({routes:{'account/login':'login','account/logout':'logout','account/register':'register','account/myplan':'myplan'},init:function(){this.authentication=new fiuzu.common.models.Authentication();},login:function(){this.init();fiuzu.common.decorator.loginRequired(function(){});},logout:function(){this.init();this.authentication.logout();},register:function(){this.init();this.authentication.doRegister({close:function(){if(fiuzu.app){if(fiuzu.app.lastFragment){fiuzu.app.navigate('#account/closed');}else{fiuzu.app.navigate('#plan');}}}});},_viewMyPlan:function(){var modalOpts={classId:'modal-plan-myplan',url:'/plan/modal/myplan',method:'GET',multiple:false,guest:true,callbacks:{close:function(){if(fiuzu.app.lastFragment){fiuzu.app.navigate('#account/myplan/closed');}else{fiuzu.app.navigate('#plan');}}}};var $modalMyPlan=$('.modal-plan-myplan');var hasChanged=fiuzu.app.getPlan().hasChanged();if($modalMyPlan&&window.PlanListView&&hasChanged){fiuzu.app.getPlan().set('hasChanged',false);var planListView=new window.PlanListView;planListView.viewMorePlan(true,false);}
fiuzu.utils.loadModal(modalOpts);},myplan:function(){fiuzu.common.decorator.loginRequired(this._viewMyPlan);}});fiuzu.route.HelpRouter=Backbone.Router.extend({routes:{'help':'showHelp','help/carousel':'showCarousel','help/tour':'showTour','help/feedback':'showFeedback'},showHelp:function(){},showCarousel:function(slide){fiuzu.app.showCarousel();},showTour:function(){fiuzu.app.startTourTip()},showFeedback:function(){}});fiuzu.route.GettingThereRouter=Backbone.Router.extend({scope$:$('.module-getting-there'),routes:{"getting-there":"viewGeneral","getting-there/general":"viewGeneral","getting-there/whentogo":"viewWhenToGo","getting-there/whentogo/calendar":"viewWhenToGoCalendar","getting-there/whentogo/festival":"viewWhenToGoFestival","getting-there/whentogo/weather":"viewWhenToGoWeather","getting-there/transportation":"viewTransportation","getting-there/accommondation":"viewAccommondation","getting-there/people":"viewPeople","getting-there/packing":"viewPacking","getting-there/others":"viewOthers"},init:function(){this.scope$.siblings().hide();this.scope$.show();if(!this.rendered){this.plan=fiuzu.app.getPlan();this.city=this.city||new fiuzu.common.models.City(fiuzu.app.city);this.view=this.view||new fiuzu.main.views.ModuleGettingThereView(this.city,this.plan);this.view.$el=this.scope$;this.view.delegateEvents();this.view.render();this.rendered=true;}},viewGeneral:function(){if(config.partner){location.href='#plan/edit';return;}
this.init();this.view.setSection('general','Plan information');},viewWhenToGo:function(){this.init();this.view.setSection('whentogo','When to go ?');},viewWhenToGoCalendar:function(){this.init();this.view.setSection('whentogo','When to go ?');},viewWhenToGoFestival:function(){this.init();this.view.setSection('whentogo','When to go ?');},viewWhenToGoWeather:function(){this.init();this.view.setSection('whentogo','When to go ?');},viewTransportation:function(){this.init();this.view.setSection('transportation','Flight/ Transportation');},viewAccommondation:function(){this.init();this.view.setSection('accommondation','Accommondation');},viewPacking:function(){this.init();this.view.setSection('packing','What to pack with ?');},viewPeople:function(){this.init();this.view.setSection('people','People / Group');},viewOthers:function(){this.init();this.view.setSection('others','Visa & other requirements');}});fiuzu.route.SummaryRouter=Backbone.Router.extend({scope$:$('.module-summary'),routes:{"summary":"viewBudget","summary/budget":"viewBudget","summary/budget/per":"viewBudgetPerPerson"},init:function(){this.scope$.siblings().hide();this.scope$.show();this.plan=fiuzu.app.getPlan();this.city=this.city||new fiuzu.common.models.City(fiuzu.app.city);this.view=this.view||new fiuzu.main.views.ModuleSummary(this.plan);this.view.$el=this.scope$;this.view.delegateEvents();this.view.render();},viewBudget:function(){this.init();}})
fiuzu.route.ExploreRouter=Backbone.Router.extend({category:null,manager:null,scope$:$('.module-explore'),routes:{"explore":"viewExplore","explore/category/:category":"viewCategory","explore/place/:action":"viewPlace","explore/place/:placeID/edit":"viewEditPlace","explore/search":"viewSearch","explore/search/:where":"viewSearch","explore/transfer/popular":"viewPopularTransfer"},leave:null,init:function(noRender){if(!noRender){this.scope$.siblings().hide();this.scope$.show();fiuzu.app.map.hideDirectionDisplay();}
if(!this.rendered){this.manager=new fiuzu.common.models.PlaceManager();this.city=this.city||new fiuzu.common.models.City(fiuzu.app.city);this.view=this.view||new fiuzu.main.views.ModuleExploreView(this.city,this.manager);this.view.$el=this.scope$;this.view.delegateEvents();if(!noRender){this.view.render();this.rendered=true;}}},initManager:function(){this.manager=this.manager||new fiuzu.common.models.PlaceManager();},showPanel:function(){this.init();this.scope$.siblings().hide();this.scope$.show();fiuzu.app.fitWindow();this.view&&this.view.close();},viewExplore:function(){location.href="#explore/category/attraction";},viewCategory:function(category){var self=this,checkFlag=0;this.showPanel();if(category!==this.category||!this.category||checkFlag==0){this.view.setSection(category);this.manager.changeOptions(category,null,function(collection){self.view.changeResults(self.manager,collection);});if(self.view&&self.view.$('.ipt-search')){self.view.$('.ipt-search').val('');}
this.category=category;fiuzu.app.currentCategory=category;}
this.leave=this.leaveExplore;},viewEditPlace:function(placeID){this.init();var place=this.manager.getPlace(placeID,true);this.manager.abort();this.showPanel();this.view.viewEditPlace(place);this.manager.changeOptions('edit');this.leave=this.leaveEditPlace;this.category='edit_place';},viewNewPlace:function(){this.manager.abort();this.showPanel();this.view.viewEditPlace();this.manager.changeOptions('new');this.leave=this.leaveEditPlace;this.category='new_place';},viewSearch:function(where){var self=this;this.showPanel();this.manager.changeOptions('search',{where:where},function(){self.view.changeResults();});},viewPlace:function(action){var router=this,preventRender=false;var placeID=parseInt(action);if(placeID){preventRender=true;this.init(preventRender);var place=this.manager.getPlace(placeID);this.view.viewPlace(place);}else if(action=='new'){this.init();var doView=function(){router.manager.set('results',[]);router.viewNewPlace();};fiuzu.common.decorator.loginRequired(doView);}},viewPopularTransfer:function(){var setOpts={classId:'modal-city-transfers',url:'/plan/modal/city_transfers?city_id='+fiuzu.app.city.id,method:'GET',reload:true,callbacks:{close:function(){location.href="#explore/transfer/done";}}};fiuzu.utils.loadModal(setOpts);},leaveExplore:function(){var route=this.manager?this:fiuzu.app.module.explore;if(route&&route.manager&&route.manager.get('state')=='searching'){route.manager.abort();if(location.href.indexOf('#explore/')<0){route.category=null;}}},leaveEditPlace:function(placeID){return this.view?this.view.leaveEditPlace():true;}});fiuzu.route.TravelGuideRouter=Backbone.Router.extend({scope$:$('.module-travelguide'),routes:{"travel-guide":"viewTravelGuide","travel-guide/:section":"viewSection"},showPanel:function(){this.scope$.siblings().hide();this.scope$.show();},viewTravelGuide:function(){this.showPanel();}});fiuzu.route.BookingRouter=Backbone.Router.extend({routes:{"cart":"showCart","booknow/day/:day":"booknowDay"},showCart:function(){var route=this;route.back=false;fiuzu.booking.utils.showCart({close:function(){if(!route.back){if(fiuzu.app.lastFragment){fiuzu.app.navigate('#cart/closed');}else{fiuzu.app.navigate('#');}}
route.back=true;}});},booknowDay:function(day){var plan=fiuzu.app.getPlan();var itiDay=plan.getItinerary().at(day-1);if(itiDay){var plan=fiuzu.app.getPlan();var opts={num_adult:plan.get('num_adult')||1,num_child:plan.get('num_child')||0};var services=itiDay.getServices(opts);fiuzu.booking.utils.showBookNow({services:services,plan:plan,day:day,close:function(){location.href="#plan/day/"+itiDay.get('day');}});}}});window.fiuzu.main.utils=window.fiuzu.main.utils||{};fiuzu.main.utils.toRad=function(degree){return degree*Math.PI/180;}
fiuzu.main.utils.straightLineDistance=function(lat1,lon1,lat2,lon2){var toRad=fiuzu.main.utils.toRad;var R=6371;var dLat=toRad(lat2-lat1);var dLon=toRad(lon2-lon1);var lat1=toRad(lat1);var lat2=toRad(lat2);var a=Math.sin(dLat/2)*Math.sin(dLat/2)+
Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var d=R*c;return d;}
fiuzu.datetime={TIME_PATTERN:/^([0-9]|0[0-9]|1[0-9]|2[0-3]):(0[0-9]|[0-5][0-9])(|:[0-5][0-9]|0[0-9])$/,time2num:function(time){var matches=time.match(this.TIME_PATTERN);if(matches){var s=matches[3].replace(":",''),f=parseInt(matches[1])+parseInt(matches[2])/60;if(s)f+=parseInt(s)/3600;return f;}else{if(time=='24:00'||time=='24:00:00'){return 0.0;}}},num2time:function(f){if(f<=0)return '00:00';f=Math.round((f%24)*100)/100;var hour=parseInt(f),min=Math.round(60*(f-hour));if(min<10)
min='0'+min;if(hour<10)
hour='0'+hour;return hour+':'+min;},timediff:function(t1,t2){var f1=this.time2num(t1),f2=this.time2num(t2);return Math.round((f2-f1)*100)/100;},addtime:function(t1,add){var f1=this.time2num(t1),f2=this.time2num(add);return this.num2time((f1+f2)%24);},subtracttime:function(t1,t2){var f1=this.time2num(t1),f2=this.time2num(t2),diff=f1-f2;if(diff<0){diff+=24}
return this.num2time(diff%24);},num2text:function(n,unit,showSecond,rounded){if(n<=0)return '0h';unit=unit||'hour';var value=n;if(unit=='minute')value/=60;if(unit=='second')value/=3600;if(rounded){value=Math.round(value*60/5)*5/60;}
var day=parseInt(value/24),hour=parseInt(value%24),min=Math.round(((value%24)-hour)*60),second=Math.round(((value%24)-hour-min/60)*3600);if(min==60){min=0;hour+=1;}
if(hour==24){hour==0;day+=1;}
var strDay=day?day+'day ':'',strHour=hour?hour+'h ':'',strMin=min?min+'min ':'',strSecond=showSecond?(second?second+'s':''):'';return(strDay+(strHour?strHour:'')+(strMin?strMin:'')+(strSecond?strSecond:'')).trim();}};fiuzu.geo={DEGREETOKM:111.0,distance:function(p1,p2,toText){if(p1&&p2&&p1.lat&&p2.lat&&p1.lng&&p2.lng){var dx=p1.lat-p2.lat,dy=p1.lng-p2.lng,dis=Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));if(!toText){return dis*this.DEGREETOKM;}else{return this.dis2text(dis*this.DEGREETOKM);}}
throw "Not valid location. Got "+JSON.stringify(p1)+' - '+JSON.stringify(p2);},dis2text:function(dis){if(dis<1){return Math.round(dis*1000)+'m';}else{return(dis.toFixed(2)+'km');}},besttransport:function(p1,p2){var d=this.distance(p1,p2);if(d<1/Math.sqrt(2))return fiuzu.common.models.ROUTE_MODE_WALKING;return fiuzu.common.models.ROUTE_MODE_DRIVING;},estimatetime:function(p1,p2,mode){var dis=this.distance(p1,p2),time;mode=mode||fiuzu.common.models.ROUTE_MODE_DRIVING;if(mode==fiuzu.common.models.ROUTE_MODE_DRIVING){time=(dis*Math.sqrt(2))/45.0;}else if(mode==fiuzu.common.models.ROUTE_MODE_WALKING){time=(dis*Math.sqrt(2))/5.0;}
return time;}}