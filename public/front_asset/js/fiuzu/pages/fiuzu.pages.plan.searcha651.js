"use strict";var btnLoadMore;var xhr;var PlanCollection=Backbone.Collection.extend({initialize:function(){if($(window).width()<=1024){this.url='/api/plan/recommend?page_size=8';}else{this.url='/api/plan/recommend?page_size=9';}},model:fiuzu.common.models.Plan,parse:function(response){this.nextUrl=response.next;btnLoadMore=this.nextUrl;if(btnLoadMore&&$(window).width()<=1024){$('.btn-load-more').removeClass('hidden');}else{$('.btn-load-more').addClass('hidden');}
return response.results;},setupUrl:function(country,destination,duration,budget,intensity,tags,search_type,search_keyword,orderby,pageSize){this.url='/api/plan/recommend?'+
'country_id='+(country||'')+
'&city_id='+destination+
'&days='+duration+
'&price='+budget+
'&mode='+intensity+
'&tags='+tags+
'&search='+search_type+
'&keyword='+search_keyword+
'&orderby='+orderby+
'&page_size='+pageSize;},loadMore:function(callback){var col=this;xhr&&xhr.abort();if(col.nextUrl){xhr=$.ajax({url:col.nextUrl,success:function(resp){var plans=resp.results;col.add(plans);callback(plans);col.nextUrl=resp.next;}});}}});var PlanView=Backbone.View.extend({model:fiuzu.common.models.Plan,template:_.template($('#tpl-plan').html(),null,{variable:'plan'}),initialize:function(){this.cart=this.cart||new fiuzu.booking.models.Cart();},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.find('.btn-plan-clone').FiuzuPlanCloneButton();fiuzu.utils.refreshTooltip(this.$el);fiuzu.booking.utils.initBtnAddNewItem(this.$el.find('.btn-addtocart'));fiuzu.booking.utils.initBtnQuoteItinerary(this.$el.find('.btn-addquote'));return this;}});var PlanCollectionView=Backbone.View.extend({render:function(){var self=this;this.collection.each(function(plan){var view=new PlanView({model:plan});self.$el.append(view.render().el);});return this;}});$(function(){var result$=$('#list-result'),pageSize=9;result$.empty('');var plansCol=new PlanCollection();var plansView;var orderBy$=$('.order-by'),filterBy$=$('.filter-by'),filterTypes$=$('.filter-type'),loadMore$=$('.load-more'),keyword$=$('.filter-keyword');function makeFilter(){if($(window).width()<=1024){$('.btn-load-more').addClass('hidden');}
var countryId=$('[name=filter-country]').val(),destination=$('[name=filter-destination]').val(),duration=$('[name=filter-duration]').val(),budget=$('[name=filter-budget]').val(),intensity=$('.filter-intensity:checked').val(),search_type=filterBy$.attr('data-value'),search_keyword=$('[name=filter-keyword]').val(),tags=[],orderby=orderBy$.attr('data-value');var tags$=$('.filter-interest:checked');tags$.each(function(){tags.push($(this).val());});result$.empty('');loadMore$.show();plansCol.setupUrl(countryId,destination,duration,budget,intensity,tags.join(','),search_type,search_keyword,orderby,pageSize);plansCol.fetch({success:function(){plansView=new PlanCollectionView({collection:plansCol});result$.append(plansView.render().el);loadMore$.hide();$('img[data-src]').unveil();}});}
function viewMorePlan(){if(plansCol.nextUrl){if($(window).width()<=1024){$('.btn-load-more').removeClass('hidden');}
loadMore$.show();plansCol.loadMore(function(plans){result$.empty('');plansView=new PlanCollectionView({collection:plansCol});result$.append(plansView.render().el);loadMore$.hide();$('img[data-src]').unveil();});}else{$('.btn-load-more').addClass('hidden');}}
orderBy$.find('.btn').click(function(){$(this).siblings().removeClass('active');$(this).addClass('active');orderBy$.attr('data-value',$(this).attr('data-value'));makeFilter();});filterTypes$.find('li').click(function(){filterBy$.attr('data-value',$(this).attr('data-value'));filterBy$.find('.text').text($(this).text());$('.filter-keyword').attr('placeholder',$(this).attr('title'));makeFilter();});var filterDestination=$('#filter-destination');if(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)){filterDestination.select2({minimumResultsForSearch:-1});}else{filterDestination.select2({});}
filterDestination.on("change",function(e){var cityId=$('[name=filter-destination]').val();var opt$=$('#filter-destination').find('option[value= '+cityId+']');var duration=opt$.attr('data-duration'),budget=opt$.attr('data-budget');keyword$.val('');makeFilter();});var sliderDuration=new Slider("#filter-duration",{ticks:[0,1,2,3,4,5,6,7],ticks_labels:['Any','1','2','3','4','5','6','7'],step:1});var sliderBudget=new Slider("#filter-budget",{ticks:[0,200,400,600,800,1000],ticks_labels:['Any','200','400','600','800','1000'],step:100});sliderDuration.setValue(0);sliderBudget.setValue(0);if(fiuzu.session.isMobile){setTimeout(function(){sliderDuration.refresh();sliderBudget.refresh();},3000);}
$('#filter-duration').on('slideStop',function(ev){keyword$.val('');makeFilter();});$('#filter-budget').on('slideStop',function(ev){if($('#filter-budget').val()==="0"){$('#filter-budget-value .value').text("Any");$('#filter-budget-value .unit').text("");}else{$('#filter-budget-value .value').text($('#filter-budget').val());$('#filter-budget-value .unit').text("USD");}
keyword$.val('');makeFilter();});$('[name=filter-keyword]').change(function(){makeFilter();});$('.option-mode input').click(function(){keyword$.val('');makeFilter();});$('.option-interest input').click(function(){keyword$.val('');makeFilter();});if($(window).width()<=1024){pageSize=8;$('.btn-load-more').click(function(){viewMorePlan();})}else{$(window).scroll(function(){if($(this).scrollTop()+$(this).height()>=($(document).height()-500)){viewMorePlan();}});}
fiuzu.utils.loadImageMobile();makeFilter();});