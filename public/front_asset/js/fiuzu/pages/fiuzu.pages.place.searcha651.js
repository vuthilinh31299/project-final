"use strict";var xhr;var windowWidth=$(window).width();var cookieAdded=fiuzu.cookie.get('_itiParams');var _checkIti=fiuzu.cookie.get('_hasIti');var _checkValueSelected=0;var mustGoDict=null;var PlaceModel=Backbone.Model.extend({model:fiuzu.common.models.Place})
var PlaceCollection=Backbone.Collection.extend({model:PlaceModel,initialize:function(){this.url='api/place/index.html';this.baseUrl=this.url;},parse:function(response){this.nextUrl=response.next;if(this.nextUrl&&$(window).width()<=1024){$('.btn-load-more').removeClass('hidden');}else{$('.btn-load-more').addClass('hidden');}
this.total=response.count;return response.results;},setupUrl:function(term){var conds=[];if(document.topAdvancedSearch){var params=$(document.topAdvancedSearch).serializeArray();var data=fiuzu.utils.parseFormData(params);for(var field in data){if(_checkIti==1&&data.category==""){data.category='1,2,5,9,14';}
conds.push('&'+field+'='+data[field]);}
var newUrl=conds.join('');newUrl.replace('visit_time=1','for_firsttime');newUrl.replace('visit_time=2','for_secondtime');if($(window).width()<=1024){this.url=this.baseUrl+'?'+newUrl+'&page_size=8';}else{this.url=this.baseUrl+'?'+newUrl+'&page_size=9';}
if(term)
this.url+='&term='+term;}
return this.url;},loadMore:function(callback){var col=this;xhr&&xhr.abort();if(col.nextUrl){xhr=$.ajax({url:col.nextUrl,success:function(resp){var plans=resp.results;col.add(plans);callback(plans,col);col.nextUrl=resp.next;}});}}});var PlaceView=Backbone.View.extend({template:_.template($('#tpl-place').html(),null,{variable:'place'}),events:{'click .btn__add__itinerary':'addToItinerary','click .btn__remove__itinerary':'removeToItinerary',},render:function(){var self=this;if(_checkIti==1){self.checkItiAdded();}
self.model.set('_checkIti',_checkIti);this.$el.html(this.template(this.model.toJSON()));return this;},checkItiAdded:function(){var self=this;self.currentCityId=Number($('#filter-destination').val());self.placeId=self.model.get('id').toString();if(cookieAdded){self._itiParams=JSON.parse(cookieAdded);}
if(!mustGoDict){if(self._itiParams&&self._itiParams.length){var leng=self._itiParams.length;for(var i=0;i<leng;i++){var cityId=self._itiParams[i].cityId;if(cityId===self.currentCityId){mustGoDict=self._itiParams[i].mustGoDict;}}}}
if(mustGoDict&&mustGoDict.length){if(mustGoDict.indexOf(self.placeId)!=-1){self.model.set('added',true);}else{self.model.set('added',false);}}},addToItinerary:function(){var self=this;if(mustGoDict.indexOf(self.placeId)==-1){mustGoDict.push(self.placeId);console.log('hdaskjdhajkdhasd ',mustGoDict);self.$('.btn__add__itinerary').removeClass('btn__add__itinerary').addClass('btn__remove__itinerary').text('Remove from itinerary');self.saveMustGo();}},removeToItinerary:function(){var self=this;if(mustGoDict.indexOf(self.placeId)!=-1){mustGoDict=_.without(mustGoDict,self.placeId);self.$('.btn__remove__itinerary').removeClass('btn__remove__itinerary').addClass('btn__add__itinerary').text('Add to itinerary');self.saveMustGo();}},saveMustGo:function(){var self=this;fiuzu.utils.mustGoDict(self._itiParams,{cityId:self.currentCityId,mustGoDict:mustGoDict});fiuzu.cookie.set('_itiParams',JSON.stringify(self._itiParams));}});var PlaceCollectionView=Backbone.View.extend({render:function(){var self=this;this.collection.each(function(place){var view=new PlaceView({model:place});self.$el.append(view.render().el);});return this;}});var FilterCategoryModel=Backbone.Model.extend();var FilterCategoryCollection=Backbone.Collection.extend({model:FilterCategoryModel,parse:function(response){return response;},sync:function(method,model,options){var self=this;var params=_.extend({type:'GET',url:self.url},options);return $.ajax(params);}});var FilterCategoryView=Backbone.View.extend({template:_.template($('#tpl-filter-category').html(),null,{variable:'category'}),initialize:function(model){this.model=model;},render:function(){this.$el.html(this.template(this.model));return this;}});var FilterCategoryCollectionView=Backbone.View.extend({el:$('.filter-category-place'),tagName:'div',initialize:function(){this.$el=this.el;var self=this;this.update(function(){self.render();});},update:function(callback){var self=this,cityID=0;if($('#filter-destination').val()){cityID=$('#filter-destination').val();}
this.collection=new FilterCategoryCollection();this.collection.url='/api/place/category/?city_id='+cityID;xhr&&xhr.abort();xhr=this.collection.fetch({success:function(){callback&&callback();}});},rerender:function(){var self=this;this.update(function(){self.render();});},render:function(){var view=this;_.each(this.collection.models,function(category){view.appendItem(category);});return view;},appendItem:function(category){var view=this;var num=[];var allCategories=[];var categorySelected=$('.category-place [name=category]:checked').data('category').toLowerCase();if(categorySelected==="all"){_.each(category.toJSON(),function(obj,index){_.each(obj.sub_categories,function(a,b){num.push({id:a.id,category:a.category,name:a.name,slug:a.slug,num_place:a.num_place,type:'sub_category'});});_.each(obj.themes,function(a,b){num.push({id:a.id,category:a.category,name:a.name,slug:a.slug,num_place:a.num_place,type:'sub_theme'});})});}else{var subCategories=category.toJSON()[categorySelected]?category.toJSON()[categorySelected].sub_categories:[],themes=category.toJSON()[categorySelected]?category.toJSON()[categorySelected].themes:[];_.each(subCategories,function(a,b){num.push({id:a.id,category:a.category,name:a.name,slug:a.slug,num_place:a.num_place,type:'sub_category'});});_.each(themes,function(a,b){num.push({id:a.id,category:a.category,name:a.name,slug:a.slug,num_place:a.num_place,type:'sub_theme'});});}
num=num.sort(function(a,b){return b.num_place-a.num_place;});allCategories=num.slice(0,20);category.set({cates:allCategories});var filterCategoryView=new FilterCategoryView(category.toJSON().cates);$(this.el).empty().append(filterCategoryView.render().el);}});$(function(){var result$=$('#list-result'),pageSize=9,noresult$=$('#list-noresult'),loading$=$('.load-more'),placesCol=new PlaceCollection(),placesView,$keyword=$('.filter-keyword'),form=document.topAdvancedSearch;$('[name=filter-keyword]').change(function(){var val=$keyword.val();fiuzu.place.search("",val);});function viewMorePlace(){if(placesCol.nextUrl){if($(window).width()<=1024){$('.btn-load-more').removeClass('hidden');}
loading$.show();$('.count-place').hide();placesCol.loadMore(function(places,col){result$.empty('');placesView=new PlaceCollectionView({collection:placesCol});result$.append(placesView.render().el);loading$.hide();var count=col.total;$('.count-place').show().text('Found '+count+' place'+(count>1?'s':''));result$.find('img[data-src]').each(function(){if(!$(this).attr('src')){$(this).unveil({});}});});}else{$('.btn-load-more').addClass('hidden');}}
loading$.hide();var filterCategoryCollectionView;var checkFlag=0;fiuzu.place={search:function(form,term){result$.empty('');loading$.show();placesCol.setupUrl(term);placesCol.fetch({success:function(res){if(res.length){placesView=new PlaceCollectionView({collection:placesCol});result$.append(placesView.render().el);noresult$.addClass('hidden');if(checkFlag===0){renderFilterCategory();checkFlag=1;}
if(checkFlag===1){$('.category-place input[name=category]').click(function(){renderFilterCategory();})
$('#filter-destination').change(function(){renderFilterCategory();})}
var count=placesCol.total;$('.count-place').show().text('Found '+count+' place'+(count>1?'s':''));result$.find('img[data-src]').each(function(){if(!$(this).attr('src')){$(this).unveil({});}});}else{$('.count-place').show().text('Found '+0+' place');noresult$.removeClass('hidden');}
loading$.hide();}});}};if($(window).width()<=1024){pageSize=8;$('.btn-load-more').click(function(){viewMorePlace();})}else{$(window).scroll(function(){if($(this).scrollTop()+$(this).height()>=($(document).height()-500)){viewMorePlace();}});}
function renderFilterCategory(){if(filterCategoryCollectionView){filterCategoryCollectionView.rerender();}else{filterCategoryCollectionView=new FilterCategoryCollectionView();}}
function searchAdvancedPlace(){var filterDestination=$('#filter-destination');if(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)){filterDestination.select2({minimumResultsForSearch:-1});}else{filterDestination.select2({});}
var formSearch=$('.form-filter'),form=document.topAdvancedSearch,cityVal=$('[name=city_id]').val();if(cityVal){filterDestination.val(cityVal).change();}
$('#order-by li').click(function(){if($(window).width()<=768){$('.btn-load-more').addClass('hidden');}
$('#order-by li').removeClass('active');$(this).addClass('active');if(form){form.order_by.value=$(this).attr('data-value');fiuzu.place.search();}
$keyword.val('');});fiuzu.place.search();checkGoodForAll();var val=0;function checkGoodForAll(){if($(form).find('.good-for-all').is(':checked')){val=1;$(form).find('.good-for:not(.is-good)').trigger('click');$(form).find('.good-for:not(.is-good)').addClass('is-good');}else{val=0;$(form).find('.good-for.is-good').trigger('click');$(form).find('.good-for-all').attr('checked','checked');}}
$(form).find('.good-for-all').click(function(){checkGoodForAll();$keyword.val('');});$(form).find('.good-for').click(function(){if(!$(this).hasClass('is-good')){$(this).addClass('is-good');val=1;}else{$(this).removeClass('is-good');form.for_all.checked=false;val=0;}
form[$(this).data('name')].value=val;$keyword.val('');});$(form).find('.sel-restaurant').click(function(){form.activity_type.value=$(this).data('type');});renderFilterCategory();formSearch.on('change',function(){if($(window).width()<=768){$('.btn-load-more').addClass('hidden');}
var cityID=$('#filter-destination').val();form.city_id.value=cityID;fiuzu.place.search(form);$keyword.val('');});$('.search-place-mobile').click(function(){fiuzu.place.search(form);$keyword.val('')})}
var countryName,cityName;var $titleSearch=$('.place-search-title strong');$('#filter-destination').on('change',function(){var citySelected=$(this).find('option:selected');countryName=citySelected.data('country');cityName=citySelected.data('city');var url=(countryName&&cityName)?('/place/'+countryName+'/'+cityName):'/place';history.replaceState({},'place',url);if(citySelected.val()==0){$titleSearch.text('Asia');}else{$titleSearch.text(citySelected.text());}
clickItineraryCategory();})
function clickItineraryCategory(){$('#itinerary_category').on('click',function(){if(!countryName&&!cityName){window.location.href='plan/index.html';}else{window.location.href='/plan/'+countryName+'/'+cityName;}})}
fiuzu.utils.loadImageMobile();searchAdvancedPlace();clickItineraryCategory();if(_checkIti==1){checkTripplannerPage();if(windowWidth>1200){$('.btn__goback').addClass('btn-lg');}
fiuzu.cookie.set('_hasIti',0);}
function checkTripplannerPage(){var $searchDes=$('.form__search__destination');var $headerFilter=$('.header-filter');var $cates=$('.category-place');$searchDes.addClass('hidden');$cates.find('[data-category=Activity], #itinerary_category').parent().parent().addClass('hidden');$headerFilter.text('').after().append('<a class="btn btn-warning btn__goback"><i class="icomoon-icon-arrow-left-5"></i> Go Back Tripplanner</a>');var $btnGoBack=$('.btn__goback');$btnGoBack.on('click',function(){history.back();});}});