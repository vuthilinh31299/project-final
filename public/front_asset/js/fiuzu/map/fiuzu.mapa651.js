"use strict";window.fiuzu.map=window.fiuzu.map||{};window.config=window.config||{};fiuzu.map.MarkerManager=Backbone.Model.extend({_markers:{},mapManager:null,defaults:{results:[]},initialize:function(){this.categories={};},setCategory:function(category,opts){var categories=category.split(' ');this.categories={};for(var i=0;i<categories.length;i++){this.categories[categories[i]]=1;}
if(!opts||!opts.silent)this.showCategory();},getCategory:function(){var categories=[];$.each(this.categories,function(cat,state){if(state)categories.push(cat);});return categories.join(' ');},addCategory:function(category,opts){this.categories[category]=1;if(!opts||!opts.silent)this.showCategory();},removeCategory:function(category,opts){this.categories[category]=0;if(!opts||!opts.silent)this.showCategory();},addMarker:function(marker,id,category){var place=marker.model,existed=false;marker.id=id;marker.addClass(category,{silent:true});if(id in this._markers)this.removeMarker(id);this._markers[id]=marker;},getMarker:function(id){if(id in this._markers)return this._markers[id];return null;},removeMarker:function(id){if(id in this._markers){if(this._markers[id].label){this._markers[id].label.remove();delete this._markers[id].label;}
delete this._markers[id];}},hideAll:function(){$.each(this._markers,function(id,marker){marker.hide();});},destroyAll:function(){$.each(this._markers,function(id,marker){marker.destroy();});},updateAll:function(){$.each(this._markers,function(id,marker){marker.updateAll();});},showCategory:function(category,force){var collection={},self=this;if(category)this.setCategory(category,{silent:true});$.each(this._markers,function(id,marker){marker.hide();$.each(self.categories,function(cat,state){if(state){if(marker.classes[cat]){if(cat==='personal'){marker.addClass('marker-wishlist');}
if(force){marker.destroy();}
marker.show();collection[marker.id]=marker;}}});});var list=[];$.each(collection,function(id,marker){list.push(marker);});if(list.length){fiuzu.app.map&&fiuzu.app.map.fitBoundsForPlaces(list);}}});fiuzu.map.Map=(function(){var window_height;var window_width;var itineraryDetail=[];var ROUTING_MODE={"1":google.maps.DirectionsTravelMode.DRIVING,"2":google.maps.DirectionsTravelMode.WALKING,"3":google.maps.DirectionsTravelMode.TRANSIT,"4":google.maps.DirectionsTravelMode.BICYCLING,"5":google.maps.DirectionsTravelMode.DRIVING,};var defaultImageURL='https://www.justgola.com/static/images/markers/empty.png';var defaultImage={url:defaultImageURL,size:new google.maps.Size(34,42),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,42)};var ROUTE_MODE_ACTIONS=['','Hire a taxi','Walk','Bus/Train','Ride a bike','Ride a motocycle'];var ROUTE_MODE_NAMES=['no_mode','driving','walking','public_transport','bicycling','motobike'];var ROUTE_MODE_ICONS=['','icomoon-icon-cars','icomoon-icon-man','icomoon-icon-bus','icomoon-icon-bike','icomoon-icon-bike'];var MapCls=function(configs){var xMarkers=[];var restaurantMarkers=[];var restaurantLabels=[];var xLabels=[];var oldMarkerNumber=null;var tempMarkers=[];var placeLabels=[];var tempLabels=[];var placeLatLongs=[];var waypoints=[];var afterLoadMarkers=[];var oms;var overlay;var directionsDisplay=[];var routeHotelDisplay;var directionResponseForDay=[];var directionsVisible;var directionsService=new google.maps.DirectionsService();var gPlaceService;var centerPoint;var centerPointX=0;var centerPointY=0;var bounds;var routingIndex=0;var timeoutCalcRoute;var toCalc=[];var xhr;var obj={};obj.placeMarkers=[];obj.canvas$=configs.canvas;obj.plan=configs.plan;obj.itinerary=configs.itinerary;obj.currentDay=configs.currentDay||1;obj.city=configs.city;obj.markerManager=new fiuzu.map.MarkerManager();obj.markerManager.mapManager=this;obj.exceptionCities=['Jeju','Seoul'];obj.mapStyles=[];obj.category={_ALL:null,ATTRACTION:['park','museum','zoo','aquarium','art_gallery','church','hindu_temple','library','mosque','airport'],SHOPPING:['shopping_mall','store'],NIGHTLIFE:['bar','night_club'],RESTAURANT:['restaurant','food','establishment','cafe','bakery'],ACTIVITY:['bar','casino'],HOTEL:['lodging'],SPA:['spa','beauty_salon'],PUBLIC_PLACE:['post_office','local_government_office'],all:function(){if(!this._ALL){var c=this;this._ALL=[];$.each(this,function(k,v){if(k!='_ALL'&&Object.prototype.toString.call(v)==='[object Array]'){c._ALL=c._ALL.concat(v);}});}
return this._ALL;}};obj.init=function(){centerPoint=new google.maps.LatLng(obj.city.lat,obj.city.lng);var mapOptions={zoom:14,scrollwheel:configs.scrollwheel===false?false:true,center:centerPoint,disableDefaultUI:true,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:false,panControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:true,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP,style:google.maps.ZoomControlStyle.LARGE},}
var styledMapType;if(!obj.exceptionCities.indexOf(obj.city.name)>=0){mapOptions["mapTypeId"]="fiuzuStyled";mapOptions["mapTypeControlOptions"]={mapTypeIds:['fiuzuStyled']};styledMapType=new google.maps.StyledMapType(obj.mapStyles,{name:'fiuzuStyled'});}
obj.map=new google.maps.Map(obj.canvas$[0],mapOptions);if(styledMapType){obj.map.mapTypes.set('fiuzuStyled',styledMapType);}
var hiddenControl=document.getElementById("map-hidden-control");obj.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(hiddenControl);gPlaceService=new google.maps.places.PlacesService(obj.map);overlay=new google.maps.OverlayView();overlay.draw=function(){};overlay.setMap(obj.map);google.maps.event.addListenerOnce(obj.map,'tilesloaded',function(){for(var i=0,len=afterLoadMarkers.length;i<len;i++){if(i<3){afterLoadMarkers[i].setMap(obj.map);}else{afterLoadMarkers[i].setMap(null);}}
obj.refreshMap();});};obj.refresh=function(){var cat=this.markerManager.getCategory();this.markerManager.showCategory(cat);};obj.searchPlaces=function(point,keyword,types,xcallback){var self=this;self._xhrSearch&&self._xhrSearch.abort();var loc=point||obj.map.getCenter();types=types||obj.category.all();var service=new google.maps.places.PlacesService(obj.map||$('#map-canvas')[0]);self._xhrSearch=service.nearbySearch({keyword:keyword,location:loc,radius:25000,types:types,rankby:google.maps.places.RankBy.PROMINENCE,language:"en",pagetoken:60},callback);function callback(results,status){if(status===google.maps.places.PlacesServiceStatus.OK){xcallback&&xcallback(results);}else{xcallback&&xcallback([]);console.log('Search: No result');}}
return self._xhrSearch;};obj.getPlaceFromGoogleData=function(data){var photo_url=data.photos?data.photos[0].getUrl({maxWidth:320}):null,photo={sizes:{xs:{url:photo_url},sm:{url:photo_url},md:{url:photo_url},lg:{url:photo_url},og:{url:photo_url}}},city=fiuzu.app.city,description=data.name+' is located at '+data.vicinity+', '+city.name+', '+city.country.name;var pLat=data.lat||data.geometry.location.lat(),pLng=data.lng||data.geometry.location.lng();var place=new fiuzu.common.models.Place({source:'GOOGLE',category:fiuzu.common.models.Place.category.CATEGORY_GOOGLE,description:description,owner:-1,cluster_id:0,price:0,opening_time:'00:00',closing_time:'00:00',best_start:'00:00',best_end:'00:00',duration_moderate:60,city:city.id,country:city.country.code,name:data.name,address:data.formatted_address||data.vicinity||(city.name+', '+city.country.name),rating:data.rating?Math.round(data.rating*2):3,geo_id:data.geo_id||data.id,lat:Math.round(pLat*100000)/100000,lng:Math.round(pLng*100000)/100000,tags:[],status:2,types:data.types,photo:photo_url?photo:null,url:data.website||data.url,phone:data.formatted_phone_number||data.international_phone_number,});return place;};obj.getLatLngByAddress=function(add,success,error){this.geocoder=this.geocoder||new google.maps.Geocoder();this.geocoder.geocode({'address':add},function(results,status){if(status==google.maps.GeocoderStatus.OK){var add=results[0].address_components;var country=null;var addLength=add.length;if(addLength>0){if(addLength<=5&&add[addLength-1].short_name){country=add[addLength-1].short_name;}else if(addLength>5&&add[5].short_name){country=add[5].short_name;}}
success(results[0].geometry.location,country);}else{error?error():console.log('GeoCoder: Address "'+add+'" not found !');}});};obj.getAddressByLatLng=function(pos,success,error){this.geocoder=this.geocoder||new google.maps.Geocoder();var latlng={lat:pos.lat(),lng:pos.lng()};this.geocoder.geocode({'location':latlng},function(results,status){if(status===google.maps.GeocoderStatus.OK){if(results[1]){var address=results[1].formatted_address;success&&success(address);}else{error&&error('Not found');}}else{error&&error('Geocoder failed due to: '+status);}});};obj.refreshMap=function(day){};obj.fitBoundsForPlaces=function(places){bounds=new google.maps.LatLngBounds();places=places||obj._prevBoundedPlaces||[];obj._prevBoundedPlaces=places;if(places.length){for(var __i=0,len=places.length;__i<len;__i++){var place=places[__i],lat,lng;if(place.attributes){place=place.toJSON();lat=place.lat;lng=place.lng;}else{lat=place.lat?place.lat:place.getPosition().lat();lng=place.lng?place.lng:place.getPosition().lng();}
if(lat&&lng){var newLatLong=new google.maps.LatLng(lat,lng);bounds.extend(newLatLong);}}
this.map&&this.map.fitBounds(bounds);}};obj.hideDirectionDisplay=function(){for(var i=0;i<directionsDisplay.length;i++){directionsDisplay[i].setMap(null);}};obj.getDirectionDisplay=function(model){var routing=model._routing,display=null;if(routing&&routing.display){display=routing.display;display.setMap(obj.map);}else{var rendererOptions={preserveViewport:true,map:obj.map,suppressMarkers:true};var transMode=ROUTE_MODE_NAMES[model.get('route_mode')];if(transMode=="walking"){rendererOptions.polylineOptions={strokeColor:"#1e2ea6"};}else{rendererOptions.polylineOptions={strokeColor:"#1e2ea6"};}
display=new google.maps.DirectionsRenderer(rendererOptions);display.setPanel($('<div/>')[0]);routing=routing||{};routing.display=display;model._routing=routing;}
directionsDisplay.push(display);return display;};obj.getRouting=function(model,plcFrom,plcTo,opts,force){var routing=model._routing,oldMode=routing?routing.mode:null,rModeID=(opts&&opts.mode)?opts.mode:model.get('route_mode')||2;var setRoutingFromResp=function(resp,hasRouting,hasOnMap){var cost=0.0,dis=0.0,dur=0.0;if(resp&&resp.data){cost=resp.data.cost;dur=resp.data.duration?Math.round((12*resp.data.duration/3600))/12:0;dis=resp.data.distance?resp.data.distance/1000:0;}
model.setRouting({route_mode:rModeID,route_cost:cost,route_distance:dis,route_duration:dur},hasRouting,hasOnMap);};var rMode=ROUTING_MODE[rModeID];if(!force&&routing&&plcFrom==routing.from&&plcTo==routing.to&&oldMode==rMode){return;}else{if(!(plcTo&&plcFrom&&plcFrom.lat&&plcFrom.lng&&plcTo.lat&&plcTo.lng)){setRoutingFromResp(null,false,false);return;}
var locOrg=new google.maps.LatLng(plcFrom.lat,plcFrom.lng),locDes=new google.maps.LatLng(plcTo.lat,plcTo.lng);var rWaypoints,display=obj.getDirectionDisplay(model);var request={origin:locOrg,destination:locDes,waypoints:rWaypoints,language:"en",travelMode:rMode,provideRouteAlternatives:false,optimizeWaypoints:true,avoidHighways:false,avoidTolls:false};if(opts&&opts.show&&!config.partner){display.setMap(obj.map);}else{display.setMap(null);}
directionsService.route(request,function(res,status){if(status=='OK'){display.setDirections(res);if(!opts||(opts&&!opts.silent)){var rInfo=res.routes[0].legs[0];var setGGRouting=function(){if(rInfo&&rInfo.distance&&rInfo.duration){var resp={data:{duration:rInfo.duration.value,distance:rInfo.distance.value,cost:0}};setRoutingFromResp(resp,true);}else{model.setRouting({route_mode:rModeID},false);}};if(!plcFrom.is_event&&!plcTo.is_event){var url='/api/route/?origin='+plcFrom.id+'&destination='+plcTo.id+'&mode='+ROUTE_MODE_NAMES[rModeID];xhr&&xhr.abort();var xhr=$.ajax({url:url,success:function(resp){setRoutingFromResp(resp,true);if(rInfo&&rInfo.duration&&resp.data&&Math.abs((rInfo.duration/resp.data.duration)-1)>0.3){var updateUrl=url+'&force=1';$.ajax({url:url});console.log('Updating routing info.');}},error:function(){setGGRouting();console.log('Error when compute cost for routing');}});}else{setGGRouting();}}}else{if(status=='OVER_QUERY_LIMIT'){console.log('Google Place Over limit');var reRun=setTimeout(function(){obj.getRouting(model,plcFrom,plcTo,opts,true);clearTimeout(reRun);},2000);}else if(status=='ZERO_RESULTS'){var url='/api/route/?origin='+plcFrom.id+'&destination='+plcTo.id+'&mode='+ROUTE_MODE_NAMES[rModeID];xhr&&xhr.abort();xhr=$.ajax({url:url,success:function(resp){setRoutingFromResp(resp,true,false);console.log('Use backend API');},error:function(){console.log('You can not '+ROUTE_MODE_ACTIONS[rModeID]+' to the next place.')
model.setRouting({route_mode:rModeID},false,false);}});}else{console.log(status);}}});}};obj.clearMarkers=function(category){this.markerManager.clearMarkers(category);};obj.hideMarkers=function(category){this.markerManager.hideAll();};obj.updateMarkers=function(category){this.markerManager.updateAll();};obj.createPlaceMarker=function(placeModel,markerId,category,force){force=force||false;if(!force){var existedMar=this.markerManager.getMarker(markerId,category);if(existedMar)return existedMar;}
var place=placeModel.toJSON();var myLatLng=new google.maps.LatLng(place.lat,place.lng);var markerURLCity='https://www.justgola.com/static/images/markers/marker-citycenter.png';var markerURLPlace='https://www.justgola.com/static/images/markers/empty.png';var image=defaultImage;var marker=new google.maps.Marker({position:myLatLng,map:obj.map,icon:image,title:place.name,zIndex:1000});var createLabel=function(){var label=new fiuzu.map.views.Label({map:obj.map,overlay:overlay,mapView:obj});image.url=(place.category=="City")?markerURLCity:markerURLPlace;label.set('zIndex',10000);label.bindTo('position',marker,'position');label.set('model',placeModel);label.set('markerId',markerId);return label;};var label=createLabel();marker.label=label;marker.bindMap=obj.map;marker.show=function(){this.setMap(this.bindMap);if(!this.label){this.label=createLabel();}
this.label.show();return this;};marker.destroy=function(){this.setMap(null);if(this.label){this.label.remove();delete this.label;}
obj.markerManager.removeMarker(markerId);delete this;};marker.focus=function(){if(this.map){this.label&&this.label.focus();}};marker.blur=function(){this.label&&this.label.blur();};marker.zoom=function(){this.map.setZoom(15);this.map.setCenter(this.getPosition());};marker.updateAll=function(){this.label&&this.label.updateAll();};marker.hide=function(){this.setMap(null);this.label&&this.label.hide();return this;};marker.addClass=function(className){marker.classes=marker.classes||{};var classes=className.split(' ');for(var i=0;i<classes.length;i++){marker.classes[classes[i]]=1;}};marker.removeClass=function(className){marker.classes=marker.classes||{};var classes=className.split(' ');for(var i=0;i<classes.length;i++){marker.classes[classes[i]]=0;}};marker.setInLink=function(url){this.label&&this.label.setInLink(url);}
placeModel.marker=marker;category=category||'all';this.markerManager.addMarker(marker,markerId,category);return marker;};obj.disableMovement=function(disable){var mapOptions;if(disable){mapOptions={draggable:false,scrollwheel:false};}else{mapOptions={draggable:true,scrollwheel:true};}
obj.map.setOptions(mapOptions);};return obj;};return MapCls;})();