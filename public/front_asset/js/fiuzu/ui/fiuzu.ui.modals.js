window.fiuzu.ui.modals=window.fiuzu.ui.modals||{};window.fiuzu.ui.Modal=(function(){"use strict";function modalCls(pEl$){var el$=pEl$;var modal={};modal.options={};modal.DEFAULT_TEMPLATE_ID='#fiuzu-dialog';modal.el$=el$;modal.init=function(){if(!el$||!(el$[0])){var uniqueID='modal-'+(new Date()).getTime();var newEl$=$(modal.DEFAULT_TEMPLATE_ID).clone().attr('id',uniqueID).appendTo('body');modal.el$=newEl$
el$=newEl$;}
el$.on('shown.bs.modal',function(e){$('.modal-footer',el$).find('.btn').focus();});};modal.set=function(key,val){modal[key]=val;};modal.get=function(key){return modal[key];};modal.setElement=function(elx$){el$=elx$;this.el$=el$;};modal.getElement=function(){return this.el$;};modal.getOptions=function(){return modal.options;};modal.setOption=function(opts){modal.options=opts;};modal.show=function(noCache){if(modal.size&&modal.size!=''){el$.addClass(modal.size);}
if(noCache){el$.data('bs.modal',null);}
el$.find('.modal-title').html(modal.title||'Title');el$.find('.dialog-content').html(modal.body||'');el$.modal(modal.options);if(modal.options.remote){el$.find('.modal-content').addClass('transparent');}
if(modal.afterClose){el$.on('hidden.bs.modal',function(e){modal.afterClose();});}};modal.close=function(){el$.modal('hide');};modal.afterClose=null;modal.init();return modal;}
return modalCls;}());fiuzu.ui.Modal.sizes={MODAL_SIZE_LARGE:'modal-lg'};window.FModalEmailFriend=(function(ParentCls){"use strict";function modalCls(pEl$,options){var obj=new ParentCls(pEl$);var emails=[];var input$;var list$;var header$;var btnAdd$;var btnSend$;var notice$;var guestbox$,guest$,sender$;obj.title="Send email";obj.planID=null;obj.city=null;obj.init=function(){guestbox$=$(".box-guest",obj.el$);guest$=$("#guest",obj.el$);sender$=$("#sender",obj.el$);header$=$("#message",obj.el$);notice$=$(".notice-msg",obj.el$).hide();list$=$("#list-emails",obj.el$);input$=$("#email",obj.el$);btnAdd$=$("#btn-add-itinerary",obj.el$);btnSend$=$("#btn-share-itinerary",obj.el$);input$.keypress(function(event){if(event.which==13){obj.addEmail();}}).blur(function(e){obj.checkEmail($(this).val());});btnSend$.click(function(){obj.sendEmail();});btnAdd$.click(function(){obj.addEmail();});if(!options||!options.user){guestbox$.removeClass("hidden");}
if(!fiuzu.session.isMobile){input$.focus();}};obj.addEmail=function(){var e=input$.val();if(obj.checkEmail(e)){if(emails.indexOf(e)<0){emails.push(e);}
obj.generateList();input$.val("").focus();}};obj.removeEmail=function(e){var index=emails.indexOf(e);if(index>=0){emails.splice(index,1);}
obj.generateList();};obj.generateList=function(){var i,len,html;list$.html("");for(i=0,len=emails.length;i<len;i++){html='<li class="fleft fui-row-full row"><span class="fleft col-md-8 col-sm-8 col-xs-8"><i class="icomoon-icon-mail-3 fleft"></i>'+emails[i]+'</span><i data-application="'+emails[i]+'" class="btn btn-xs btn-link btn-remove icomoon-icon-cancel fleft"></i></li>';list$.append($(html));}
$(".btn-remove",obj.el$).click(function(){var email=$(this).attr("data-application");obj.removeEmail(email);});};obj.sendEmail=function(){var email=input$.val();if(email){obj.addEmail();}
var emailList=emails.join(",");var sender=sender$.val();var guest=guest$.val();var validUser=true;if(!options||!options.user){if(guest==""){guest$.focus();validUser=false;}
if(!obj.checkEmail(sender)){sender$.focus();validUser=false;}
if(!validUser){notice$.removeClass("hidden").show().find("span").html(gettext("You must provide your name and email address or <a href='/login'>Login</a> to share via email."));return false;}}
if(emails.length>0){var partner=(window.config&&config.partner)?config.partner:'';var emailURL="/api/plan/"+obj.planID+"/email?partner="+partner;var data={city:obj.city.id,emails:emailList,sender:sender,guest:guest,partner:partner}
$.ajax({url:emailURL,data:data,type:'POST'});header$.html(gettext("Your plan has been shared!"));obj.close();alert(gettext("Your plan has been shared with your friends!"));}else{input$.focus();}};obj.checkEmail=function(email){var filter=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(!filter.test(email)){if(email.length>0){notice$.removeClass("hidden").show().find("span").html(gettext("You have entered an invalid email address."));input$.focus();}
return false;}
notice$.addClass("hidden").hide();return true;};obj.super_show=obj.show;obj.show=function(){obj.super_show();if(fiuzu.session.isMobile){input$.focus();}};obj.init();return obj;}
return modalCls;}(window.fiuzu.ui.Modal));window.FModalPlanForm=(function(ParentCls){"use strict";function cls(pEl$,plan){var obj=new ParentCls(pEl$);obj.plan=plan;var elName$,elDesc$,elTags$,elShareSetting$,elMessage$,elIntensity$,elUpload$,elPhoto$,elTags$,btnUpdatePhoto$,btnSave$,frmData$,frmUpload$,elObjectId$;var isSaved=false,isUploading=false,isUploaded=false,urlUpload='/photo/ajax/upload',urlCover=(!plan.isNew())?'/api/plan/'+plan.get('id')+'/cover':'',urlForm='/api/plan/form';obj._tempPhoto=null;obj.warn=function(msg){elMessage$.removeClass("fui-green").addClass("fui-red").html("<i class='icomoon-icon-warning'></i>"+msg).show();};obj.inform=function(msg){elMessage$.removeClass("fui-red").addClass("fui-green").html("<i class='icomoon-icon-checkmark'></i>"+msg).show();};obj.saveSetting=function(){plan.save({},{success:function(model,resp){obj.inform('Save successfully');fiuzu.app.navigate('#');obj.close();},error:function(){obj.warn('Sorry ! Can not save the plan now !');}});};obj.reset=function(){elUpload$.fileupload('destroy');obj.init();};obj.updatePlanField=function(el$){plan.set(el$.prop('name'),el$.val());};obj.setupPlan=function(plan){elObjectId$=$("[name=object_id]",obj.el$);elName$=$("[name=name]",obj.el$),elDesc$=$("[name=description]",obj.el$),elShareSetting$=$("[name=sharing_setting]",obj.el$),elIntensity$=$("[name=intensity]",obj.el$),elMessage$=$(".plan-message",obj.el$),elUpload$=$('.plan-cover-input',obj.el$),elPhoto$=$('.plan-cover-photo',obj.el$),elTags$=$(".filter-tags",obj.el$),btnUpdatePhoto$=$('.btn-update-cover-photo',obj.el$),btnSave$=$(".btn-save-setting",obj.el$),frmData$=$(".frm-setting",obj.el$),frmUpload$=$(".frm-upload",obj.el$);obj.plan=obj.plan||plan;elObjectId$.val(obj.plan.get('id'));elName$.val(obj.plan.get('name')).change(function(){obj.updatePlanField($(this));});elDesc$.val(obj.plan.get('description')).change(function(){obj.updatePlanField($(this));});elShareSetting$.val(obj.plan.get('sharing_setting')).change(function(){obj.updatePlanField($(this));});elIntensity$.val(obj.plan.get('intensity')).change(function(){obj.updatePlanField($(this));});if(obj.plan.get('photo')){var photo=obj.plan.get('photo');if(photo.sizes){elPhoto$.attr('src',photo.sizes.md.url);}}
var tags=[];elTags$=$("[name=tags]",obj.el$),elTags$.select2({placeHolder:"Select list of interests",allowClear:true});if(obj.plan.get('tags')){tags=obj.plan.get('tags');for(var i=0;i<tags.length;i++){tags[i].text=tags[i].name;}
elTags$.select2('data',tags);}
elTags$.change(function(){var data=elTags$.select2('data'),tags=[];if(data){for(var i=0;i<data.length;i++){tags.push({id:data[i].id,name:data[i].text});}}
obj.plan.set('tags',tags);});};obj.init=function(){obj.size=fiuzu.ui.Modal.sizes.MODAL_SIZE_LARGE;obj.title='Plan Setting';obj.options.remote='/api/plan/form';$(obj.el$).on('shown.bs.modal',function(e){obj.setupPlan(obj.plan);elName$.focus();btnSave$.click(function(){obj.saveSetting();});elMessage$.hide();btnUpdatePhoto$.click(function(){if(!isUploading){elUpload$.trigger('click');}else{obj.inform("A photo has been uploading. Please wait a moment !");}});if(!fiuzu.session.isMobile){elUpload$.fileupload({url:urlUpload,dataType:'json',formData:function(){return frmUpload$.serializeArray();},done:function(e,data){var r=data.result;if(r.status==200){var thumb=(r.photo.sizes.lg.url);elPhoto$.attr("src",thumb+"?_="+new Date().getTime());isUploaded=true;obj.inform('Image uploading successfully !');$.ajax({url:urlCover,type:'POST',dataType:"json",data:{photo_id:r.photo.id},success:function(data){if(data.status==200){obj.plan&&obj.plan.set('photo',r.photo);obj.inform(data.detail);}else{obj.warn(data.detail);}}});}else{obj.warn(r.msg);isUploaded=false;}
isUploading=false;btnUpdatePhoto$.html("<i class=\"icomoon-icon-picture\"></i>Update cover photo");obj.reset();},progressall:function(e,data){isUploading=true;var progress=parseInt(data.loaded/data.total*100,10);if(progress<100){btnUpdatePhoto$.html("<i class=\"icomoon-icon-loading-5\"></i>Uploading ... "+progress+'%');}else{btnUpdatePhoto$.html("<i class=\"icomoon-icon-loading-5\"></i>Completing ...");}}}).prop('disabled',!$.support.fileInput).parent().addClass($.support.fileInput?undefined:'disabled');}}).on('hidden.bs.modal',function(){fiuzu.app.navigate("#plan");});};obj.init();return obj;}
return cls;}(window.fiuzu.ui.Modal));fiuzu.ui.modals.FModalAuthentication=(function(ParentCls){function cls(pEl$){var self=new ParentCls(pEl$);self.init=function(){};self.showLogin=function(callback){if(callback){self.el$.on('loaded.bs.modal',function(e){$('input[name=next]',self.el$).val(''+callback);});}
self.options.remote='/api/account/login/html';self.show(true);};self.showRegister=function(callback){if(callback){self.el$.on('loaded.bs.modal',function(e){$('input[name=next]',self.el$).val(''+callback);});}
self.options.remote='/api/account/register/html';self.show(true);};self.init();return self;}
return cls;}(window.fiuzu.ui.Modal));window.fiuzu.ui.Modal.lazyLoading=function(){var urls=['/api/account/login/html','/api/plan/form'];for(var i=0;i<urls.length;i++){$.get(urls[i]);}}