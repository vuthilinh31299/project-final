"use strict";window.fiuzu.wishlist=window.fiuzu.wishlist||{};fiuzu.wishlist.Wishlist=function(options){"use strict";window.myApp=window.myApp||{isEditable:false};var MIN_REQUIRED_ITEMS=3;var VIEW_SETTING={nomap:{boxItemClasses:"col-xs-12",boxMapClasses:"hidden",itemClasses:"col-md-4 col-sm-6 col-xs-12"},withmap:{boxItemClasses:"col-md-4 col-sm-6 col-xs-12",boxMapClasses:"col-md-8 col-sm-6 hidden-xs",itemClasses:"col-xs-12"}};var citySelectBox$=$("#wishlist-city-select");var htmlWishlist,tmplWishlist;var wishlistPage={};var manager=new fiuzu.manager.WishlistManager(options);var numAddedItem=0;$(function(){htmlWishlist=$("#wishlist-item-tmpl").html();tmplWishlist=_.template(htmlWishlist,null,{variable:"data"});wishlistPage.renderSearchBox();if(options.showSuggestion){wishlistPage.renderSuggestions();}});citySelectBox$.change(function(){var city_slug=$(this).val();if(city_slug!=""){$(".wishlist-city").hide();$("#wishlist-city-"+city_slug).show();}else{$(".wishlist-city").show();}});wishlistPage.updateNumAdded=function(){var btnCont$=$(".btn-continue");var num=numAddedItem;console.log(num);if(num>=MIN_REQUIRED_ITEMS){btnCont$.removeClass("disabled").click(function(){$("body").scrollTop(0);window.location.reload();}).text("Open your wishlist !");}else{var remained=MIN_REQUIRED_ITEMS-num;btnCont$.text("Select "+remained+" item"+(remained>1?"s":"")+" to open your wishlist !").addClass("disabled").unbind("click");}
return this;};wishlistPage.renderSearchBox=function(){var searchBox$=$(".wishlist-search-box");searchBox$.keyup(function(e){searchBox$.FiuzuAutocomplete({all:true,keyword:searchBox$.val(),select:{selected:function(event,data){var model=data;model.visited=0;manager.call({action:"add",model:model,success:function(res){alert("'"+res.item.name+"' has been added to your wishlist");if(options.showSuggestion){numAddedItem++;wishlistPage.updateNumAdded();}else{window.location.reload();}}});},}});})};wishlistPage.renderSuggestions=function(suggestions){var section$=$(".wishlist-suggestion-box");var suggestions$=section$.find(".wishlist-suggestion");suggestions$.each(function(){var el$=$(this);var photo$=el$.find(".image");var model=options.suggestions[el$.attr("data-index")]||{};var btnAdd$=el$.find(".btn-item-wishlist");model.isInWishlist=el$.hasClass("check");photo$.click(function(){var attCat=model.category;var attID=model.id;var attName=model.name;var cat=(model.category==1)?"restaurant":"attraction";var href="/att/"+cat+"-"+attID;var modal$=$("#modal-attraction-single");var title$=$(".attraction-name",modal$);var body$=$(".modal-body",modal$);$.ajax({url:href,success:function(data){body$.html(data);}});title$.text(attName);modal$.modal();});btnAdd$.FiuzuWishlistButton({change:function(state){if(state){numAddedItem++;}else{numAddedItem--;}
wishlistPage.updateNumAdded();}});});this.updateNumAdded();return this;};$(".panel-wishlist").each(function(){var wishlist=$(this);var listCategories$=wishlist.find(".list-category li");var btnNewPlan$=wishlist.find(".btn-new-plan");var btnNewItem$=wishlist.find(".btn-new-item");var btnViewMap$=wishlist.find(".btn-view-map");var inptSearch$=wishlist.find(".inpt-search");var boxNewItem$=wishlist.find(".new-item");var boxWishlistItem$=wishlist.find(".list-wishlist-items");var boxMap$=wishlist.find(".box-wishlist-map");var mapCanvas$=boxMap$.find(".map");var listItems$=boxWishlistItem$.find(".wishlist-item:not(.new-item)");wishlist.index=parseInt($(this).attr("data-index"));wishlist.city=options.wishlist[wishlist.index];wishlist.map=null;wishlist.list=options.wishlist[wishlist.index].wishlist;wishlist.currentMode="nomap";wishlist.currentSearchTerm="";wishlist.currentCat="All";wishlist.isShowNewItem=false;wishlist.isInitNewItem=false;wishlist.hasAuth=options.isAuth;wishlist.numVisible=wishlist.list.length;wishlist.filterItem=function(){var word=wishlist.currentSearchTerm;var cat=wishlist.currentCat;var catName=wishlist.currentCatName;var l=wishlist.list.length;var i=0;var count=0;var noresultAlert$=boxWishlistItem$.find(".no-result");for(i=0;i<l;i++){var att=wishlist.list[i];var name=att.name.toLowerCase();if(name.indexOf(word)>=0&&(cat=="All"||att.category==catName)){att.el$.show();att.visible=true;count++;$(".item-number",att.el$).text(count);if(att.marker){att.marker.show();att.marker.label.setNumber(count);}}else{att.el$.hide();if(att.marker){att.marker.hide();}
att.visible=false;}}
if(count){noresultAlert$.addClass("hidden");}else{noresultAlert$.removeClass("hidden").find(".keyword").text(word);noresultAlert$.find(".category").text(cat=="All"?"":wishlist.currentCatName.toLowerCase());}
wishlist.numVisible=count;};wishlist.switchMode=function(mode){var viewCurrent;var viewSwitch;if(mode==wishlist.currentMode)return 0;if(!mode){viewCurrent=wishlist.hasClass("withmap")?"withmap":"nomap";viewSwitch=(viewCurrent=="nomap")?"withmap":"nomap";}else{viewSwitch=mode;viewCurrent=(viewCurrent=="nomap")?"withmap":"nomap";}
var settingCurrent=VIEW_SETTING[viewCurrent];var settingSwitch=VIEW_SETTING[viewSwitch];wishlist.removeClass(viewCurrent).addClass(viewSwitch);boxWishlistItem$.removeClass(settingCurrent.boxItemClasses).addClass(settingSwitch.boxItemClasses);boxMap$.removeClass(settingCurrent.boxMapClasses).addClass(settingSwitch.boxMapClasses);listItems$.removeClass(settingCurrent.itemClasses).addClass(settingSwitch.itemClasses);boxNewItem$.removeClass(settingCurrent.itemClasses).addClass(settingSwitch.itemClasses);boxWishlistItem$.scrollTop(0);wishlist.currentMode=viewSwitch;if(viewSwitch=="withmap"){var i,l,marker;if(!wishlist.map){wishlist.map=new fiuzu.map.Map({canvas:mapCanvas$,city:wishlist.city,scrollwheel:false});wishlist.map.init();for(i=0,l=wishlist.list.length;i<l;i++){wishlist.list[i].inPlan=false;wishlist.list[i].isDraggable=false;var rawItem=$.extend(true,{},wishlist.list[i]);if(rawItem['el$']){delete rawItem['el$'];}
var model=new fiuzu.common.models.Place(rawItem);marker=wishlist.map.createPlaceMarker(model,'mkr_'+i+1,"",true);wishlist.list[i].marker=marker;}}
for(i=0;i<l;i++){if(!wishlist.list[i].visible){marker.hide();}}
btnViewMap$.addClass("active");}else{btnViewMap$.removeClass("active");}
return wishlist;};wishlist.showMap=function(){wishlist.switchMode();if(wishlist.map){wishlist.map.fitBoundsForPlaces(wishlist.list);google.maps.event.trigger(wishlist.map,"resize");}};wishlist.showNewItem=function(){if(wishlist.isShowNewItem){boxNewItem$.addClass("hidden");btnNewItem$.removeClass("active");}else{boxNewItem$.removeClass("hidden").find(".name").focus().val("");boxNewItem$.find(".item-img img").attr("src",fiuzu.NO_IMAGE_PLACE);btnNewItem$.addClass("active");}
wishlist.isShowNewItem=!wishlist.isShowNewItem;return wishlist;};boxNewItem$.each(function(){var btnClose$=$(this).find(".close");var inputName$=$(this).find(".name");var imgPhoto$=$(this).find(".item-img img");var btnVisited$=$(this).find(".btn-visited");var btnAdd$=$(this).find(".btn-add");var currentItem={isVisited:false,selected:null};if(!wishlist.isInitNewItem){inputName$.FiuzuAutocomplete({all:true,keyword:inputName$.val(),select:{selected:function(e,data){currentItem.selected=data;inputName$.val(data.name);imgPhoto$.attr("src",data.photo?data.photo.sizes.md.url:fiuzu.constants.PHOTO_DEFAULT);btnAdd$.focus();e.preventDefault();return false;}}})}
btnAdd$.click(function(){var newItem=currentItem.selected;if(newItem){newItem.visited=btnVisited$.isChecked();manager.call({action:"add",model:newItem,success:function(res){res.item.index=wishlist.list.length;res.item.visible_authen=wishlist.hasAuth;res.item.has_permission=wishlist.hasAuth;var newEl=$(tmplWishlist(res.item));boxWishlistItem$.append(newEl);newEl.addClass(VIEW_SETTING[wishlist.currentMode].itemClasses)
boxWishlistItem$.scrollTop(newEl.position().top,800);newEl.find(".item-body").css({backgroundColor:'#f6b400'}).animate({backgroundColor:'white'},800);listItems$=boxWishlistItem$.find(".wishlist-item:not(.new-item)");wishlist.list.push(res.item);wishlist.initItemHandler(newEl).showNewItem(true);wishlist.find(".badge").text(wishlist.list.length);if(wishlist.map){var item=wishlist.list[wishlist.list.length-1]
var rawItem=$.extend(true,{},item);if(rawItem['el$']){delete rawItem['el$'];}
var model=new fiuzu.common.models.Place(rawItem);var marker=wishlist.map.createPlaceMarker(model,'mrk_'+res.item.index+1,"",true);item.marker=marker;wishlist.map.fitBoundsForPlaces(wishlist.list);google.maps.event.trigger(wishlist.map,"resize");}}});}});btnVisited$.fiuzuCheckBox({value:false,change:function(checked){$(this).isVisited=checked;}});btnClose$.click(function(){wishlist.showNewItem(false);});});inptSearch$.keyup(function(){wishlist.currentSearchTerm=$(this).val().toLowerCase();wishlist.filterItem();});listCategories$.each(function(){var cat=$(this).attr("data-category");var catName=$(this).attr("data-name");if(cat){if(cat!="All"){var num=boxWishlistItem$.find("."+cat).length;$(this).find(".badge").text(num);if(!num){$(this).addClass("hidden");}}
$(this).click(function(){wishlist.currentCat=cat;wishlist.currentCatName=catName;listCategories$.removeClass("active");$(this).addClass("active");wishlist.filterItem();});}});wishlist.initItemHandler=function(items){items.each(function(){var item=$(this);var btnVisited$=item.find(".btn-visited");var btnRemove$=item.find(".item-remove");var btnSave$=item.find(".item-save");var btnViewOnMap$=item.find(".item-view-map");item.index=item.attr("data-index");wishlist.list[item.index].el$=item;item.model=wishlist.list[item.index];item.model.isSaved=false;wishlist.list[item.index].visible=true;$(this).mouseover(function(){if(item.model&&item.model.marker&&wishlist.currentMode=="withmap"){item.model.marker.focus();}});btnSave$.click(function(){item.model.id=item.model.id;if(!item.model.isSaved){manager.call({action:"add",model:{id:item.model.id,},success:function(res){btnSave$.html('<i class="icomoon-icon-remove"></i>Remove');item.model.isSaved=true;}});}else{manager.call({action:"remove",model:{id:item.model.id,},success:function(res){btnSave$.html('<i class="icomoon-icon-plus-2"></i>Add to wishlist');item.model.isSaved=false;}});}});btnVisited$.fiuzuCheckBox({value:wishlist.list[item.index].visited,change:function(checked){var old_value=!checked;var model={visited:checked,id:item.model.id}
manager.call({action:"visit",model:model,fail:function(res){btnVisited$.setValue(old_value);}});}});btnRemove$.click(function(){var confirmed=confirm("Are you sure to remove this item.");if(confirmed){manager.call({action:"remove",model:{id:item.model.id},success:function(res){this.marker=item.model.marker;if(this.marker){this.marker.label.remove();this.marker.setMap(null)}
wishlist.list.splice(item.model.index,1);var i,l,it;for(i=0,l=wishlist.list.length;i<l;i++){it=wishlist.list[i];it.index=i;$(".item-number",it.el$).text(i+1);}
wishlist.find(".badge").text(wishlist.list.length);item.remove();if(wishlist.list.length==0){wishlist.showNewItem();}}});}});btnViewOnMap$.click(function(){wishlist.showMap();});});return wishlist;};btnNewPlan$.click(function(){var form=$("#form-newplan");var mustgo=[];var i,l=wishlist.list.length;for(i=0;i<l;i++){mustgo.push(wishlist.list[i].id);}
var data={"trip_city_name":wishlist.city.name,"trip_city_id":wishlist.city.id,"trip_duration":wishlist.city.duration,"trip_max_budget":wishlist.city.budget_per_day,"trip_tags":[],'trip_mustgo':mustgo.join(','),'trip_autofill':0,};var i,l;var keys=_.keys(data);for(i=0,l=keys.length;i<l;i++){form.find("."+keys[i]).val(data[keys[i]]);}
form.submit();});btnViewMap$.click(function(){wishlist.showMap();});btnNewItem$.click(function(){wishlist.showNewItem();});wishlist.initItemHandler(listItems$);});};